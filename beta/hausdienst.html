<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausdienst</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    .badge { padding: 2px 6px; border-radius: 4px; }
    .ok { background: #cfc; }
    .none { background: #fcc; }
    .sub { color: #666; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>Hausdienst</h1>
  <div id="connTxt">Verbinde...</div>

  <h2>Heute</h2>
  <div id="todayInfo">Lade…</div>

  <h2>Nächste 14 Tage</h2>
  <div id="nextList">Lade…</div>

  <h2>Checkliste</h2>
  <div id="checklist">Lade…</div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

  <script>
    // === Firebase Config ===
    const firebaseConfig = {
      apiKey: "DEIN_KEY",
      authDomain: "DEIN_PROJEKT.firebaseapp.com",
      projectId: "DEIN_PROJEKT",
      storageBucket: "DEIN_PROJEKT.appspot.com",
      messagingSenderId: "DEIN_SENDER_ID",
      appId: "DEINE_APP_ID"
    };

    let db = null;

    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      document.getElementById('connTxt').textContent = 'Online (Firestore verbunden)';
      init();
    } catch (e) {
      console.error(e);
      document.getElementById('connTxt').textContent = 'Offline – Firebase konnte nicht initialisiert werden.';
    }

    function todayStr() {
      const dt = new Date();
      return dt.toISOString().slice(0, 10);
    }

    // === Heute anzeigen (live) ===
    function listenTodayInfo() {
      const el = document.getElementById('todayInfo');
      db.collection("hausdienst").doc(todayStr())
        .onSnapshot(doc => {
          if (doc.exists) {
            const person = doc.data().person;
            el.innerHTML = `Heute eingetragener Hausdienst: <span class="badge ok">${person}</span>`;
          } else {
            el.innerHTML = `Heute: <span class="badge none">Noch niemand eingetragen</span>`;
          }
        }, err => {
          console.error(err);
          el.innerHTML = `<span class="sub">Fehler beim Laden (${err?.code || 'unbekannt'})</span>`;
        });
    }

    // === Nächste 14 Tage anzeigen (live) ===
    async function renderNextDays() {
      const el = document.getElementById('nextList');
      try {
        const out = [];
        for (let i = 0; i < 14; i++) {
          const dt = new Date(); dt.setDate(dt.getDate() + i);
          const id = dt.toISOString().slice(0, 10);
          const doc = await db.collection("hausdienst").doc(id).get();
          out.push([id, doc.exists ? (doc.data().person || null) : null, i === 0]);
        }
        el.innerHTML = "<ul>" + out.map(([id, person, isToday]) =>
          `<li>${isToday ? "<b>" + id + " (heute)</b>" : id}: ${person || "frei"}</li>`
        ).join("") + "</ul>";
      } catch (err) {
        console.error(err);
        el.innerHTML = `<div class="sub">Fehler beim Laden (${err?.code || 'unbekannt'})</div>`;
      }
    }

    function listenNextDays() {
      // Wir hören auf Änderungen an allen hausdienst-Dokumenten der nächsten 14 Tage
      const ids = [];
      for (let i = 0; i < 14; i++) {
        const dt = new Date(); dt.setDate(dt.getDate() + i);
        ids.push(dt.toISOString().slice(0, 10));
      }
      ids.forEach(id => {
        db.collection("hausdienst").doc(id).onSnapshot(() => {
          renderNextDays(); // neu rendern, wenn sich etwas ändert
        });
      });
    }

    // === Checkliste (live) ===
    function listenChecklist() {
      const el = document.getElementById('checklist');
      db.collection("checklistTasks").onSnapshot(snapshot => {
        if (snapshot.empty) {
          el.textContent = "Keine Aufgaben.";
          return;
        }
        const items = snapshot.docs.map(doc => {
          const d = doc.data();
          return `<li>[${d.cat}] ${d.text} ${d.done ? "✔️" : ""}</li>`;
        });
        el.innerHTML = "<ul>" + items.join("") + "</ul>";
      }, err => {
        console.error(err);
        el.innerHTML = `<div class="sub">Fehler beim Laden (${err?.code || 'unbekannt'})</div>`;
      });
    }

    function init() {
      listenTodayInfo();
      renderNextDays();
      listenNextDays();
      listenChecklist();
    }
  </script>
</body>
</html>
