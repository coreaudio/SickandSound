<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausdienst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <style>
    .people-wrap{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
    .pill{padding:8px 12px;border-radius:999px;background:#0f1420;border:1px solid #222a3f;font-weight:700}
    .pill.active{background:linear-gradient(135deg,#6ee7ff,#a78bfa);color:#0b0e14;border:0}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px}
    .slot{border:1px solid #222a3f;border-radius:12px;padding:10px;background:#0b0e14}
    .slot h4{margin:0 0 6px 0}
    .slot .who{min-height:24px}
    .slot .who .name{font-weight:800}
    .slot .actions{display:flex;gap:8px;margin-top:6px}
    .hint{opacity:.85;margin-top:8px}
    .row{display:flex;justify-content:space-between;align-items:center;margin:6px 0}
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title"><div class="brand-dot"></div><h1>Hausdienst</h1></div>
    <div class="appbar-actions">
      <a class="btn small" href="hausdienst_checklist.html">Checkliste</a>
    </div>
  </header>

  <main class="content">
    <div class="card">
      <div class="section-title">Person auswählen</div>
      <div id="people" class="people-wrap"></div>
    </div>

    <div class="card">
      <div class="section-title">Heute &amp; Morgen</div>
      <div class="grid">
        <div class="slot">
          <h4>Heute (<span id="d_today"></span>)</h4>
          <div class="who" id="todayWho">–</div>
          <div class="actions">
            <button class="btn" onclick="assign('today')">Eintragen</button>
            <button class="btn danger" onclick="clearDate('today')">Austragen</button>
          </div>
        </div>
        <div class="slot">
          <h4>Morgen (<span id="d_tomorrow"></span>)</h4>
          <div class="who" id="tomorrowWho">–</div>
          <div class="actions">
            <button class="btn" onclick="assign('tomorrow')">Eintragen</button>
            <button class="btn danger" onclick="clearDate('tomorrow')">Austragen</button>
          </div>
        </div>
      </div>
      <div class="hint">Pro Datum ist maximal <b>eine</b> Person eingetragen. Eintragungen sind immer <b>tagesscharf</b>.</div>
    </div>

    <div class="card">
      <div class="section-title">Planen (nächste 14 Tage)</div>
      <div id="planGrid" class="grid"></div>
    </div>

    <div class="card">
      <div class="section-title">Historie (letzte 30 Einträge)</div>
      <div id="history"></div>
    </div>
  </main>

  <nav class="bottomnav">
    <a class="tab" href="index.html"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg><span>Liste</span></a>
    <a class="tab active" href="hausdienst.html"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg><span>Hausdienst</span></a>
    <a class="tab" href="rangliste.html"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg><span>Rang</span></a>
    <a class="tab" href="badges.html"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg><span>Badges</span></a>
    <a class="tab" href="buchungen.html"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg><span>Buchungen</span></a>
  </nav>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
const CORE=["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
const firebaseConfig={apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",authDomain:"sickandsound-e9704.firebaseapp.com",projectId:"sickandsound-e9704",storageBucket:"sickandsound-e9704.firebasestorage.app",messagingSenderId:"248197359659",appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",measurementId:"G-62LH8V7S2E"};
let db=null; try{firebase.initializeApp(firebaseConfig); try{firebase.analytics();}catch(_){ } db=firebase.firestore();}catch(_){db=null;}
const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";
const HD_XP=5; // Bonus-XP pro Hausdienst-Tag
const LVL_K=75; // (nur falls wir Level irgendwo zeigen wollen)

let selected=null;
const fmt=(d)=>d.toISOString().slice(0,10);
const todayStr=()=>fmt(new Date());
const addDays=(d,n)=>{const t=new Date(d); t.setDate(t.getDate()+n); return t;};

function renderPeople(ppl){
  const wrap=document.getElementById('people');
  wrap.innerHTML = ppl.map(n=>`<button class="pill ${selected===n?'active':''}" onclick="select('${n}')">${n}</button>`).join('');
}
function select(n){ selected=n; renderPeople(CORE); }

async function loadPeople(){
  // aus state.people nur für Vollständigkeit – Hausdienst nutzt ausschließlich Kernteam
  renderPeople(CORE);
}

function setDateLabels(){
  document.getElementById('d_today').textContent=todayStr();
  document.getElementById('d_tomorrow').textContent=fmt(addDays(new Date(),1));
}

async function assign(when){
  if(!selected) return alert("Bitte zuerst Person auswählen.");
  const dt=new Date(); if(when==='tomorrow') dt.setDate(dt.getDate()+1);
  await setForDate(fmt(dt), selected);
}
async function clearDate(when){
  const dt=new Date(); if(when==='tomorrow') dt.setDate(dt.getDate()+1);
  await clearSpecific(fmt(dt));
}

async function setForDate(date, person){
  if(!db) return alert("Offline – kann nicht speichern.");
  await db.runTransaction(async (tx)=>{
    const dRef=db.collection("hausdienst").doc(date);
    const sRef=db.collection(STATE_COLLECTION).doc("global");
    const dSnap=await tx.get(dRef);
    if(dSnap.exists && dSnap.data().person) throw new Error(`Datum ist bereits belegt (${dSnap.data().person}).`);
    tx.set(dRef,{person,updatedAt:Date.now(),xpApplied:true},{merge:true});
    const sSnap=await tx.get(sRef); const st=sSnap.exists?sSnap.data():{}; const xp=st.xp||{};
    xp[person]=(xp[person]||0)+HD_XP;
    tx.set(sRef,{xp},{merge:true});
  }).catch(e=>alert(e.message||e));
  await refresh();
}

async function clearSpecific(date){
  if(!db) return alert("Offline – kann nicht löschen.");
  await db.runTransaction(async (tx)=>{
    const dRef=db.collection("hausdienst").doc(date);
    const sRef=db.collection(STATE_COLLECTION).doc("global");
    const dSnap=await tx.get(dRef); if(!dSnap.exists){ tx.delete(dRef); return; }
    const {person,xpApplied}=dSnap.data()||{};
    tx.delete(dRef);
    if(xpApplied && person){
      const sSnap=await tx.get(sRef); const st=sSnap.exists?sSnap.data():{}; const xp=st.xp||{};
      xp[person]=Math.max(0,(xp[person]||0)-HD_XP);
      tx.set(sRef,{xp},{merge:true});
    }
  });
  await refresh();
}

async function renderTodayTomorrow(){
  const t=todayStr(), tm=fmt(addDays(new Date(),1));
  const get=async(id)=>{const d=await db.collection("hausdienst").doc(id).get(); return d.exists? d.data().person:null};
  const a=await get(t), b=await get(tm);
  document.getElementById('todayWho').innerHTML = a? `<span class="badge ok name">${a}</span>` : `<span class="badge none">frei</span>`;
  document.getElementById('tomorrowWho').innerHTML = b? `<span class="badge ok name">${b}</span>` : `<span class="badge none">frei</span>`;
}

async function renderPlan(){
  const base=new Date();
  const wrap=document.getElementById('planGrid'); let html='';
  for(let i=2;i<=15;i++){ // ab übermorgen
    const d=addDays(base,i); const id=fmt(d);
    const snap=await db.collection("hausdienst").doc(id).get();
    const who=snap.exists ? snap.data().person : null;
    html+=`<div class="slot">
      <h4>${id}</h4>
      <div class="who">${who?`<span class="name">${who}</span>`:'frei'}</div>
      <div class="actions">
        <button class="btn" onclick="setForDate('${id}', selected||'')">Eintragen</button>
        ${who?`<button class="btn danger" onclick="clearSpecific('${id}')">Austragen</button>`:''}
      </div>
    </div>`;
  }
  wrap.innerHTML=html;
}

async function renderHistory(){
  const q=await db.collection("hausdienst").orderBy(firebase.firestore.FieldPath.documentId(),"desc").limit(30).get();
  const wrap=document.getElementById('history');
  let html='';
  q.forEach(doc=>{
    const d=doc.id, p=doc.data().person||'-';
    html+=`<div class="row"><div>${d}</div><div style="font-weight:800">${p}</div></div>`;
  });
  wrap.innerHTML=html || '<div class="sub">Keine Einträge</div>';
}

async function refresh(){
  await Promise.all([renderTodayTomorrow(), renderPlan(), renderHistory()]);
}

async function init(){
  setDateLabels(); await loadPeople(); await refresh();
  if(db){
    db.collection("hausdienst").onSnapshot(()=>refresh());
  }
}
if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
init();
</script>
</body>
</html>
