<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausdienst planen</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title"><div class="brand-dot"></div><h1>Hausdienst</h1></div>
    <div class="appbar-actions">
      <a class="btn small dark" href="hausdienst_checklist.html">ðŸ“‹</a>
    </div>
  </header>

  <main class="content">
    <div class="card" style="margin-bottom:12px">
      <div class="section-title">Planung</div>
      <div class="sub">Pro Datum genau eine Person Â· nur Kernteam</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:8px">
        <select id="personSel" style="max-width:300px"></select>
        <input type="date" id="dateSel">
        <button class="btn" onclick="saveAssignment()">Eintragen</button>
        <button class="btn ghost" onclick="removeAssignment()">Austragen</button>
      </div>
    </div>

    <div class="card table-wrap" id="calendar"></div>
  </main>

  <nav class="bottomnav">
    <a class="tab" href="index.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab active" href="hausdienst.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="buchungen.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
  const CORE=["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
  const firebaseConfig={apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",authDomain:"sickandsound-e9704.firebaseapp.com",projectId:"sickandsound-e9704",storageBucket:"sickandsound-e9704.firebasestorage.app",messagingSenderId:"248197359659",appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",measurementId:"G-62LH8V7S2E"};
  firebase.initializeApp(firebaseConfig); firebase.analytics(); const db=firebase.firestore();
  const today=new Date().toISOString().slice(0,10);

  function buildSelectors(){
    const sel=document.getElementById("personSel"); sel.innerHTML="";
    CORE.forEach(p=>{ const o=document.createElement("option"); o.value=o.textContent=p; sel.appendChild(o); });
    document.getElementById("dateSel").value=today;
  }
  function ymd(d){ return new Date(d).toISOString().slice(0,10); }

  async function saveAssignment(){
    const person=document.getElementById("personSel").value;
    const date=document.getElementById("dateSel").value;
    if(!person||!date) return alert("Bitte Person und Datum wÃ¤hlen");
    const ref=db.collection("hausdienst").doc(date);
    const ex=await ref.get();
    if(ex.exists && !confirm(`FÃ¼r ${date} ist bereits ${ex.data().person} eingetragen. Ãœberschreiben?`)) return;
    await ref.set({person,ts:Date.now()});
    if(date===today) window.location='hausdienst_checklist.html';
  }
  async function removeAssignment(){
    const date=document.getElementById("dateSel").value;
    const ref=db.collection("hausdienst").doc(date);
    const ex=await ref.get(); if(!ex.exists) return alert("FÃ¼r dieses Datum ist niemand eingetragen.");
    if(!confirm(`Eintrag fÃ¼r ${date} entfernen?`)) return; await ref.delete();
  }

  async function renderCalendar(){
    const start=new Date(); start.setDate(start.getDate()-5);
    const end=new Date(); end.setDate(end.getDate()+30);
    const rows=[]; let cur=new Date(start);
    while(cur<=end){
      const d=ymd(cur);
      // eslint-disable-next-line no-await-in-loop
      const doc=await db.collection("hausdienst").doc(d).get();
      rows.push({date:d,person:doc.exists?doc.data().person:null});
      cur.setDate(cur.getDate()+1);
    }
    let html=`<table><thead><tr><th>Datum</th><th>Status</th><th>Aktion</th></tr></thead><tbody>`;
    rows.forEach(r=>{
      const badge=r.person?`<span class="badge ok">${r.person}</span>`:`<span class="badge none">frei</span>`;
      const btn=r.person
        ? `<button class="btn small ghost" onclick="document.getElementById('dateSel').value='${r.date}'; removeAssignment()">Austragen</button>`
        : `<button class="btn small" onclick="document.getElementById('dateSel').value='${r.date}'; saveAssignment()">Eintragen</button>`;
      html+=`<tr><td>${r.date}</td><td>${badge}</td><td>${btn}</td></tr>`;
    });
    html+=`</tbody></table>`;
    document.getElementById("calendar").innerHTML=html;
  }

  function init(){
    buildSelectors(); renderCalendar(); db.collection("hausdienst").onSnapshot(renderCalendar);
  }
  // SW optional
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  window.onload=init;
</script>
</body>
</html>
