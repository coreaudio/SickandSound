<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausdienst</title>
  <style>
    body { font-family: sans-serif; margin: 1rem; }
    h1 { margin-bottom: 0.5rem; }
    .badge { padding: 2px 6px; border-radius: 4px; }
    .ok { background: #cfc; }
    .none { background: #fcc; }
    .sub { color: #666; font-size: 0.9em; }
  </style>
</head>
<body>
  <h1>Hausdienst</h1>
  <div id="connTxt">Verbinde...</div>

  <h2>Heute</h2>
  <div id="todayInfo">Lade…</div>

  <h2>Nächste 14 Tage</h2>
  <div id="nextList">Lade…</div>

  <h2>Checkliste</h2>
  <div id="checklist">Lade…</div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

  <script>
    // === Dein Firebase Projekt ===
    const firebaseConfig = {
      apiKey: "AIzaSyBtpzar4QPH0y02qaedM0BxxJ5FdNP2vhE",
      authDomain: "sickandsound-8a15f.firebaseapp.com",
      projectId: "sickandsound-8a15f",
      storageBucket: "sickandsound-8a15f.appspot.com",
      messagingSenderId: "32138160959",
      appId: "1:32138160959:web:a65c7f4ad7d44e757fc18a"
    };

    let db = null;
    try {
      firebase.initializeApp(firebaseConfig);

      // hilft bei blockierten Websocket-Verbindungen (z. B. Adblocker/Netzwerk)
      firebase.firestore().settings({
        experimentalAutoDetectLongPolling: true,
        useFetchStreams: false
      });

      db = firebase.firestore();
      document.getElementById('connTxt').textContent = 'Online (Firestore verbunden)';
      init();
    } catch (e) {
      console.error(e);
      document.getElementById('connTxt').textContent =
        'Offline – Firebase konnte nicht initialisiert werden.';
    }

    function todayStr() {
      const dt = new Date();
      return dt.toISOString().slice(0, 10);
    }

    // === Heute (live) ===
    function listenTodayInfo() {
      const el = document.getElementById('todayInfo');
      db.collection("hausdienst").doc(todayStr())
        .onSnapshot(doc => {
          if (doc.exists) {
            el.innerHTML =
              `Heute eingetragener Hausdienst: <span class="badge ok">${doc.data().person}</span>`;
          } else {
            el.innerHTML =
              `Heute: <span class="badge none">Noch niemand eingetragen</span>`;
          }
        }, err => {
          console.error(err);
          el.innerHTML = `<span class="sub">Fehler beim Laden (${err?.code || 'unbekannt'})</span>`;
        });
    }

    // === Nächste 14 Tage ===
    async function renderNextDays() {
      const el = document.getElementById('nextList');
      try {
        const out = [];
        for (let i = 0; i < 14; i++) {
          const dt = new Date(); dt.setDate(dt.getDate() + i);
          const id = dt.toISOString().slice(0, 10);
          const doc = await db.collection("hausdienst").doc(id).get();
          out.push([id, doc.exists ? (doc.data().person || null) : null, i === 0]);
        }
        el.innerHTML = "<ul>" + out.map(([id, person, isToday]) =>
          `<li>${isToday ? "<b>" + id + " (heute)</b>" : id}: ${person || "frei"}</li>`
        ).join("") + "</ul>";
      } catch (err) {
        console.error(err);
        el.innerHTML = `<div class="sub">Fehler beim Laden (${err?.code || 'unbekannt'})</div>`;
      }
    }

    function listenNextDays() {
      const ids = [];
      for (let i = 0; i < 14; i++) {
        const dt = new Date(); dt.setDate(dt.getDate() + i);
        ids.push(dt.toISOString().slice(0, 10));
      }
      ids.forEach(id => {
        db.collection("hausdienst").doc(id).onSnapshot(() => {
          renderNextDays();
        });
      });
    }

    // === Checkliste (live) ===
    function listenChecklist() {
      const el = document.getElementById('checklist');
      db.collection("checklistTasks").onSnapshot(snapshot => {
        if (snapshot.empty) {
          el.textContent = "Keine Aufgaben.";
          return;
        }
        const items = snapshot.docs.map(doc => {
          const d = doc.data();
          return `<li>[${d.cat}] ${d.text} ${d.done ? "✔️" : ""}</li>`;
        });
        el.innerHTML = "<ul>" + items.join("") + "</ul>";
      }, err => {
        console.error(err);
        el.innerHTML = `<div class="sub">Fehler beim Laden (${err?.code || 'unbekannt'})</div>`;
      });
    }

    function init() {
      listenTodayInfo();
      renderNextDays();
      listenNextDays();
      listenChecklist();
    }
  </script>
</body>
</html>
