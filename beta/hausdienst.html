<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausdienst Rangliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    body { background:#0f1117; color:#f1f1f1; font-family:'Orbitron',sans-serif; margin:20px; }
    h2 { text-align:center; }
    h3 { margin-top:30px; }
    table { width:100%; border-collapse:collapse; background:#1a1d24; margin-bottom:20px; }
    th, td { padding:8px; text-align:center; border-bottom:1px solid #2a2d34; }
    th { font-size:1em; font-weight:600; }
    .gold { color:gold; } .silver { color:silver; } .bronze { color:#cd7f32; }
    .footer { margin-top:20px; display:flex; flex-wrap:wrap; justify-content:center; gap:15px; }
    .btn { padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    .select { background:#00c9a7; color:#000; }
    .undo   { background:#ffa500; color:#000; }
    .reset  { background:#ff4444; color:#fff; }
    .back   { background:#444;   color:#fff; }
    .hausdienstAktuell { background:#00c9a7; color:#000; font-weight:bold; border-radius:6px; padding:2px 6px; }
  </style>
</head>
<body>
  <h2>üèÜ Hausdienst Rangliste</h2>
  <div id="hausdienstTable"></div>

  <h3>üìÖ Monats√ºbersicht</h3>
  <div id="monthlyTable"></div>

  <div class="footer">
    <button class="btn select" onclick="setRandomHausdienst()">üé≤ Zuf√§llig ausw√§hlen</button>
    <button class="btn undo"   onclick="undoHausdienst()">‚Ü© R√ºckg√§ngig</button>
    <button class="btn reset"  onclick="resetHausdienst()">‚ôª Reset</button>
    <button class="btn back"   onclick="window.location='index.html'">‚¨Ö Zur√ºck</button>
  </div>

  <!-- Firebase-Compat-SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase initialisieren
    const firebaseConfig = {
      apiKey: "AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",
      authDomain: "sickandsound-e9704.firebaseapp.com",
      projectId: "sickandsound-e9704",
      storageBucket: "sickandsound-e9704.firebasestorage.app",
      messagingSenderId: "248197359659",
      appId: "1:248197359659:web:a8777cbed3f83d6b1ca26e",
      measurementId: "G-62LH8V7S2E"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();

    // Keys & Default-State
    const hausdienstKey = "sick_sound_hausdienst";
    const peopleKey     = "sick_sound_people";
    let hausdienst = { current:null, stats:{}, history:[] };
    let people     = [];

    // Hilfs-Array deutscher Monatsnamen
    const monthNames = [
      "Januar","Februar","M√§rz","April","Mai","Juni",
      "Juli","August","September","Oktober","November","Dezember"
    ];

    // State laden (Firestore ‚Üí Fallback localStorage)
    async function loadState() {
      try {
        const snap = await db.collection("state").doc("global").get();
        if (snap.exists) {
          const s = snap.data();
          hausdienst = s.hausdienst || hausdienst;
          people     = s.people     || JSON.parse(localStorage.getItem(peopleKey)) || [];
        } else {
          people = JSON.parse(localStorage.getItem(peopleKey)) || [];
        }
      } catch (e) {
        console.warn("Firestore laden fehlgeschlagen, nutze localStorage:", e);
        hausdienst = JSON.parse(localStorage.getItem(hausdienstKey)) || hausdienst;
        people     = JSON.parse(localStorage.getItem(peopleKey))     || [];
      }
      buildHausdienstTable();
      buildMonthlySummary();
    }

    // State speichern (localStorage + Firestore)
    function save() {
      localStorage.setItem(hausdienstKey, JSON.stringify(hausdienst));
      localStorage.setItem(peopleKey,     JSON.stringify(people));
      db.collection("state").doc("global")
        .set({ hausdienst }, { merge: true })
        .catch(e => console.error("Firestore speichern fehlgeschlagen:", e));
    }

    // 1) Haupt-Tabelle
    function buildHausdienstTable() {
      // Gesamtauswertung
      const stats = {};
      people.forEach(p=>stats[p]=0);
      Object.entries(hausdienst.stats).forEach(([p,v])=>stats[p]=v);

      const arr = Object.entries(stats)
        .sort((a,b)=>b[1]-a[1]||a[0].localeCompare(b[0]));

      let html = `<table><thead>
        <tr><th>Platz</th><th>Person</th><th>Punkte</th><th>Aktion</th></tr>
      </thead><tbody>`;
      arr.forEach(([person,punkte], i)=>{
        const cls = i===0?"gold":i===1?"silver":i===2?"bronze":"";
        const mark = hausdienst.current===person
          ? `<span class="hausdienstAktuell">Aktuell</span>` : "";
        html += `<tr>
          <td>${i+1}</td>
          <td class="${cls}">${person} ${mark}</td>
          <td>${punkte}</td>
          <td>
            <button class="btn select" onclick="setHausdienst('${person}')">
              Ausw√§hlen
            </button>
          </td>
        </tr>`;
      });
      html += `</tbody></table>`;
      document.getElementById("hausdienstTable").innerHTML = html;
    }

    // 2) Monats√ºbersicht pro abgeschlossenem Monat
    function buildMonthlySummary() {
      // History nach Jahr-Monat gruppieren
      const groups = {};
      hausdienst.history.forEach(e=>{
        const d = new Date(e.date);
        // nur abgeschlossene Monate: < aktueller Monat?
        const now = new Date();
        if (d.getFullYear()===now.getFullYear() && d.getMonth()===now.getMonth()) {
          // aktuellen Monat √ºberspringen
          return;
        }
        const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
        groups[key] = groups[key] || [];
        groups[key].push(e.person);
      });

      // nach Datum sortieren (absteigend)
      const keys = Object.keys(groups).sort().reverse();

      let html = "";
      keys.forEach(key=>{
        const [year, mon] = key.split("-");
        const persons = groups[key];
        // Statistik pro Person
        const stats = {};
        people.forEach(p=>stats[p]=0);
        persons.forEach(p=>stats[p]++);
        // sortieren
        const arr = Object.entries(stats)
          .sort((a,b)=>b[1]-a[1]||a[0].localeCompare(b[0]));
        // Monats√ºberschrift
        html += `<h3>${monthNames[Number(mon)-1]} ${year}</h3>`;
        // Tabelle
        html += `<table><thead>
          <tr><th>Platz</th><th>Person</th><th>Anzahl</th></tr>
        </thead><tbody>`;
        arr.forEach(([person,count], i)=>{
          if (count===0) return; // Personen ohne Hausdienst √ºberspringen
          const cls = i===0?"gold":i===1?"silver":i===2?"bronze":"";
          html += `<tr>
            <td>${i+1}</td>
            <td class="${cls}">${person}</td>
            <td>${count}</td>
          </tr>`;
        });
        html += `</tbody></table>`;
      });

      document.getElementById("monthlyTable").innerHTML = html || "<p>Noch keine abgeschlossenen Monate.</p>";
    }

    // Auswahl-/Manipulations-Funktionen
    function setHausdienst(person) {
      hausdienst.current = person;
      hausdienst.stats[person] = (hausdienst.stats[person]||0) + 1;
      hausdienst.history.push({ person, date: new Date().toISOString() });
      save();
      buildHausdienstTable();
      buildMonthlySummary();
    }

    function setRandomHausdienst() {
      if (!people.length) return;
      const rand = people[Math.floor(Math.random()*people.length)];
      setHausdienst(rand);
    }

    function undoHausdienst() {
      if (!hausdienst.history.length) return;
      const last = hausdienst.history.pop();
      if (hausdienst.stats[last.person] > 0) hausdienst.stats[last.person]--;
      if (hausdienst.current===last.person) hausdienst.current = null;
      save();
      buildHausdienstTable();
      buildMonthlySummary();
    }

    function resetHausdienst() {
      if (!confirm("‚ö†Ô∏è Willst du wirklich alle Punkte zur√ºcksetzen?")) return;
      hausdienst = { current:null, stats:{}, history:[] };
      save();
      buildHausdienstTable();
      buildMonthlySummary();
    }

    window.onload = loadState;
  </script>
</body>
</html>
