<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausdienst – Checkliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <style>
    .tabs{display:flex;gap:8px;margin-bottom:10px}
    .tabs .btn{padding:8px 12px}
    .group{margin-bottom:12px}
    .group h3{margin:0 0 6px 0}
    .task{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;border:1px solid #222a3f;background:#0b0e14;margin-bottom:6px}
    .task.done{opacity:.6; text-decoration:line-through}
    .actions{display:flex;gap:8px;margin-top:8px}
    .subtle{opacity:.8}
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title"><div class="brand-dot"></div><h1>Checkliste</h1></div>
    <div class="appbar-actions">
      <a class="btn small" href="hausdienst.html">Zurück</a>
    </div>
  </header>

  <main class="content">
    <div class="card">
      <div class="section-title">Tag</div>
      <div id="dateInfo" class="subtle"></div>
      <div class="tabs">
        <button class="btn" onclick="setFilter('open')">Nur offen</button>
        <button class="btn" onclick="setFilter('all')">Alle</button>
        <button class="btn" onclick="setFilter('done')">Erledigt</button>
      </div>
    </div>

    <div class="card">
      <div class="group">
        <h3>Morgens</h3>
        <div id="g_morning"></div>
      </div>
      <div class="group">
        <h3>Im Laufe des Tages</h3>
        <div id="g_day"></div>
      </div>
      <div class="group">
        <h3>Bevor man geht</h3>
        <div id="g_evening"></div>
      </div>
      <div class="actions">
        <button class="btn" onclick="openAdd()">Aufgabe hinzufügen</button>
        <button class="btn danger" onclick="clearDone()">Erledigte des Tages ausblenden</button>
      </div>
      <div class="subtle" style="margin-top:6px">Aufgabenliste wird dauerhaft gespeichert. Abhaken zählt nur für das heutige Datum.</div>
    </div>
  </main>

  <!-- Bottom Navigation – wie auf den anderen Seiten -->
  <nav class="bottomnav">
    <a class="tab" href="index.html" aria-label="Strichliste">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab active" href="hausdienst.html" aria-label="Hausdienst">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html" aria-label="Ranglisten">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="badges.html" aria-label="Badges">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg>
      <span>Badges</span>
    </a>
    <a class="tab" href="buchungen.html" aria-label="Buchungen">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- Add Modal -->
<div class="modal" id="addModal"><div class="box">
  <h2>Aufgabe hinzufügen</h2>
  <select id="addGroup">
    <option value="morning">Morgens</option>
    <option value="day">Im Laufe des Tages</option>
    <option value="evening">Bevor man geht</option>
  </select>
  <input id="addText" placeholder="Aufgabe…" style="margin-top:8px">
  <div style="display:flex;gap:8px;margin-top:10px">
    <button class="btn" onclick="confirmAdd()">Speichern</button>
    <button class="btn dark" onclick="closeAdd()">Abbrechen</button>
  </div>
</div></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig={apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",authDomain:"sickandsound-e9704.firebaseapp.com",projectId:"sickandsound-e9704",storageBucket:"sickandsound-e9704.firebasestorage.app",messagingSenderId:"248197359659",appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",measurementId:"G-62LH8V7S2E"};
let db=null; try{firebase.initializeApp(firebaseConfig); try{firebase.analytics();}catch(_){ } db=firebase.firestore();}catch(_){db=null;}
const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";
const todayStr=()=>new Date().toISOString().slice(0,10);

const DEFAULTS={
  morning:["Briefkasten leeren","Spülmaschine ausräumen","Toilettenpapier & Zewa auffüllen","Getränke auffüllen","Staubsauger Wasser checken"],
  day:["Wäsche an machen & aufhängen","Pakete entgegennehmen","Für Grundordnung sorgen"],
  evening:["Oberflächen in der Küche + Geräte wischen","Müll rausbringen & mitnehmen"]
};
let tasks={...DEFAULTS}; // globale Vorlage
let done={};            // für HEUTE (Map taskId -> true)
let filter='open';

function setFilter(f){ filter=f; render(); }
function openAdd(){ document.getElementById('addModal').classList.add('show'); }
function closeAdd(){ document.getElementById('addModal').classList.remove('show'); }
function confirmAdd(){
  const g=document.getElementById('addGroup').value, t=document.getElementById('addText').value.trim();
  if(!t) return; tasks[g]=(tasks[g]||[]).concat([t]); saveTasks(); render(); closeAdd(); document.getElementById('addText').value='';
}

function idFor(g,i){ return `${g}_${i}`; }

function renderGroup(key, elId){
  const wrap=document.getElementById(elId); const list=tasks[key]||[];
  wrap.innerHTML = list.map((txt,i)=>{
    const id=idFor(key,i), isDone=!!done[id];
    if(filter==='open' && isDone) return '';
    if(filter==='done' && !isDone) return '';
    return `<div class="task ${isDone?'done':''}">
      <input type="checkbox" ${isDone?'checked':''} onchange="toggleDone('${id}')">
      <div style="flex:1">${txt}</div>
      <button class="btn small danger" onclick="removeTask('${key}',${i})">Löschen</button>
    </div>`;
  }).join('');
}

function render(){
  document.getElementById('dateInfo').textContent = `Heute: ${todayStr()}`;
  renderGroup('morning','g_morning');
  renderGroup('day','g_day');
  renderGroup('evening','g_evening');
}

async function load(){
  // Vorlage aus globalem State
  if(db){
    try{
      const s=await db.collection(STATE_COLLECTION).doc("global").get();
      if(s.exists && s.data().checklistTasks) tasks=s.data().checklistTasks;
    }catch(e){}
    // Done-Map für heute
    try{
      const d=await db.collection("hausdienst_checklist").doc(todayStr()).get();
      if(d.exists && d.data().done) done=d.data().done;
    }catch(e){}
  }else{
    tasks=JSON.parse(localStorage.getItem('checklistTasks')||'null')||tasks;
    done =JSON.parse(localStorage.getItem('checklistDone_'+todayStr())||'null')||{};
  }
  render();
  if(db){
    db.collection("hausdienst_checklist").doc(todayStr()).onSnapshot(s=>{ if(s.exists){ done=s.data().done||{}; render(); }});
  }
}
function saveTasks(){
  if(db){ db.collection(STATE_COLLECTION).doc("global").set({checklistTasks:tasks},{merge:true}); }
  localStorage.setItem('checklistTasks',JSON.stringify(tasks));
}
function saveDone(){
  if(db){ db.collection("hausdienst_checklist").doc(todayStr()).set({done},{merge:true}); }
  localStorage.setItem('checklistDone_'+todayStr(),JSON.stringify(done));
}
function toggleDone(id){ done[id]=!done[id]; if(!done[id]) delete done[id]; saveDone(); render(); }
function removeTask(group, idx){
  if(!confirm("Aufgabe wirklich löschen?")) return;
  (tasks[group]||[]).splice(idx,1); // IDs verschieben sich – done-Map für Sicherheit zurücksetzen
  done={}; saveTasks(); saveDone(); render();
}
function clearDone(){ done={}; saveDone(); render(); }

if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
load();
</script>
</body>
</html>
