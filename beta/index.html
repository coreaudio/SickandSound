<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound â€“ Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    :root{ --ring: 48px; --row-pad: 6px; --name-size: 18px; --count-size: 17px; --cell-gap: 10px; }
    .content{ padding-bottom: 88px; }
    .appbar{ min-height: 52px; }
    .bottomnav{ height: 64px; }
    .card.table-wrap table td, .card.table-wrap table th{ padding-top: var(--row-pad); padding-bottom: var(--row-pad); }
    .lvl-ring{ width: var(--ring); height: var(--ring); position:relative; display:inline-grid; place-items:center; }
    .lvl-ring .val{ position:absolute; font-size: 12px; font-weight: 800; line-height:1; }
    .person-cell{ display:flex; align-items:center; gap:10px; }
    .p-name{ font-size: var(--name-size); font-weight: 800; letter-spacing:.2px; }
    .drink-chip .drink-name{ font-size: 12px; }
    .drink-chip .drink-price{ font-size: 11px; opacity:.8 }
    .cell{ display:flex; align-items:center; justify-content:flex-end; gap: var(--cell-gap); }
    .count{ font-size: var(--count-size); min-width: 26px; text-align:right; }
    .plus-btn{ padding:8px 12px; }
    .section-row td{ font-size:12px; opacity:.7 }
    .guest-toggle{ margin:10px 0 -2px; display:flex; justify-content:center; }
    .guest-toggle .btn{ min-width: 200px; }
    .section-title{ font-size: 14px; }

    .cta-wrap{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:8px; }
    .cta-check{ display:inline-flex; align-items:center; gap:10px; padding:12px 16px; border-radius:14px;
      background: linear-gradient(135deg,#6ee7ff,#a78bfa); color:#0b0e14; font-weight:900; letter-spacing:.2px;
      text-decoration:none; border:none; box-shadow:0 8px 24px rgba(0,0,0,.25); cursor:pointer;
    }
    .cta-check svg{ width:20px; height:20px; }
    .cta-sub{ font-size:12px; opacity:.85; }

    .statusdot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;background:#ffadad}
    .statusok{background:#7CFC9A}
    .qr{ width: 280px; max-width: 80vw; border-radius: 14px; }
  </style>
</head>
<body>
<div class="app">

  <!-- AppBar -->
  <header class="appbar">
    <div class="app-title">
      <div class="brand-dot"></div>
      <h1>Sick &amp; Sound</h1>
    </div>
    <div class="appbar-actions">
      <span class="sub"><span class="statusdot" id="dot"></span><span id="connTxt">Verbindeâ€¦</span></span>
      <button class="btn small dark" onclick="togglePayPal()" title="PayPal">ðŸ’¸</button>
      <button class="btn small" onclick="openDrinkModal()" title="GetrÃ¤nk hinzufÃ¼gen">âž•</button>
    </div>
  </header>

  <!-- Content -->
  <main class="content">
    <div class="card" style="margin-bottom:8px">
      <div class="section-title">Heute</div>
      <div id="todayInfo" class="sub">Lade Tagesstatusâ€¦</div>
      <div class="cta-wrap" id="todayCta"></div>
    </div>

    <div class="card table-wrap" id="tableContainer"></div>

    <div class="card" style="margin-top:8px">
      <div class="section-title">Aktionen</div>
      <div class="footer" style="gap:8px;flex-wrap:wrap">
        <button class="btn warning" id="undoBtn" onclick="undoLast()">â†© RÃ¼ckgÃ¤ngig</button>
        <button class="btn secondary" id="redoBtn" onclick="redoLast()">â†ª Wiederholen</button>
        <button class="btn danger" id="deleteBtn" onclick="toggleDeleteMode()">ðŸ—‘ LÃ¶schen</button>
        <button class="btn dark" onclick="resetAll()">â™» Abrechnen & zurÃ¼cksetzen</button>
        <button class="btn ghost" onclick="window.location='buchungen.html'">ðŸ“– Buchungen</button>
      </div>
    </div>
  </main>

  <!-- BottomNav -->
  <nav class="bottomnav">
    <a class="tab active" href="index.html" aria-label="Strichliste">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab" href="hausdienst.html#plan" aria-label="Hausdienst">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html" aria-label="Ranglisten">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="badges.html" aria-label="Badges">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg>
      <span>Badges</span>
    </a>
    <a class="tab" href="buchungen.html" aria-label="Buchungen">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- Modals -->
<div class="modal" id="paypalModal" onclick="togglePayPal()"><img class="qr" src="frame.png" alt="PayPal QR"></div>

<div class="modal" id="personModal"><div class="box">
  <h2>âž• Person hinzufÃ¼gen</h2>
  <input id="personName" placeholder="Name eintippen" />
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn" onclick="confirmAddPerson()">Speichern</button>
    <button class="btn dark" onclick="closeModal('personModal')">Abbrechen</button>
  </div>
</div></div>

<div class="modal" id="drinkModal"><div class="box">
  <h2>ðŸ¥¤ GetrÃ¤nk hinzufÃ¼gen</h2>
  <input id="drinkName" placeholder="Name des GetrÃ¤nks">
  <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (â‚¬)">
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn" onclick="confirmAddDrink()">Speichern</button>
    <button class="btn dark" onclick="closeModal('drinkModal')">Abbrechen</button>
  </div>
</div></div>

<!-- Firebase + Howler -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>

<script>
/* ===== Config ===== */
const CORE = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];

// âœ… Richtiges Firebase-Projekt
const firebaseConfig = {
  apiKey: "AIzaSyBtZsr4QPHQbvO2qae6MoBoxJF5dNP2vh0",
  authDomain: "sickandsound-8a15f.firebaseapp.com",
  projectId: "sickandsound-8a15f",
  storageBucket: "sickandsound-8a15f.appspot.com",
  messagingSenderId: "32138160959",
  appId: "1:32138160959:web:a65c7f4ad7d44e757fc18a"
};

let db=null;
try{
  if(window.firebase){
    firebase.initializeApp(firebaseConfig);
    try{ firebase.analytics(); }catch(_){}
    db=firebase.firestore();
    try { db.settings({ experimentalAutoDetectLongPolling:true, merge:true }); } catch(_) {}
    document.getElementById('dot').classList.add('statusok');
    document.getElementById('connTxt').textContent='Online (Firestore verbunden)';
  }
}catch(_){ db=null; document.getElementById('connTxt').textContent='Offline â€“ Firebase konnte nicht initialisiert werden.'; }

/* Prod/Beta Toggle */
const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";
const STATE_DOC_ID = "main";

/* ===== In-Memory State ===== */
let prices = [ // {name, price}
  {name:"Mate", price:1.5},
  {name:"Wasser", price:0.5},
  {name:"Cola", price:1.5},
];
let people = [...CORE];       // ["Chris", ...]
let order  = [...CORE];       // Reihenfolge
let data   = {};              // { person: { "Mate": 2, "Wasser": 1 } }
let history=[], redo=[];      // Undo/Redo Stacks
let deleteMode=false;

/* ===== Utils ===== */
const todayStr=()=>new Date().toISOString().slice(0,10);
const byName = (a,b)=>a.localeCompare(b, 'de', {sensitivity:'base'});

function openModal(id){ document.getElementById(id).classList.add('open'); }
function closeModal(id){ document.getElementById(id).classList.remove('open'); }
function togglePayPal(){ document.getElementById('paypalModal').classList.toggle('open'); }
function openPersonModal(){ openModal('personModal'); }
function openDrinkModal(){ openModal('drinkModal'); }

/* ===== Sounds (optional) ===== */
const sndClick = new Howl({ src: ['data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAABAQAAAAA='] });

/* ===== Firestore Persistence ===== */
async function loadState(){
  if(!db) return;
  const doc = await db.collection(STATE_COLLECTION).doc(STATE_DOC_ID).get();
  if(doc.exists){
    const s = doc.data();
    prices = s.prices || prices;
    people = s.people || people;
    order  = s.order  || people.slice().sort(byName);
    data   = s.data   || {};
  }else{
    order = people.slice().sort(byName);
    await saveState(); // initial anlegen
  }
}

let _saveTimer=null;
function scheduleSave(){
  clearTimeout(_saveTimer);
  _saveTimer = setTimeout(saveState, 450);
}
async function saveState(){
  if(!db) return;
  const payload = { prices, people, order, data, updatedAt: Date.now() };
  await db.collection(STATE_COLLECTION).doc(STATE_DOC_ID).set(payload, {merge:true});
}

/* ===== UI Rendering ===== */
function ensurePerson(name){
  if(!data[name]) data[name] = {};
  prices.forEach(d => { if(typeof data[name][d.name] !== 'number') data[name][d.name]=0; });
}
function personTotal(name){
  ensurePerson(name);
  return prices.reduce((sum,d)=> sum + (data[name][d.name]||0)*Number(d.price||0), 0);
}
function allTotals(){
  const totals = {};
  people.forEach(p=> totals[p] = personTotal(p));
  return totals;
}

function renderToday(){
  const el = document.getElementById('todayInfo');
  const cta = document.getElementById('todayCta');
  cta.innerHTML = '';
  el.textContent = 'Lade Tagesstatusâ€¦';
  // Hausdienst heute:
  db.collection("hausdienst").doc(todayStr()).get().then(d=>{
    const person = d.exists ? (d.data().person||null) : null;
    el.innerHTML = person
      ? `Heute eingetragener Hausdienst: <span class="badge ok">${person}</span>`
      : `Heute: <span class="badge none">Noch niemand eingetragen</span>`;
    cta.innerHTML = `
      <a class="cta-check" href="hausdienst.html#check" title="Zur Checkliste">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.5 1.4-1.4L9 13.4l7.1-7.1 1.4 1.4z"/></svg>
        <span>Checkliste Ã¶ffnen</span>
      </a>
      <span class="cta-sub">Haken gelten nur heute â€“ Aufgaben bleiben gespeichert</span>
    `;
  }).catch(e=>{
    el.textContent = 'Fehler beim Laden: ' + (e.code||e.message);
  });
}

function rowForPerson(name){
  ensurePerson(name);
  const lvl = Math.round(personTotal(name)); // simple ring-value
  const drinkCells = prices.map(d=>{
    const cnt = data[name][d.name] || 0;
    return `<td class="cell">
      <span class="count">${cnt}</span>
      <button class="btn small plus-btn" onclick="inc('${name}','${d.name}')">+</button>
    </td>`;
  }).join('');
  const delBtn = deleteMode
    ? `<button class="btn small danger" onclick="removePerson('${name}')">LÃ¶schen</button>`
    : '';
  return `<tr>
    <td>
      <div class="person-cell">
        <div class="lvl-ring"><div class="val">${lvl}</div></div>
        <div class="p-name">${name}</div>
      </div>
    </td>
    ${drinkCells}
    <td class="cell"><b>${personTotal(name).toFixed(2)}â‚¬</b> ${delBtn}</td>
  </tr>`;
}

function headerRow(){
  const heads = prices.map(d=>`<th class="right">
    <div class="drink-chip"><span class="drink-name">${d.name}</span><br><span class="drink-price">${Number(d.price).toFixed(2)}â‚¬</span></div>
  </th>`).join('');
  return `<tr><th>Person</th>${heads}<th class="right">Summe</th></tr>`;
}

function totalsRow(){
  const totals = people.reduce((acc,p)=>{
    prices.forEach(d=>{
      acc[d.name] = (acc[d.name]||0) + (data[p]?.[d.name]||0);
    });
    return acc;
  }, {});
  const cells = prices.map(d=>`<td class="right"><b>${totals[d.name]||0}</b></td>`).join('');
  const sum = people.reduce((s,p)=> s + personTotal(p), 0);
  return `<tr class="section-row"><td>Gesamt</td>${cells}<td class="right"><b>${sum.toFixed(2)}â‚¬</b></td></tr>`;
}

function renderTable(){
  const wrap = document.getElementById('tableContainer');
  if(!people.length){
    wrap.innerHTML = `<div class="sub">Noch keine Personen. <button class="btn small" onclick="openPersonModal()">Person hinzufÃ¼gen</button></div>`;
    return;
  }
  const ordered = order.filter(n=>people.includes(n)).concat(people.filter(n=>!order.includes(n))).sort(byName);
  const rows = ordered.map(rowForPerson).join('');
  wrap.innerHTML = `
    <table>
      <thead>${headerRow()}</thead>
      <tbody>${rows}</tbody>
      <tfoot>${totalsRow()}</tfoot>
    </table>
    <div class="footer" style="gap:8px;flex-wrap:wrap;margin-top:8px">
      <button class="btn" onclick="openPersonModal()">âž• Person</button>
      <button class="btn" onclick="openDrinkModal()">âž• GetrÃ¤nk</button>
    </div>
  `;
  document.getElementById('deleteBtn').classList.toggle('warning', deleteMode);
}

/* ===== Mutations ===== */
function pushHistory(op){ history.push(op); redo.length=0; updateUndoRedo(); scheduleSave(); }
function updateUndoRedo(){
  document.getElementById('undoBtn').disabled = history.length===0;
  document.getElementById('redoBtn').disabled = redo.length===0;
}
function inc(name, drink){
  sndClick.play();
  ensurePerson(name);
  data[name][drink] = (data[name][drink]||0) + 1;
  pushHistory({type:'inc', name, drink});
  renderTable();
}
function undoLast(){
  const op = history.pop();
  if(!op) return;
  if(op.type==='inc'){
    data[op.name][op.drink] = Math.max(0, (data[op.name][op.drink]||0)-1);
  }else if(op.type==='addPerson'){
    people = people.filter(n=>n!==op.name);
    order = order.filter(n=>n!==op.name);
    delete data[op.name];
  }else if(op.type==='addDrink'){
    prices = prices.filter(d=>d.name!==op.drink.name);
    people.forEach(p=>{ if(data[p]) delete data[p][op.drink.name]; });
  }else if(op.type==='removePerson'){
    people.push(op.name);
    order.push(op.name);
    data[op.name] = op.snapshot;
  }
  redo.push(op);
  updateUndoRedo();
  renderTable();
  scheduleSave();
}
function redoLast(){
  const op = redo.pop();
  if(!op) return;
  if(op.type==='inc'){
    data[op.name][op.drink] = (data[op.name][op.drink]||0)+1;
  }else if(op.type==='addPerson'){
    people.push(op.name);
    order.push(op.name);
    ensurePerson(op.name);
  }else if(op.type==='addDrink'){
    prices.push(op.drink);
    people.forEach(p=>ensurePerson(p));
  }else if(op.type==='removePerson'){
    delete data[op.name];
    people = people.filter(n=>n!==op.name);
    order = order.filter(n=>n!==op.name);
  }
  history.push(op);
  updateUndoRedo();
  renderTable();
  scheduleSave();
}
function toggleDeleteMode(){
  deleteMode = !deleteMode;
  renderTable();
}
function removePerson(name){
  if(!confirm(`Person â€ž${name}â€œ wirklich lÃ¶schen?`)) return;
  const snapshot = JSON.parse(JSON.stringify(data[name]||{}));
  delete data[name];
  people = people.filter(n=>n!==name);
  order = order.filter(n=>n!==name);
  pushHistory({type:'removePerson', name, snapshot});
  renderTable();
}
function confirmAddPerson(){
  const inp = document.getElementById('personName');
  const name = (inp.value||'').trim();
  if(!name) return;
  if(people.includes(name)) { alert('Person existiert bereits.'); return; }
  people.push(name); order.push(name); ensurePerson(name);
  pushHistory({type:'addPerson', name});
  inp.value=''; closeModal('personModal'); renderTable();
}
function confirmAddDrink(){
  const n = (document.getElementById('drinkName').value||'').trim();
  const p = parseFloat(document.getElementById('drinkPrice').value||'0');
  if(!n) return;
  if(prices.some(d=>d.name.toLowerCase()===n.toLowerCase())) { alert('GetrÃ¤nk existiert bereits.'); return; }
  const drink = {name:n, price: isFinite(p)?p:0};
  prices.push(drink);
  people.forEach(person=>ensurePerson(person));
  pushHistory({type:'addDrink', drink});
  document.getElementById('drinkName').value='';
  document.getElementById('drinkPrice').value='';
  closeModal('drinkModal'); renderTable();
}

/* ===== Abrechnen & ZurÃ¼cksetzen ===== */
async function resetAll(){
  if(!confirm('Abrechnen & zurÃ¼cksetzen? Alle ZÃ¤hler gehen auf 0 und eine Buchung wird gespeichert.')) return;
  // Aggregation fÃ¼r Buchungseintrag
  const items = people.map(p=>({
    person: p,
    total: personTotal(p),
    counts: {...data[p]}
  }));
  const payload = {
    createdAt: Date.now(),
    items
  };
  try{
    await db.collection('buchungen').add(payload);
  }catch(e){ console.error('Buchung speichern fehlgeschlagen', e); }

  // ZÃ¤hler zurÃ¼cksetzen
  people.forEach(p=>{ Object.keys(data[p]||{}).forEach(dr=> data[p][dr]=0 ); });
  history.length=0; redo.length=0; updateUndoRedo();
  renderTable(); scheduleSave();
}

/* ===== Init ===== */
async function init(){
  await loadState();
  // Sicherheitsnetz: ensure all keys present
  people.forEach(p=>ensurePerson(p));
  renderTable(); updateUndoRedo(); renderToday();
}
init();
</script>

<!-- Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=21', { scope: './' }).catch(()=>{});
  }
</script>
</body>
</html>
