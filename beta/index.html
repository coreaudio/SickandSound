<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound – Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="container">

    <div class="card">
      <h1>🥤 Sick & Sound</h1>
      <div class="sub" id="todayInfo">Lade Tagesstatus…</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn small" onclick="openHausdienst()">🏠 Hausdienst planen</button>
        <button class="btn small secondary" onclick="window.location='rangliste.html'">🏆 Ranglisten</button>
        <button class="btn small dark" onclick="togglePayPal()">💸 PayPal</button>
      </div>
    </div>

    <div class="card table-wrap" id="tableContainer"></div>

    <div class="footer">
      <button class="btn" onclick="openDrinkModal()">➕ Getränk</button>
      <button class="btn warning" onclick="undoLast()">↩ Rückgängig</button>
      <button class="btn danger" id="deleteBtn" onclick="toggleDeleteMode()">🗑 Löschen</button>
      <button class="btn dark" onclick="resetAll()">♻ Abrechnen & zurücksetzen</button>
      <button class="btn ghost" onclick="window.location='buchungen.html'">📖 Buchungen</button>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="paypalModal" onclick="togglePayPal()"><img class="qr" src="frame.png" alt="PayPal QR"></div>
  <div class="modal" id="personModal"><div class="box">
    <h2>➕ Person hinzufügen</h2>
    <input id="personName" placeholder="Name eintippen" />
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn" onclick="confirmAddPerson()">Speichern</button>
      <button class="btn dark" onclick="closeModal('personModal')">Abbrechen</button>
    </div>
  </div></div>
  <div class="modal" id="drinkModal"><div class="box">
    <h2>🥤 Getränk hinzufügen</h2>
    <input id="drinkName" placeholder="Name des Getränks">
    <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (€)">
    <div style="display:flex;gap:10px;margin-top:10px">
      <button class="btn" onclick="confirmAddDrink()">Speichern</button>
      <button class="btn dark" onclick="closeModal('drinkModal')">Abbrechen</button>
    </div>
  </div></div>

  <!-- Firebase + Howler -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>

  <script>
  /* ===== Config ===== */
  const CORE = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
  const firebaseConfig={apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",authDomain:"sickandsound-e9704.firebaseapp.com",projectId:"sickandsound-e9704",storageBucket:"sickandsound-e9704.firebasestorage.app",messagingSenderId:"248197359659",appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",measurementId:"G-62LH8V7S2E"};
  firebase.initializeApp(firebaseConfig); firebase.analytics(); const db=firebase.firestore();

  /* ===== State ===== */
  const pricesKey="sick_sound_prices", peopleKey="sick_sound_people", dataKey="sick_sound_data",
        historyKey="sick_sound_history", bookingsKey="sick_sound_bookings", orderKey="sick_sound_order",
        xpKey="sick_sound_xp";
  let prices={"Cola_Zero":1.0,"Monster":1.5,"Wasser":0.5,"Kaffee":1.0,"Mittagessen":6.0};
  let people=[], data={}, history=[], bookings=[], columnOrder=Object.keys(prices), xp={};
  let deleteMode=false, hdToday=null;

  /* ===== Sounds & XP helpers ===== */
  const sClick=new Howl({src:["https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/coin1.wav"]});
  const sLevel=new Howl({src:["https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/powerUp5.wav"]});
  const todayStr=()=>new Date().toISOString().slice(0,10);
  const levelOf=x=>Math.floor(Math.sqrt(x/20))+1;
  const lvlMin=l=>20*(l-1)*(l-1), lvlNext=l=>20*l*l;

  /* ===== Load ===== */
  async function loadState(){
    try{
      const snap=await db.collection("state").doc("global").get();
      if(snap.exists){
        const s=snap.data();
        prices=s.prices||prices; people=s.people||JSON.parse(localStorage.getItem(peopleKey))||[];
        data=s.data||data; history=s.history||history; bookings=s.bookings||bookings;
        columnOrder=s.columnOrder||Object.keys(prices); xp=s.xp||xp;
      }else{
        people=JSON.parse(localStorage.getItem(peopleKey))||[];
      }
    }catch(e){
      prices=JSON.parse(localStorage.getItem(pricesKey))||prices;
      people=JSON.parse(localStorage.getItem(peopleKey))||[];
      data=JSON.parse(localStorage.getItem(dataKey))||data;
      history=JSON.parse(localStorage.getItem(historyKey))||history;
      bookings=JSON.parse(localStorage.getItem(bookingsKey))||bookings;
      columnOrder=JSON.parse(localStorage.getItem(orderKey))||Object.keys(prices);
      xp=JSON.parse(localStorage.getItem(xpKey))||xp;
    }
    // Stelle sicher, dass Kernteam existiert (nicht löschbar)
    CORE.forEach(n=>{ if(!people.includes(n)) people.push(n); });
    saveAll(); buildTable(); updateTodayBanner(); subscribeRealtime();
  }

  function saveAll(){
    localStorage.setItem(pricesKey,JSON.stringify(prices));
    localStorage.setItem(peopleKey,JSON.stringify(people));
    localStorage.setItem(dataKey,JSON.stringify(data));
    localStorage.setItem(historyKey,JSON.stringify(history));
    localStorage.setItem(bookingsKey,JSON.stringify(bookings));
    localStorage.setItem(orderKey,JSON.stringify(columnOrder));
    localStorage.setItem(xpKey,JSON.stringify(xp));
    db.collection("state").doc("global").set({prices,people,data,history,bookings,columnOrder,xp},{merge:true});
  }

  function subscribeRealtime(){
    db.collection("state").doc("global").onSnapshot(snap=>{
      if(!snap.exists) return; const s=snap.data();
      prices=s.prices||prices; people=s.people||people; data=s.data||data; history=s.history||history;
      bookings=s.bookings||bookings; columnOrder=s.columnOrder||columnOrder; xp=s.xp||xp;
      CORE.forEach(n=>{ if(!people.includes(n)) people.push(n); }); // Kernteam sicherstellen
      buildTable(); updateTodayBanner();
    });
    db.collection("hausdienst").doc(todayStr()).onSnapshot(doc=>{
      hdToday = doc.exists ? doc.data().person : null; updateTodayBanner(hdToday); buildTable();
    });
  }

  /* ===== Banner ===== */
  async function updateTodayBanner(existing){
    let person=existing;
    if(person===undefined){
      const d=await db.collection("hausdienst").doc(todayStr()).get();
      person = d.exists ? d.data().person : null;
    }
    hdToday = person;
    const el=document.getElementById("todayInfo");
    el.innerHTML = person
      ? `Heute eingetragener Hausdienst: <span class="badge ok">${person}</span> · <a href="hausdienst_checklist.html" class="badge gold" style="text-decoration:none">Checkliste öffnen</a>`
      : `Heute: <span class="badge none">Noch niemand eingetragen</span>`;
  }
  function openHausdienst(){ window.location='hausdienst.html'; }

  /* ===== Table ===== */
  function buildTable(){
    // Aufteilen in Kernteam (in definierter Reihenfolge) & Gäste (alphabetisch)
    const core = CORE.filter(n=>people.includes(n));
    const guests = people.filter(n=>!CORE.includes(n)).sort((a,b)=>a.localeCompare(b));

    // Header
    let html = `<table><thead><tr><th>Person</th>`;
    columnOrder.forEach(drink=>{
      if(prices[drink]!==undefined){
        html += `<th onclick="headerClick('${drink}')">${drink.replace('_',' ')}<br><span class="sub">${prices[drink]}€</span></th>`;
      }
    });
    html += `<th>Gesamt (€)</th></tr></thead><tbody>`;

    // Zeilen-Renderer
    const row = (p)=>{
      const xpVal = xp[p]||0, lvl=levelOf(xpVal), min=lvlMin(lvl), next=lvlNext(lvl);
      const pct = Math.max(0, Math.min(100, ((xpVal-min)/(next-min))*100));
      const hdClass = (hdToday===p) ? "hd-today" : "";
      let r = `<tr class="${hdClass}"><th>
        <div class="lvl-wrap">
          <div>${p}</div>
          <div class="lvl-line">Lv. ${lvl} · ${xpVal} XP</div>
          <div class="progress"><span style="width:${pct}%"></span></div>
        </div>
      </th>`;
      columnOrder.forEach(dr=>{
        if(prices[dr]!==undefined){
          const id=`${p}_${dr}`, val=data[id]||0;
          r += `<td>
            <div id="${id}">${val}</div>
            <button class="btn small" onclick="changeValue('${id}',1,'${dr}','${p}')">+1</button>
          </td>`;
        }
      });
      const total = columnOrder.reduce((s,d)=>s+(data[`${p}_${d}`]||0)*prices[d],0);
      r += `<td id="${p}_Total">${total.toFixed(2)}</td></tr>`;
      return r;
    };

    // Kernteam
    core.forEach(p=> html += row(p));
    // Gäste Unterzeile + Gäste
    if(guests.length){
      html += `<tr class="section-row"><td colspan="${columnOrder.length+2}">— Gäste —</td></tr>`;
      guests.forEach(p=> html += row(p));
    }
    html += `</tbody></table>
             <div class="add-row" onclick="openPersonModal()">➕ Person hinzufügen</div>`;
    document.getElementById("tableContainer").innerHTML = html;
  }

  function headerClick(drink){ if(deleteMode) deleteColumn(drink); }

  /* ===== Interactions ===== */
  function changeValue(id,delta,drink,person){
    const el=document.getElementById(id);
    const cur=parseInt(el.textContent||'0'); const next=Math.max(0,cur+delta);
    history.push({id,prev:cur,action:"change"}); data[id]=next; el.textContent=next;

    const addXp = prices[drink]||0;                // XP ~ €-Preis
    const before=levelOf((xp[person]||0));
    xp[person]=(xp[person]||0)+addXp;
    const after=levelOf(xp[person]);
    (after>before ? sLevel : sClick).play();

    updateTotalsFor(person); saveAll();
  }

  function updateTotalsFor(person){
    const tot = columnOrder.reduce((s,d)=>s+(data[`${person}_${d}`]||0)*prices[d],0);
    document.getElementById(`${person}_Total`).textContent=tot.toFixed(2);
    buildTable(); // neu zeichnen, damit Fortschritt aktualisiert
  }

  function undoLast(){
    const last=history.pop(); if(!last) return;
    if(last.action==="change"){ data[last.id]=last.prev; }
    saveAll(); buildTable();
  }

  function resetAll(){
    const pw=prompt("Passwort eingeben:"); if(pw!=="1379"){alert("Falsches Passwort");return;}
    if(!confirm("Alle Striche abrechnen und zurücksetzen?")) return;
    people.forEach(p=>{
      const sum = columnOrder.reduce((s,d)=>s+(data[`${p}_${d}`]||0)*prices[d],0);
      if(sum>0) bookings.push({date:new Date().toLocaleDateString("de-DE"), person:p, sum});
      xp[p]=(xp[p]||0)+sum; // XP behalten/erhöhen
      columnOrder.forEach(d=>data[`${p}_${d}`]=0);
    });
    saveAll(); buildTable();
  }

  function openPersonModal(){ document.getElementById("personModal").classList.add("show"); }
  function openDrinkModal(){ document.getElementById("drinkModal").classList.add("show"); }
  function closeModal(id){ document.getElementById(id).classList.remove("show"); }
  function togglePayPal(){ document.getElementById("paypalModal").classList.toggle("show"); }

  function confirmAddPerson(){
    const name=document.getElementById("personName").value.trim(); if(!name) return alert("Bitte Namen eingeben");
    if(people.includes(name)) return alert("Person existiert bereits");
    people.push(name); saveAll(); buildTable(); closeModal('personModal'); document.getElementById("personName").value="";
  }
  function confirmAddDrink(){
    const name=document.getElementById("drinkName").value.trim(), price=parseFloat(document.getElementById("drinkPrice").value);
    if(!name||isNaN(price)||price<=0) return alert("Bitte gültige Eingaben");
    const key=name.replace(/\s+/g,'_'); prices[key]=price; if(!columnOrder.includes(key)) columnOrder.push(key);
    saveAll(); buildTable(); closeModal('drinkModal'); document.getElementById("drinkName").value=""; document.getElementById("drinkPrice").value="";
  }

  function toggleDeleteMode(){
    deleteMode=!deleteMode; const btn=document.getElementById("deleteBtn");
    btn.textContent = deleteMode ? "❌ Abbrechen" : "🗑 Löschen";
    btn.classList.toggle("ghost", deleteMode);
  }
  function deletePerson(p){
    if(!deleteMode) return;
    if(CORE.includes(p)){ alert("Kernteam kann nicht gelöscht werden."); toggleDeleteMode(); return; }
    if(!confirm(`${p} wirklich löschen?`)) return;
    people=people.filter(x=>x!==p); saveAll(); buildTable(); toggleDeleteMode();
  }
  function deleteColumn(drink){
    if(!deleteMode) return; if(!confirm(`Getränk "${drink}" löschen?`)) return;
    delete prices[drink]; columnOrder=columnOrder.filter(d=>d!==drink); saveAll(); buildTable(); toggleDeleteMode();
  }

  window.onload=loadState;
  </script>
</body>
</html>
