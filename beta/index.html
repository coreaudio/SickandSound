<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    /* --- Layout-Feinschliff fÃ¼r iPad Onepager --- */
    .appbar .app-title h1 { font-size: 18px; }
    .people-section { margin-top: 10px; }
    .section-title { margin-bottom: 6px; }
    .row {
      display: grid;
      grid-template-columns: 64px 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 14px;
      background: #0f1420;
      border: 1px solid #1f2538;
      margin-bottom: 6px;
    }
    .name {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: .2px;
    }

    /* Level-Ring */
    .avatar {
      position: relative;
      width: 56px; height: 56px;
      display: grid; place-items: center;
    }
    .ring {
      position:absolute; inset: -2px; /* genug Platz, damit nichts abgeschnitten wird */
      transform: rotate(-90deg);
    }
    .ring circle {
      fill: none;
      stroke-width: 6;
      stroke-linecap: round;
    }
    .ring .bg { stroke: #22304a; }
    .ring .fg { stroke: url(#grad); transition: stroke-dashoffset .25s ease; }

    .lvl {
      font-size: 12px;
      font-weight: 800;
      color: #aab3cf;
      position:absolute;
      bottom:-2px; left:0; right:0;
      text-align:center;
    }

    /* GetrÃ¤nkezeile (ZÃ¤hler links, +1 rechts) */
    .drinks { display:flex; gap:8px; flex-wrap: wrap; }
    .pill {
      display:flex; align-items:center; gap:8px;
      padding: 8px;
      border-radius: 12px;
      background:#101626;
      border:1px solid #202a42;
      min-width: 120px;
    }
    .pill .amount { min-width: 28px; text-align:center; font-weight:800; color:#ced5ea; }
    .pill .label { font-weight:700; }
    .pill .add {
      margin-left:auto;
      padding:6px 10px;
      border-radius:10px;
      background: linear-gradient(135deg, #6ee7ff, #a78bfa);
      color:#0b0e14; font-weight:800; border:0;
    }

    /* GÃ¤ste-Box */
    .guests .row { background:#0d111b; }

    /* Undo-Zeile */
    .actions { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }

    /* QR / PayPal Button Icon */
    .icon-paypal { width:22px; height:22px; display:block; }
    .btn.dark { color:#e6e8ef; }

    /* Modal (QR) */
    .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,.6); z-index:50; }
    .modal.open { display:grid; place-items:center; }
    .sheet {
      width:min(92vw, 460px);
      background:#0b0e14; border:1px solid #22283a; border-radius:18px;
      padding:14px;
    }
    .sheet img { width:100%; height:auto; display:block; border-radius:12px; }
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title">
      <div class="brand-dot"></div>
      <h1>Sick &amp; Sound â€“ Strichliste</h1>
    </div>
    <div class="appbar-actions">
      <!-- PayPal Button mit Inline-SVG -->
      <button id="qrBtn" class="btn small dark" title="PayPal QR">
        <svg class="icon-paypal" viewBox="0 0 64 64" aria-hidden="true">
          <path d="M18 10h17c10 0 16 5 16 13s-6 13-16 13h-12l-4 18h-9L18 10z" fill="currentColor"/>
          <path d="M15 27h16c9 0 14 4 14 11s-5 11-14 11h-12l-2 9h-9l6-31z" fill="currentColor" opacity=".55"/>
        </svg>
        <span class="sr-only">PayPal QR</span>
      </button>
      <a class="btn small dark" href="hausdienst.html" title="Hausdienst">ðŸ§¹</a>
      <a class="btn small dark" href="rangliste.html" title="Rang">ðŸ“Š</a>
    </div>
  </header>

  <main class="content">
    <!-- Kernteam -->
    <section class="people-section" id="coreWrap">
      <div class="section-title">Kernteam</div>
      <div id="coreList"></div>
    </section>

    <!-- GÃ¤ste -->
    <section class="people-section guests" id="guestWrap">
      <div class="section-title">GÃ¤ste</div>
      <div id="guestList"></div>
    </section>

    <div class="actions">
      <button id="undoBtn" class="btn ghost">â†©ï¸Ž Letzte Aktion rÃ¼ckgÃ¤ngig</button>
      <a class="btn secondary" href="buchungen.html">ðŸ“„ Buchungen</a>
    </div>
  </main>

  <nav class="bottomnav">
    <a class="tab active" href="index.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab" href="hausdienst.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="buchungen.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- QR Modal -->
<div id="qrModal" class="modal" role="dialog" aria-modal="true" aria-label="PayPal QR">
  <div class="sheet">
    <img src="frame.png" alt="PayPal QR-Code">
    <div style="display:flex; justify-content:flex-end; margin-top:10px">
      <button class="btn" onclick="closeQR()">SchlieÃŸen</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
  const CORE = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];

  const firebaseConfig = {
    apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",
    authDomain:"sickandsound-e9704.firebaseapp.com",
    projectId:"sickandsound-e9704",
    storageBucket:"sickandsound-e9704.firebasestorage.app",
    messagingSenderId:"248197359659",
    appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",
    measurementId:"G-62LH8V7S2E"
  };
  let db=null;
  try{ if(window.firebase){ firebase.initializeApp(firebaseConfig); try{firebase.analytics();}catch(_){} db=firebase.firestore(); } }catch(_){ db=null; }

  const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";
  const K = { people:"sick_sound_people", prices:"sick_sound_prices", data:"sick_sound_data" };

  /* ---------- Level / XP ---------- */
  // 1 Strich = 1 XP; alle 10 XP = +1 Level (Level 1 startet bei 0â€“9)
  function levelFromXP(xp){ return Math.floor(xp/10)+1; }
  function progressToNext(xp){
    const pct = (xp % 10) / 10; // 0..1
    return Math.max(0, Math.min(1, pct));
  }

  /* ---------- UI Helpers ---------- */
  function â‚¬(v){ return Number(v||0).toFixed(2).replace('.', ','); }
  function sumCounts(person, prices, data){
    let total = 0, euro = 0;
    Object.keys(prices||{}).forEach(key=>{
      const c = data[`${person}_${key}`] || 0;
      total += c;
      euro  += c * (prices[key]||0);
    });
    return { total, euro };
  }

  function buildRingSVG(pct){
    const R=24, C=2*Math.PI*R, off = C*(1-pct);
    return `
      <svg class="ring" width="60" height="60" viewBox="0 0 60 60">
        <defs>
          <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#6ee7ff"/><stop offset="100%" stop-color="#a78bfa"/>
          </linearGradient>
        </defs>
        <circle class="bg" cx="30" cy="30" r="${R}" />
        <circle class="fg" cx="30" cy="30" r="${R}" stroke-dasharray="${C}" stroke-dashoffset="${off}" />
      </svg>`;
  }

  function personRowHTML(person, prices, data){
    const {total} = sumCounts(person, prices, data);
    const lvl  = levelFromXP(total);
    const pct  = progressToNext(total);

    const drinks = Object.keys(prices||{}).map(key=>{
      const amount = data[`${person}_${key}`] || 0;
      return `
        <div class="pill">
          <div class="amount" id="amt_${person}_${key}">${amount}</div>
          <div class="label">${key}</div>
          <button class="add" onclick="add('${person}','${key}')">+1</button>
        </div>`;
    }).join("");

    return `
      <div class="row" id="row_${person}">
        <div class="avatar">
          ${buildRingSVG(pct)}
          <div class="lvl">Lvl ${lvl}</div>
        </div>
        <div>
          <div class="name">${person}</div>
          <div class="drinks">${drinks}</div>
        </div>
        <div style="text-align:right; font-weight:800; min-width:70px" id="sum_${person}">â‚¬ ${â‚¬(sumCounts(person, prices, data).euro)}</div>
      </div>`;
  }

  /* ---------- State ---------- */
  let state = { people:[], prices:{}, data:{} };
  let lastAction = null; // {person, drink}

  async function loadState(){
    let sLocal = {
      people: JSON.parse(localStorage.getItem(K.people)||"[]"),
      prices: JSON.parse(localStorage.getItem(K.prices)||"{}"),
      data  : JSON.parse(localStorage.getItem(K.data)||"{}")
    };
    if(db){
      try{
        const snap = await db.collection(STATE_COLLECTION).doc("global").get();
        if(snap.exists){
          const remote = snap.data();
          state.people = remote.people || sLocal.people;
          state.prices = remote.prices || sLocal.prices;
          state.data   = remote.data   || sLocal.data;
        }else{
          state = sLocal;
        }
      }catch(_){ state = sLocal; }
    }else{
      state = sLocal;
    }
  }

  function saveStateDebounced(){
    localStorage.setItem(K.people, JSON.stringify(state.people||[]));
    localStorage.setItem(K.prices, JSON.stringify(state.prices||{}));
    localStorage.setItem(K.data,   JSON.stringify(state.data||{}));
    if(!db) return;
    if(saveStateDebounced._t) clearTimeout(saveStateDebounced._t);
    saveStateDebounced._t = setTimeout(()=> {
      db.collection(STATE_COLLECTION).doc("global").set(state, {merge:true});
    }, 350);
  }

  function splitCoreGuests(all){
    const core = [], guests=[];
    (all||[]).forEach(p=> (CORE.includes(p) ? core : guests).push(p));
    // Feste Reihenfolge im Kernteam
    core.sort((a,b)=> CORE.indexOf(a)-CORE.indexOf(b));
    guests.sort((a,b)=> a.localeCompare(b));
    return {core, guests};
  }

  function render(){
    const wrapCore  = document.getElementById("coreList");
    const wrapGuest = document.getElementById("guestList");
    const {core, guests} = splitCoreGuests(state.people);

    wrapCore.innerHTML  = core.map(p=>personRowHTML(p, state.prices, state.data)).join("");
    wrapGuest.innerHTML = guests.map(p=>personRowHTML(p, state.prices, state.data)).join("");
  }

  /* ---------- Aktionen ---------- */
  function add(person, drink){
    const key = `${person}_${drink}`;
    state.data[key] = (state.data[key]||0) + 1;
    lastAction = {person, drink};
    updatePerson(person);
    saveStateDebounced();
  }

  function undo(){
    if(!lastAction) return;
    const key = `${lastAction.person}_${lastAction.drink}`;
    const cur = state.data[key]||0;
    if(cur>0){ state.data[key]=cur-1; updatePerson(lastAction.person); saveStateDebounced(); }
    lastAction = null;
  }

  function updatePerson(person){
    // Betragsanzeige
    const sum = sumCounts(person, state.prices, state.data).euro;
    const sumEl = document.getElementById(`sum_${person}`);
    if(sumEl) sumEl.textContent = `â‚¬ ${â‚¬(sum)}`;
    // GetrÃ¤nkecounter
    Object.keys(state.prices||{}).forEach(dr=>{
      const el=document.getElementById(`amt_${person}_${dr}`);
      if(el) el.textContent = state.data[`${person}_${dr}`]||0;
    });
    // Level-Ring neu berechnen
    const total = sumCounts(person, state.prices, state.data).total;
    const lvl = levelFromXP(total), pct=progressToNext(total);
    const row=document.getElementById(`row_${person}`);
    if(row){
      const ring = row.querySelector('.ring .fg');
      const R=24, C=2*Math.PI*R, off = C*(1-pct);
      if(ring){ ring.setAttribute('stroke-dasharray', C); ring.setAttribute('stroke-dashoffset', off); }
      const lv=row.querySelector('.lvl'); if(lv) lv.textContent = `Lvl ${lvl}`;
    }
  }

  /* ---------- QR Modal ---------- */
  const qrModal = document.getElementById('qrModal');
  document.getElementById('qrBtn').addEventListener('click', ()=>{ qrModal.classList.add('open'); });
  function closeQR(){ qrModal.classList.remove('open'); }

  document.getElementById('undoBtn').addEventListener('click', undo);

  /* ---------- Init ---------- */
  async function init(){
    await loadState();

    // Fallback: falls noch keine Personen/Preise vorhanden sind
    if(!state.people || !state.people.length){
      state.people = [...CORE]; // Kernteam als Start
    }
    if(!state.prices || !Object.keys(state.prices).length){
      // Standardpreise (kannst du spÃ¤ter in buchungen.html anpassen)
      state.prices = { "Bier":2.0, "Mate":1.5, "Wasser":1.0 };
    }
    state.data = state.data || {};

    render();

    // Live-Updates von Firestore
    if(db){
      try{
        firebase.firestore().collection(STATE_COLLECTION).doc("global")
          .onSnapshot(snap=>{
            if(!snap.exists) return;
            const r=snap.data()||{};
            state.people = r.people || state.people;
            state.prices = r.prices || state.prices;
            state.data   = r.data   || state.data;
            render();
          });
      }catch(_){}
    }
  }
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  init();
</script>
</body>
</html>
