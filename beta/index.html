<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    .appbar .app-title h1 { font-size: 18px; }
    .people-section { margin-top: 10px; }
    .section-title { margin-bottom: 6px; }

    .row {
      display: grid;
      grid-template-columns: 64px 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 14px;
      background: #0f1420;
      border: 1px solid #1f2538;
      margin-bottom: 6px;
    }
    .name { font-size: 18px; font-weight: 800; letter-spacing: .2px; }

    /* Level-Ring */
    .avatar { position: relative; width: 56px; height: 56px; display: grid; place-items: center; }
    .ring { position:absolute; inset:-2px; transform: rotate(-90deg); }
    .ring circle { fill:none; stroke-width:6; stroke-linecap:round; }
    .ring .bg { stroke:#22304a; }
    .ring .fg { stroke:url(#grad); transition:stroke-dashoffset .25s ease; }
    .lvl { font-size:12px; font-weight:800; color:#aab3cf; position:absolute; bottom:-2px; left:0; right:0; text-align:center; }

    /* Getr√§nke ‚Äì jetzt EINZEILIG + SCROLLBAR (konstante H√∂he) */
    .drinks {
      display:flex; gap:8px; align-items:center;
      overflow-x: auto; overflow-y: hidden; white-space: nowrap;
      padding-bottom: 4px; scrollbar-width: thin;
    }
    .pill {
      display:flex; align-items:center; gap:8px;
      padding: 8px;
      border-radius: 12px;
      background:#101626;
      border:1px solid #202a42;
      min-width: 120px;
      flex: 0 0 auto;
    }
    .pill .amount { min-width: 28px; text-align:center; font-weight:800; color:#ced5ea; }
    .pill .label { font-weight:700; }
    .pill .add {
      margin-left:auto; padding:6px 10px; border-radius:10px;
      background: linear-gradient(135deg, #6ee7ff, #a78bfa);
      color:#0b0e14; font-weight:800; border:0;
    }

    .guests .row { background:#0d111b; }
    .actions { display:flex; gap:10px; align-items:center; justify-content:space-between; margin-top:10px; }

    /* PayPal Icon */
    .icon-paypal { width:22px; height:22px; display:block; }
    .btn.dark { color:#e6e8ef; }

    /* QR Modal */
    .modal { position:fixed; inset:0; display:none; background:rgba(0,0,0,.6); z-index:50; }
    .modal.open { display:grid; place-items:center; }
    .sheet { width:min(92vw,460px); background:#0b0e14; border:1px solid #22283a; border-radius:18px; padding:14px; }
    .sheet img { width:100%; height:auto; display:block; border-radius:12px; }

    .err { color:#ffb4b4; margin:6px 0 0 2px; }
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title">
      <div class="brand-dot"></div>
      <h1>Sick &amp; Sound ‚Äì Strichliste</h1>
    </div>
    <div class="appbar-actions">
      <!-- PayPal-QR Button -->
      <button id="qrBtn" class="btn small dark" title="PayPal QR">
        <svg class="icon-paypal" viewBox="0 0 64 64" aria-hidden="true">
          <path d="M18 10h17c10 0 16 5 16 13s-6 13-16 13h-12l-4 18h-9L18 10z" fill="currentColor"/>
          <path d="M15 27h16c9 0 14 4 14 11s-5 11-14 11h-12l-2 9h-9l6-31z" fill="currentColor" opacity=".55"/>
        </svg>
        <span class="sr-only">PayPal QR</span>
      </button>
      <a class="btn small dark" href="hausdienst.html" title="Hausdienst">üßπ</a>
      <a class="btn small dark" href="rangliste.html" title="Rang">üìä</a>
      <a class="btn small dark" href="badges.html" title="Badges">üèÖ</a>
    </div>
  </header>

  <main class="content">
    <div id="err" class="err"></div>

    <!-- Kernteam -->
    <section class="people-section" id="coreWrap">
      <div class="section-title">Kernteam</div>
      <div id="coreList"></div>
    </section>

    <!-- G√§ste -->
    <section class="people-section guests" id="guestWrap">
      <div class="section-title">G√§ste</div>
      <div id="guestList"></div>
    </section>

    <div class="actions">
      <button id="undoBtn" class="btn ghost">‚Ü©Ô∏é Letzte Aktion r√ºckg√§ngig</button>
      <a class="btn secondary" href="buchungen.html">üìÑ Buchungen</a>
    </div>
  </main>

  <nav class="bottomnav">
    <a class="tab active" href="index.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab" href="hausdienst.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="badges.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg>
      <span>Badges</span>
    </a>
    <a class="tab" href="buchungen.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- QR Modal -->
<div id="qrModal" class="modal" role="dialog" aria-modal="true" aria-label="PayPal QR">
  <div class="sheet">
    <img src="frame.png" alt="PayPal QR-Code">
    <div style="display:flex; justify-content:flex-end; margin-top:10px">
      <button class="btn" onclick="closeQR()">Schlie√üen</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
  const CORE = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];

  const firebaseConfig = {
    apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",
    authDomain:"sickandsound-e9704.firebaseapp.com",
    projectId:"sickandsound-e9704",
    storageBucket:"sickandsound-e9704.firebasestorage.app",
    messagingSenderId:"248197359659",
    appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",
    measurementId:"G-62LH8V7S2E"
  };
  let db=null;
  try{ if(window.firebase){ firebase.initializeApp(firebaseConfig); try{firebase.analytics();}catch(_){} db=firebase.firestore(); } }catch(_){ db=null; }

  const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";
  const K = { people:"sick_sound_people", prices:"sick_sound_prices", data:"sick_sound_data", xp:"sick_sound_xp" };

  /* ---------- Level / XP ---------- */
  function levelFromXP(xp){ return Math.floor(xp/10)+1; }
  function progressToNext(xp){ return Math.max(0, Math.min(1, (xp%10)/10 )); }
  function totalDrinkXP(person){ return Object.keys(state.prices||{}).reduce((a,d)=>a+(state.data[`${person}_${d}`]||0),0); }
  function bonusXP(person){ return (state.xp && state.xp[person])||0; }
  function totalXP(person){ return totalDrinkXP(person)+bonusXP(person); }

  /* ---------- Helpers ---------- */
  function euro(v){ return Number(v||0).toFixed(2).replace('.', ','); }
  const dedupe = arr => Array.from(new Set(arr.filter(Boolean)));
  function unionCore(people){ return dedupe([...CORE, ...(people||[])]); }
  function splitCoreGuests(all){
    const set=new Set(all||[]);
    const core=CORE.filter(n=>set.has(n));
    const guests=[...set].filter(n=>!CORE.includes(n)).sort((a,b)=>a.localeCompare(b));
    return {core, guests};
  }

  // Preise k√∂nnen Zahl ODER Objekt sein: {price, enabled=true, order=?}
  function normalizePrices(prices){
    const out=[];
    Object.entries(prices||{}).forEach(([name,val])=>{
      if(val==null) return;
      if(typeof val === 'number'){
        out.push({ name, price: val, enabled: true, order: 999 });
      }else{
        out.push({
          name,
          price: Number(val.price ?? 0),
          enabled: (val.enabled !== false),
          order: Number(val.order ?? 999)
        });
      }
    });
    // nur aktivierte anzeigen
    return out.filter(d=>d.enabled).sort((a,b)=>a.order-b.order || a.name.localeCompare(b.name));
  }

  function sumEuro(person, prices, data){
    return normalizePrices(prices).reduce((sum,d)=> sum + ((data[`${person}_${d.name}`]||0) * (d.price||0)), 0);
  }

  /* ---------- Ring ---------- */
  function buildRingSVG(pct){
    const R=24, C=2*Math.PI*R, off = C*(1-pct);
    return `
      <svg class="ring" width="60" height="60" viewBox="0 0 60 60">
        <defs>
          <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#6ee7ff"/><stop offset="100%" stop-color="#a78bfa"/>
          </linearGradient>
        </defs>
        <circle class="bg" cx="30" cy="30" r="${R}"/>
        <circle class="fg" cx="30" cy="30" r="${R}" stroke-dasharray="${C}" stroke-dashoffset="${off}"/>
      </svg>`;
  }

  function personRowHTML(person, prices, data){
    const xp  = totalXP(person);
    const lvl = levelFromXP(xp), pct = progressToNext(xp);

    const drinks = normalizePrices(prices).map(d=>{
      const amount = data[`${person}_${d.name}`] || 0;
      return `<div class="pill">
        <div class="amount" id="amt_${person}_${d.name}">${amount}</div>
        <div class="label">${d.name}</div>
        <button class="add" onclick="add('${person}','${d.name}')">+1</button>
      </div>`;
    }).join("");

    return `<div class="row" id="row_${person}" data-lvl="${lvl}">
      <div class="avatar">${buildRingSVG(pct)}<div class="lvl">Lvl ${lvl}</div></div>
      <div><div class="name">${person}</div><div class="drinks">${drinks}</div></div>
      <div style="text-align:right;font-weight:800;min-width:70px" id="sum_${person}">‚Ç¨ ${euro(sumEuro(person, prices, data))}</div>
    </div>`;
  }

  /* ---------- Level-Up Effekte ---------- */
  let audioCtx=null;
  function playLevelUp(){
    try{
      audioCtx = audioCtx || new (window.AudioContext||window.webkitAudioContext)();
      const o=audioCtx.createOscillator(), g=audioCtx.createGain();
      o.type="triangle"; o.frequency.setValueAtTime(440,audioCtx.currentTime);
      o.frequency.exponentialRampToValueAtTime(880,audioCtx.currentTime+0.25);
      g.gain.setValueAtTime(0.0001,audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.2,audioCtx.currentTime+0.03);
      g.gain.exponentialRampToValueAtTime(0.0001,audioCtx.currentTime+0.30);
      o.connect(g).connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+0.32);
    }catch(_){}
  }
  function confettiAt(el){
    const n=24, box=el.getBoundingClientRect();
    for(let i=0;i<n;i++){
      const c=document.createElement('div');
      c.style.cssText=`position:fixed;left:${box.left+box.width/2}px;top:${box.top+8}px;width:6px;height:6px;border-radius:2px;background: hsl(${Math.random()*360} 90% 60%);opacity:.9;pointer-events:none;z-index:99;transform:translate(-50%,-50%);`;
      document.body.appendChild(c);
      const dx=(Math.random()-0.5)*240, dy=(Math.random()*-160)-40, rot=(Math.random()*360);
      c.animate([
        {transform:`translate(-50%,-50%) rotate(0deg)`, opacity:1},
        {transform:`translate(${dx}px, ${dy}px) rotate(${rot}deg)`, opacity:0}
      ],{duration:700+Math.random()*300, easing:'cubic-bezier(.22,1,.36,1)'}).onfinish=()=>c.remove();
    }
  }

  /* ---------- State ---------- */
  let state = { people:[], prices:{}, data:{}, xp:{} };
  let lastAction = null;

  async function loadState(){
    const local = {
      people: JSON.parse(localStorage.getItem(K.people)||"[]"),
      prices: JSON.parse(localStorage.getItem(K.prices)||"{}"),
      data  : JSON.parse(localStorage.getItem(K.data)||"{}"),
      xp    : JSON.parse(localStorage.getItem(K.xp)||"{}"),
    };

    // Fallback lokal
    state.people = unionCore(local.people && local.people.length ? local.people : CORE);
    state.prices = (local.prices && Object.keys(local.prices).length) ? local.prices : {"Bier":2.0,"Mate":1.5,"Wasser":1.0};
    state.data   = local.data || {};
    state.xp     = local.xp || {};

    // Remote mergen ‚Äì aber NIE leere Werte √ºbernehmen
    if(db){
      try{
        const snap = await db.collection(STATE_COLLECTION).doc("global").get();
        if(snap.exists){
          const r=snap.data()||{};
          if(Array.isArray(r.people) && r.people.length) state.people = unionCore(r.people);
          if(r.prices && Object.keys(r.prices).length)   state.prices = r.prices;
          if(r.data)                                     state.data   = r.data;
          if(r.xp)                                       state.xp     = r.xp;
        }
      }catch(e){ document.getElementById('err').textContent = "Hinweis: Cloud-State konnte nicht vollst√§ndig geladen werden."; }
    }
  }

  function persistLocal(){
    localStorage.setItem(K.people, JSON.stringify(state.people||[]));
    localStorage.setItem(K.prices, JSON.stringify(state.prices||{}));
    localStorage.setItem(K.data,   JSON.stringify(state.data||{}));
    localStorage.setItem(K.xp,     JSON.stringify(state.xp||{}));
  }
  function saveCloudDebounced(){
    persistLocal();
    if(!db) return;
    clearTimeout(saveCloudDebounced._t);
    saveCloudDebounced._t = setTimeout(()=> {
      db.collection(STATE_COLLECTION).doc("global").set(state,{merge:true});
    }, 350);
  }

  function render(){
    const wrapCore  = document.getElementById("coreList");
    const wrapGuest = document.getElementById("guestList");
    const {core, guests} = splitCoreGuests(state.people);

    if(!core.length && !guests.length){
      document.getElementById('err').textContent = "Keine Personen gefunden ‚Äì ich zeige dir das Kernteam, sobald Daten da sind.";
    }else{
      document.getElementById('err').textContent = "";
    }

    wrapCore.innerHTML  = core.map(p=>personRowHTML(p, state.prices, state.data)).join("");
    wrapGuest.innerHTML = guests.map(p=>personRowHTML(p, state.prices, state.data)).join("");
  }

  /* ---------- Aktionen ---------- */
  function add(person, drink){
    const key = `${person}_${drink}`;
    state.data[key] = (state.data[key]||0) + 1;
    lastAction = {person, drink};

    // Level-Up Check (vor/nach)
    const row = document.getElementById(`row_${person}`);
    const prevLvl = Number(row?.dataset.lvl||"0");

    updatePerson(person);

    const newLvl = Number(document.getElementById(`row_${person}`)?.dataset.lvl||prevLvl);
    if(newLvl>prevLvl){ playLevelUp(); if(row) confettiAt(row); }

    saveCloudDebounced();
  }
  function undo(){
    if(!lastAction) return;
    const key = `${lastAction.person}_${lastAction.drink}`;
    const cur = state.data[key]||0;
    if(cur>0){
      const row = document.getElementById(`row_${lastAction.person}`);
      const prevLvl = Number(row?.dataset.lvl||"0");

      state.data[key]=cur-1; updatePerson(lastAction.person);

      const newLvl = Number(document.getElementById(`row_${lastAction.person}`)?.dataset.lvl||prevLvl);
      // kein Level-Down Effekt n√∂tig
      saveCloudDebounced();
    }
    lastAction = null;
  }

  function updatePerson(person){
    // ‚Ç¨-Summe
    const sum = sumEuro(person, state.prices, state.data);
    const sumEl = document.getElementById(`sum_${person}`); if(sumEl) sumEl.textContent = `‚Ç¨ ${euro(sum)}`;
    // Getr√§nkecounter
    normalizePrices(state.prices).forEach(d=>{
      const el=document.getElementById(`amt_${person}_${d.name}`); if(el) el.textContent = state.data[`${person}_${d.name}`]||0;
    });
    // Level/Ring
    const xp = totalXP(person);
    const lvl = levelFromXP(xp), pct=progressToNext(xp);
    const row=document.getElementById(`row_${person}`);
    if(row){
      const R=24, C=2*Math.PI*R, off=C*(1-pct);
      const fg=row.querySelector('.ring .fg'); if(fg){ fg.setAttribute('stroke-dasharray', C); fg.setAttribute('stroke-dashoffset', off); }
      const lv=row.querySelector('.lvl'); if(lv) lv.textContent = `Lvl ${lvl}`;
      row.dataset.lvl = String(lvl);
    }
  }

  /* ---------- QR Modal ---------- */
  const qrModal = document.getElementById('qrModal');
  document.getElementById('qrBtn').addEventListener('click', ()=>{ qrModal.classList.add('open'); });
  function closeQR(){ qrModal.classList.remove('open'); }

  document.getElementById('undoBtn').addEventListener('click', undo);

  /* ---------- Init ---------- */
  async function init(){
    await loadState();
    render();

    // Live-Updates aus der Cloud ‚Äì leere Werte werden ignoriert
    if(db){
      try{
        db.collection(STATE_COLLECTION).doc("global").onSnapshot(snap=>{
          if(!snap.exists) return;
          const r=snap.data()||{};
          const prev = {...state};
          if(Array.isArray(r.people) && r.people.length) state.people = unionCore(r.people);
          if(r.prices && Object.keys(r.prices).length)   state.prices = r.prices;
          if(r.data)                                     state.data   = r.data;
          if(r.xp)                                       state.xp     = r.xp;
          if(JSON.stringify(prev)!==JSON.stringify(state)) render();
        });
      }catch(e){ document.getElementById('err').textContent = "Live-Update deaktiviert."; }
    }
  }
  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  init();
</script>
</body>
</html>
