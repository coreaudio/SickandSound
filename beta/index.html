<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound ‚Äì Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
</head>
<body>
  <div class="container">

    <!-- Kopf: Tagesstatus Hausdienst + Challenge -->
    <div class="card">
      <h1>ü•§ Sick & Sound</h1>
      <div class="sub" id="todayInfo">Lade Tagesstatus‚Ä¶</div>
      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
        <button class="btn small" onclick="openHausdienst()">üè† Hausdienst planen</button>
        <button class="btn small secondary" onclick="window.location='rangliste.html'">üèÜ Ranglisten</button>
        <button class="btn small dark" onclick="togglePayPal()">üí∏ PayPal</button>
      </div>
    </div>

    <!-- Tabelle -->
    <div class="card table-wrap" id="tableContainer"></div>

    <!-- Fu√üleiste -->
    <div class="footer">
      <button class="btn" onclick="openDrinkModal()">‚ûï Getr√§nk</button>
      <button class="btn warning" onclick="undoLast()">‚Ü© R√ºckg√§ngig</button>
      <button class="btn danger" id="deleteBtn" onclick="toggleDeleteMode()">üóë L√∂schen</button>
      <button class="btn dark" onclick="resetAll()">‚ôª Abrechnen & zur√ºcksetzen</button>
      <button class="btn ghost" onclick="window.location='buchungen.html'">üìñ Buchungen</button>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal" id="paypalModal" onclick="togglePayPal()">
    <img class="qr" src="frame.png" alt="PayPal QR">
  </div>

  <div class="modal" id="personModal">
    <div class="box">
      <h2>‚ûï Person hinzuf√ºgen</h2>
      <input id="personName" placeholder="Name eintippen" />
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn" onclick="confirmAddPerson()">Speichern</button>
        <button class="btn dark" onclick="closeModal('personModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <div class="modal" id="drinkModal">
    <div class="box">
      <h2>ü•§ Getr√§nk hinzuf√ºgen</h2>
      <input id="drinkName" placeholder="Name des Getr√§nks">
      <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (‚Ç¨)">
      <div style="display:flex;gap:10px;margin-top:10px">
        <button class="btn" onclick="confirmAddDrink()">Speichern</button>
        <button class="btn dark" onclick="closeModal('drinkModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Firebase + Howler (Sound) -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>

  <script>
  /* ===== Firebase ===== */
  const firebaseConfig = {
    apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",
    authDomain:"sickandsound-e9704.firebaseapp.com",
    projectId:"sickandsound-e9704",
    storageBucket:"sickandsound-e9704.firebasestorage.app",
    messagingSenderId:"248197359659",
    appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",
    measurementId:"G-62LH8V7S2E"
  };
  firebase.initializeApp(firebaseConfig);
  firebase.analytics();
  const db = firebase.firestore();

  /* ===== Keys & Default State ===== */
  const pricesKey="sick_sound_prices", peopleKey="sick_sound_people", dataKey="sick_sound_data",
        historyKey="sick_sound_history", bookingsKey="sick_sound_bookings", orderKey="sick_sound_order",
        xpKey="sick_sound_xp";
  let prices={"Cola_Zero":1.0,"Monster":1.5,"Wasser":0.5,"Kaffee":1.0,"Mittagessen":6.0};
  let people=[], data={}, history=[], bookings=[], columnOrder=Object.keys(prices);
  let xp = {}; // Gamification XP je Person

  /* ===== Sounds ===== */
  const sClick = new Howl({src:["https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/coin1.wav"]});
  const sLevel = new Howl({src:["https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/powerUp5.wav"]});

  /* ===== Helpers ===== */
  const todayStr = ()=> new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const levelOf = (x)=> Math.floor(Math.sqrt(x/20))+1; // einfache Levelkurve

  /* ===== Load State (Firestore -> Fallback localStorage) ===== */
  async function loadState(){
    try{
      const snap = await db.collection("state").doc("global").get();
      if(snap.exists){
        const s=snap.data();
        prices=s.prices||prices; people=s.people||JSON.parse(localStorage.getItem(peopleKey))||[];
        data=s.data||data; history=s.history||history; bookings=s.bookings||bookings;
        columnOrder=s.columnOrder||Object.keys(prices); xp=s.xp||xp;
      }else{
        people=JSON.parse(localStorage.getItem(peopleKey))||[];
      }
    }catch(e){
      prices=JSON.parse(localStorage.getItem(pricesKey))||prices;
      people=JSON.parse(localStorage.getItem(peopleKey))||[];
      data=JSON.parse(localStorage.getItem(dataKey))||data;
      history=JSON.parse(localStorage.getItem(historyKey))||history;
      bookings=JSON.parse(localStorage.getItem(bookingsKey))||bookings;
      columnOrder=JSON.parse(localStorage.getItem(orderKey))||Object.keys(prices);
      xp=JSON.parse(localStorage.getItem(xpKey))||xp;
    }
    buildTable();
    updateTodayBanner();
    subscribeRealtime();
  }

  function saveAll(){
    localStorage.setItem(pricesKey,JSON.stringify(prices));
    localStorage.setItem(peopleKey,JSON.stringify(people));
    localStorage.setItem(dataKey,JSON.stringify(data));
    localStorage.setItem(historyKey,JSON.stringify(history));
    localStorage.setItem(bookingsKey,JSON.stringify(bookings));
    localStorage.setItem(orderKey,JSON.stringify(columnOrder));
    localStorage.setItem(xpKey,JSON.stringify(xp));
    db.collection("state").doc("global").set({prices,people,data,history,bookings,columnOrder,xp},{merge:true});
  }

  function subscribeRealtime(){
    db.collection("state").doc("global").onSnapshot(snap=>{
      if(!snap.exists) return;
      const s=snap.data();
      prices=s.prices||prices; people=s.people||people; data=s.data||data;
      history=s.history||history; bookings=s.bookings||bookings; columnOrder=s.columnOrder||columnOrder; xp=s.xp||xp;
      buildTable(); updateTodayBanner();
    });

    // heutiger Hausdienst (tagesgebunden in eigener Collection)
    db.collection("hausdienst").doc(todayStr()).onSnapshot(doc=>{
      updateTodayBanner(doc.exists ? doc.data().person : null);
    });

    // Tages-Challenge
    db.collection("challenges").doc(todayStr()).onSnapshot(doc=>{
      renderChallenge(doc.exists?doc.data():null);
    });
  }

  /* ===== UI: Tagesbanner & Challenge ===== */
  async function updateTodayBanner(personCached){
    let person = personCached;
    if(person===undefined){
      const d=await db.collection("hausdienst").doc(todayStr()).get();
      person = d.exists ? d.data().person : null;
    }
    const el=document.getElementById("todayInfo");
    if(person){
      el.innerHTML = `Heute eingetragener Hausdienst: <span class="badge ok">${person}</span> ¬∑ <a href="hausdienst_checklist.html" class="badge gold" style="text-decoration:none">Checkliste √∂ffnen</a>`;
    }else{
      el.innerHTML = `Heute: <span class="badge none">Noch niemand eingetragen</span>`;
    }

    // Challenge initialisieren, falls heute noch keine existiert
    const cDoc = db.collection("challenges").doc(todayStr());
    const cur = await cDoc.get();
    if(!cur.exists){
      const pool = [
        {type:"drink", drink:"Wasser", count:3, bonus:20, text:"Trinke heute 3√ó Wasser (Bonus 20 XP)"},
        {type:"drink", drink:"Kaffee", count:2, bonus:15, text:"2√ó Kaffee heute (Bonus 15 XP)"},
        {type:"generic", bonus:25, text:"Heute Hausdienst √ºbernehmen (Bonus 25 XP)"}
      ];
      await cDoc.set(pool[Math.floor(Math.random()*pool.length)]);
    }
  }

  function renderChallenge(c){
    const banner = document.getElementById("todayInfo");
    if(!c) return;
    banner.insertAdjacentHTML("beforeend", `<div class="sub" style="margin-top:6px">üéØ Tages-Challenge: ${c.text}</div>`);
  }

  function openHausdienst(){ window.location='hausdienst.html'; }

  /* ===== Table ===== */
  function buildTable(){
    people.sort((a,b)=>a.localeCompare(b));
    let html = `<table><thead><tr><th>Person</th>`;
    columnOrder.forEach(drink=>{
      if(prices[drink]!==undefined){
        html += `<th>${drink.replace('_',' ')}<br><span class="sub">${prices[drink]}‚Ç¨</span><br><button class="btn small ghost" onclick="deleteColumn('${drink}')">L√∂schen</button></th>`;
      }
    });
    html += `<th>Gesamt (‚Ç¨)</th><th>Level</th></tr></thead><tbody>`;

    people.forEach(p=>{
      html += `<tr><th onclick="deletePerson('${p}')">${p}</th>`;
      columnOrder.forEach(drink=>{
        if(prices[drink]!==undefined){
          const id = `${p}_${drink}`, val=data[id]||0;
          html += `<td>
            <div class="cell-mark" id="${id}">${val}</div>
            <button class="btn small" onclick="changeValue('${id}',1,'${drink}', '${p}')">+1</button>
          </td>`;
        }
      });
      const total = columnOrder.reduce((s,d)=>s+(data[`${p}_${d}`]||0)*prices[d],0);
      const xpVal = xp[p]||0;
      html += `<td id="${p}_Total">${total.toFixed(2)}</td>
               <td id="${p}_Level">Lv. ${levelOf(xpVal)} <span class="sub">(${xpVal} XP)</span></td></tr>`;
    });
    html += `</tbody></table>
             <div class="add-row" onclick="openPersonModal()">‚ûï Person hinzuf√ºgen</div>`;
    document.getElementById("tableContainer").innerHTML = html;
  }

  function changeValue(id,delta,drink,person){
    const el=document.getElementById(id);
    const cur=parseInt(el.textContent||'0');
    const next=Math.max(0, cur+delta);
    history.push({id,prev:cur,action:"change"});
    data[id]=next; el.textContent=next;

    // XP: 1 XP pro Euro
    const addXp = prices[drink]||0;
    xp[person] = (xp[person]||0) + addXp;
    const before = levelOf((xp[person]||0)-addXp), after = levelOf(xp[person]);
    if(after>before) sLevel.play(); else sClick.play();

    // Challenge pr√ºfen (vereinfachte Logik)
    db.collection("challenges").doc(todayStr()).get().then(doc=>{
      if(!doc.exists) return;
      const c=doc.data();
      if(c.type==="drink" && c.drink===drink){
        // Summe der heutigen Drinks dieses Typs √ºber alle Nutzer
        const totalToday = people.reduce((sum,p)=>{
          const key=`${p}_${drink}`;
          return sum + (data[key]||0);
        },0);
        if(totalToday>=c.count && !c.done){
          c.done=true; db.collection("challenges").doc(todayStr()).set(c,{merge:true});
          // Bonus XP f√ºr alle die mitgemacht haben (einfacher: top 3 bekommen)
          people.slice(0,3).forEach(name=>{ xp[name]=(xp[name]||0)+c.bonus; });
          sLevel.play();
          alert(`üéâ Challenge geschafft! +${c.bonus} XP f√ºr die Top 3.`);
        }
      }
    });

    updateTotalsFor(id.split('_')[0]);
    saveAll();
  }

  function updateTotalsFor(person){
    const tot = columnOrder.reduce((s,d)=>s+(data[`${person}_${d}`]||0)*prices[d],0);
    document.getElementById(`${person}_Total`).textContent=tot.toFixed(2);
    document.getElementById(`${person}_Level`).innerHTML=`Lv. ${levelOf(xp[person]||0)} <span class="sub">(${(xp[person]||0)} XP)</span>`;
  }

  function undoLast(){
    const last=history.pop(); if(!last) return;
    if(last.action==="change"){ data[last.id]=last.prev; document.getElementById(last.id).textContent=last.prev; }
    saveAll(); buildTable();
  }

  function resetAll(){
    const pw = prompt("Passwort eingeben:"); if(pw!=="1379"){alert("Falsches Passwort");return;}
    if(!confirm("Alle Striche abrechnen und zur√ºcksetzen?")) return;
    people.forEach(person=>{
      const sum=parseFloat(document.getElementById(`${person}_Total`).textContent||"0");
      if(sum>0) bookings.push({date:new Date().toLocaleDateString("de-DE"), person, sum});
      // XP: je 1‚Ç¨ nochmal XP (damit Abrechnung nicht XP l√∂scht)
      xp[person]=(xp[person]||0)+sum;
      columnOrder.forEach(d=>data[`${person}_${d}`]=0);
    });
    saveAll(); buildTable();
  }

  function openPersonModal(){ document.getElementById("personModal").classList.add("show"); }
  function openDrinkModal(){ document.getElementById("drinkModal").classList.add("show"); }
  function closeModal(id){ document.getElementById(id).classList.remove("show"); }
  function togglePayPal(){ document.getElementById("paypalModal").classList.toggle("show"); }
  function confirmAddPerson(){
    const name=document.getElementById("personName").value.trim();
    if(!name) return alert("Bitte Namen eingeben");
    if(people.includes(name)) return alert("Person existiert bereits");
    people.push(name); saveAll(); buildTable(); closeModal('personModal');
    document.getElementById("personName").value="";
  }
  function confirmAddDrink(){
    const name=document.getElementById("drinkName").value.trim(),
          price=parseFloat(document.getElementById("drinkPrice").value);
    if(!name||isNaN(price)||price<=0) return alert("Bitte g√ºltige Eingaben");
    const key=name.replace(/\s+/g,'_'); prices[key]=price;
    if(!columnOrder.includes(key)) columnOrder.push(key);
    saveAll(); buildTable(); closeModal('drinkModal');
    document.getElementById("drinkName").value=""; document.getElementById("drinkPrice").value="";
  }

  // Deletion (Soft-guard)
  let deleteMode=false;
  function toggleDeleteMode(){
    deleteMode=!deleteMode; const btn=document.getElementById("deleteBtn");
    btn.textContent = deleteMode ? "‚ùå Abbrechen" : "üóë L√∂schen";
    btn.classList.toggle("ghost", deleteMode);
  }
  function deletePerson(p){
    if(!deleteMode) return; if(!confirm(`${p} wirklich l√∂schen?`)) return;
    people=people.filter(x=>x!==p); saveAll(); buildTable(); toggleDeleteMode();
  }
  function deleteColumn(drink){
    if(!deleteMode) return; if(!confirm(`Getr√§nk "${drink}" l√∂schen?`)) return;
    delete prices[drink]; columnOrder=columnOrder.filter(d=>d!==drink); saveAll(); buildTable(); toggleDeleteMode();
  }

  window.onload = loadState;
  </script>
</body>
</html>
