<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound ‚Äì Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    :root{ --ring: 48px; --row-pad: 6px; --name-size: 18px; --count-size: 17px; --cell-gap: 10px; }
    .content{ padding-bottom: 88px; }
    .appbar{ min-height: 52px; }
    .bottomnav{ height: 64px; }
    .card.table-wrap table td, .card.table-wrap table th{ padding-top: var(--row-pad); padding-bottom: var(--row-pad); }
    .lvl-ring{ width: var(--ring); height: var(--ring); position:relative; display:inline-grid; place-items:center; }
    .lvl-ring .val{ position:absolute; font-size: 12px; font-weight: 800; line-height:1; }
    .person-cell{ display:flex; align-items:center; gap:10px; }
    .p-name{ font-size: var(--name-size); font-weight: 800; letter-spacing:.2px; }
    .drink-chip .drink-name{ font-size: 12px; }
    .drink-chip .drink-price{ font-size: 11px; opacity:.8 }
    .cell{ display:flex; align-items:center; justify-content:flex-end; gap: var(--cell-gap); }
    .count{ font-size: var(--count-size); min-width: 26px; text-align:right; }
    .plus-btn{ padding:8px 12px; }
    .section-row td{ font-size:12px; opacity:.7 }
    .guest-toggle{ margin:10px 0 -2px; display:flex; justify-content:center; }
    .guest-toggle .btn{ min-width: 200px; }
    .section-title{ font-size: 14px; }
    /* Head immer sticky (√ºberschreibt style.css) */
    thead th{position:sticky; top:0; background:linear-gradient(180deg,#141926,#101521); z-index:2}
    /* Drag-Visual */
    th[draggable="true"]{cursor:grab}
    th.drag-over{outline:2px dashed rgba(255,255,255,.3); outline-offset:-6px}
    /* kleine Helfer */
    .pill{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:#1c2130; border:1px solid #2a3042; color:#e6e8ef}
    .pill input{transform:translateY(1px)}
    .grid{display:grid; gap:10px}
  </style>
</head>
<body>
<div class="app">

  <!-- AppBar -->
  <header class="appbar">
    <div class="app-title">
      <div class="brand-dot"></div>
      <h1>Sick &amp; Sound</h1>
    </div>
    <div class="appbar-actions">
      <button class="btn small dark" onclick="togglePayPal()" title="PayPal">üí∏</button>
      <button class="btn small" onclick="openDrinkModal()" title="Getr√§nk hinzuf√ºgen">‚ûï</button>
    </div>
  </header>

  <!-- Content -->
  <main class="content">
    <div class="card" style="margin-bottom:8px">
      <div class="section-title">Heute</div>
      <div id="todayInfo" class="sub">Lade Tagesstatus‚Ä¶</div>
      <div class="cta-wrap" id="todayCta"></div>
    </div>

    <div class="card table-wrap" id="tableContainer"></div>

    <div class="card" style="margin-top:8px">
      <div class="section-title">Aktionen</div>
      <div class="footer" style="gap:8px;flex-wrap:wrap">
        <button class="btn warning" id="undoBtn" onclick="undoLast()">‚Ü© R√ºckg√§ngig</button>
        <button class="btn secondary" id="redoBtn" onclick="redoLast()">‚Ü™ Wiederholen</button>
        <button class="btn danger" id="deleteBtn" onclick="toggleDeleteMode()">üóë L√∂schen</button>
        <button class="btn dark" onclick="openResetModal()">‚ôª Abrechnen & zur√ºcksetzen</button>
        <button class="btn ghost" onclick="window.location='buchungen.html'">üìñ Buchungen</button>
      </div>
    </div>
  </main>

  <!-- BottomNav -->
  <nav class="bottomnav">
    <a class="tab active" href="index.html" aria-label="Strichliste">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab" href="hausdienst.html#plan" aria-label="Hausdienst">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="rangliste.html" aria-label="Ranglisten">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="badges.html" aria-label="Badges">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg>
      <span>Badges</span>
    </a>
    <a class="tab" href="buchungen.html" aria-label="Buchungen">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- Modals -->
<div class="modal" id="paypalModal" onclick="togglePayPal()"><img class="qr" src="frame.png" alt="PayPal QR"></div>

<div class="modal" id="personModal"><div class="box">
  <h2>‚ûï Person hinzuf√ºgen</h2>
  <input id="personName" placeholder="Name eintippen" />
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn" onclick="confirmAddPerson()">Speichern</button>
    <button class="btn dark" onclick="closeModal('personModal')">Abbrechen</button>
  </div>
</div></div>

<div class="modal" id="drinkModal"><div class="box">
  <h2>ü•§ Getr√§nk hinzuf√ºgen</h2>
  <input id="drinkName" placeholder="Name des Getr√§nks">
  <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (‚Ç¨)">
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn" onclick="confirmAddDrink()">Speichern</button>
    <button class="btn dark" onclick="closeModal('drinkModal')">Abbrechen</button>
  </div>
</div></div>

<!-- Reset/Abrechnen Modal -->
<div class="modal" id="resetModal"><div class="box">
  <h2>‚ôª Abrechnen &amp; zur√ºcksetzen</h2>
  <div id="resetPeople" class="grid" style="margin:10px 0"></div>
  <input id="resetPassword" type="password" placeholder="Passwort">
  <div style="display:flex;gap:10px;margin-top:10px">
    <button class="btn danger" onclick="performReset()">Best√§tigen</button>
    <button class="btn dark" onclick="closeModal('resetModal')">Abbrechen</button>
  </div>
  <div class="sub" style="margin-top:6px">Nur markierte Personen werden auf 0 gesetzt.</div>
</div></div>

<!-- Firebase + Howler -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/howler@2.2.4/dist/howler.core.min.js"></script>

<script>
/* ===== Config ===== */
const CORE = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];

// ‚úÖ Firebase-Projekt (NEU)
const firebaseConfig = {
  apiKey: "AIzaSyBtZsr4QPHQbvO2qae6MoBoxJF5dNP2vh0",
  authDomain: "sickandsound-8a15f.firebaseapp.com",
  projectId: "sickandsound-8a15f",
  storageBucket: "sickandsound-8a15f.appspot.com",
  messagingSenderId: "32138160959",
  appId: "1:32138160959:web:a65c7f4ad7d44e757fc18a"
};

let db = null;
try{
  if(window.firebase){
    firebase.initializeApp(firebaseConfig);
    try{ firebase.analytics(); }catch(_){}
    db = firebase.firestore();
    try { db.settings({ experimentalAutoDetectLongPolling:true, merge:true }); } catch(_) {}
  }
}catch(_){ db = null; }

/* Prod/Beta Toggle */
const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";

/* ===== Keys & State ===== */
const K = {
  prices:"sick_sound_prices",
  people:"sick_sound_people",
  data:"sick_sound_data",
  history:"sick_sound_history",
  bookings:"sick_sound_bookings",
  order:"sick_sound_order",
  xp:"sick_sound_xp",
  redo:"sick_sound_redo"
};
let prices={"Cola_Zero":1.0,"Monster":1.5,"Wasser":0.5,"Kaffee":1.0,"Mittagessen":6.0};
let people=[], data={}, history=[], redoStack=[], bookings=[], columnOrder=Object.keys(prices), xp={};
let deleteMode=false, hdToday=null, showGuests=false;

/* ===== Sounds ===== */
const makeSound = (src)=> (window.Howl ? new Howl({src:[src]}) : {play:()=>{}});
const sClick = makeSound("https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/coin1.wav");
const sLevel = makeSound("https://cdn.jsdelivr.net/gh/jshawl/howler-examples@master/audio/sfx/powerUp5.wav");

/* ===== Helpers ===== */
const todayStr=()=>new Date().toISOString().slice(0,10);
const euro = v => Number(v||0).toFixed(2).replace('.', ',');
function levelOf(x){ return Math.floor(Math.sqrt(x/75))+1; }
function valueOfCurrentStriche(person){
  return (columnOrder||[]).reduce((sum,d)=> sum + ((data[`${person}_${d}`]||0)*(prices[d]||0)), 0);
}
function getXpForDisplay(person){
  const base=+(xp[person]||0);
  const cur=valueOfCurrentStriche(person);
  return Math.max(base, cur);
}

/* Long-press +1 */
let holdT=null, holdI=null;
function startHold(handler){ stopHold(); handler(); holdT=setTimeout(()=>{holdI=setInterval(handler,120)},420); }
function stopHold(){ if(holdT) clearTimeout(holdT); if(holdI) clearInterval(holdI); holdT=holdI=null; }
window.onmouseup=stopHold; window.onmouseleave=stopHold;

/* Mini-Patch: 00:00 Refresh */
function scheduleMidnightRefresh(cb){
  const now=new Date(); const mid=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,2);
  setTimeout(()=>{ try{ cb(); } finally{ scheduleMidnightRefresh(cb);} }, mid-now);
}
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden){ updateTodayBanner(); buildTable(); } });

/* ===== Load ===== */
async function loadState(){
  if(db){
    try{
      const snap=await db.collection(STATE_COLLECTION).doc("global").get();
      if(snap.exists){
        const s=snap.data();
        prices=s.prices||prices; people=s.people||JSON.parse(localStorage.getItem(K.people))||[];
        data=s.data||data; history=s.history||history; redoStack=s.redoStack||JSON.parse(localStorage.getItem(K.redo))||[];
        bookings=s.bookings||bookings; columnOrder=s.columnOrder||Object.keys(prices); xp=s.xp||xp;
      }else{
        people=JSON.parse(localStorage.getItem(K.people))||[];
        redoStack=JSON.parse(localStorage.getItem(K.redo))||[];
      }
    }catch(e){ fallbackLoad(); }
  }else{ fallbackLoad(); }

  CORE.forEach(n=>{ if(!people.includes(n)) people.push(n); });

  saveAll(); buildTable(); updateTodayBanner(); subscribeRealtime(); updateUndoRedoButtons();
  await ensureXpFromExistingStricheAfterLoad();
  scheduleMidnightRefresh(()=>{ updateTodayBanner(); buildTable(); });
}
function fallbackLoad(){
  prices=JSON.parse(localStorage.getItem(K.prices))||prices;
  people=JSON.parse(localStorage.getItem(K.people))||[];
  data=JSON.parse(localStorage.getItem(K.data))||data;
  history=JSON.parse(localStorage.getItem(K.history))||history;
  redoStack=JSON.parse(localStorage.getItem(K.redo))||[];
  bookings=JSON.parse(localStorage.getItem(K.bookings))||bookings;
  columnOrder=JSON.parse(localStorage.getItem(K.order))||Object.keys(prices);
  xp=JSON.parse(localStorage.getItem(K.xp))||xp;
}

/* Migration: vorhandene Striche -> XP (ohne Doppelz√§hlung) */
async function ensureXpFromExistingStricheAfterLoad(){
  const drinks=Object.keys(prices); let changed=false;
  people.forEach(p=>{
    let x=0; drinks.forEach(d=>{ const cnt=data[`${p}_${d}`]||0; x += cnt*(prices[d]||0); });
    if((xp[p]||0) < x){ xp[p]=x; changed=true; }
  });
  if(changed){ saveAll(); buildTable(); }
}

/* Save + Realtime */
function saveAll(){
  localStorage.setItem(K.prices,JSON.stringify(prices));
  localStorage.setItem(K.people,JSON.stringify(people));
  localStorage.setItem(K.data,JSON.stringify(data));
  localStorage.setItem(K.history,JSON.stringify(history));
  localStorage.setItem(K.redo,JSON.stringify(redoStack));
  localStorage.setItem(K.bookings,JSON.stringify(bookings));
  localStorage.setItem(K.order,JSON.stringify(columnOrder));
  localStorage.setItem(K.xp,JSON.stringify(xp));
  if(db){
    db.collection(STATE_COLLECTION).doc("global").set(
      {prices,people,data,history,redoStack,bookings,columnOrder,xp},
      {merge:true}
    ).catch(()=>{});
  }
}
function subscribeRealtime(){
  if(!db) return;
  db.collection(STATE_COLLECTION).doc("global").onSnapshot(snap=>{
    if(!snap.exists) return;
    const s=snap.data();
    prices=s.prices||prices; people=s.people||people; data=s.data||data; history=s.history||history;
    redoStack=s.redoStack||redoStack; bookings=s.bookings||bookings; columnOrder=s.columnOrder||columnOrder; xp=s.xp||xp;
    CORE.forEach(n=>{ if(!people.includes(n)) people.push(n); });
    buildTable(); updateTodayBanner(); updateUndoRedoButtons();
  });
  db.collection("hausdienst").doc(todayStr()).onSnapshot(doc=>{
    hdToday = doc && doc.exists ? doc.data().person : null;
    updateTodayBanner(hdToday); buildTable();
  });
}

/* Heute-Banner + CTA */
async function updateTodayBanner(existing){
  try{
    let person=existing;
    if(person===undefined){
      if(db){
        const d=await db.collection("hausdienst").doc(todayStr()).get();
        person = d.exists ? d.data().person : null;
      }else{ person=null; }
    }
    hdToday=person;

    const infoEl=document.getElementById("todayInfo");
    const ctaEl=document.getElementById("todayCta");

    infoEl.innerHTML = person
      ? `Heute eingetragener Hausdienst: <span class="badge ok">${person}</span>`
      : `Heute: <span class="badge none">Noch niemand eingetragen</span>`;

    ctaEl.innerHTML = `
      <button class="cta-check" onclick="openChecklist()">
        <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20.3 7.7l-1.4-1.4z"/></svg>
        Checkliste √∂ffnen
      </button>
      <span class="cta-sub">Direkt zur Aufgaben√ºbersicht</span>
    `;
  }catch(e){
    document.getElementById("todayInfo").textContent="Heute: Status nicht verf√ºgbar (offline?)";
    document.getElementById("todayCta").innerHTML = `<button class="cta-check" onclick="openChecklist()">Checkliste √∂ffnen</button>`;
  }
}
function openChecklist(){ location.href = 'hausdienst.html#check'; }

/* ===== Undo/Redo ===== */
function updateUndoRedoButtons(){
  const u=document.getElementById("undoBtn"), r=document.getElementById("redoBtn");
  if(!u||!r) return; u.disabled = history.length===0; r.disabled = redoStack.length===0;
}
function applyAction(a){
  if(a.type==="inc"){
    data[a.id] = (a.prev||0) + 1;
    if(a.person){ xp[a.person] = (xp[a.person]||0) + (a.xpDelta||0); }
  } else if (a.action==="change"){
    data[a.id] = (a.prev||0) + 1;
    const parts=a.id.split('_'); const person=parts[0]; const drink=parts.slice(1).join('_');
    xp[person] = (xp[person]||0) + (prices[drink]||0);
  }
}
function applyInverse(a){
  if(a.type==="inc"){
    data[a.id] = a.prev;
    if(a.person){ xp[a.person] = Math.max(0,(xp[a.person]||0) - (a.xpDelta||0)); }
  } else if (a.action==="change"){
    data[a.id] = a.prev;
    const parts=a.id.split('_'); const person=parts[0]; const drink=parts.slice(1).join('_');
    xp[person] = Math.max(0,(xp[person]||0) - (prices[drink]||0));
  }
}
function undoLast(){ const last=history.pop(); if(!last) return; applyInverse(last); redoStack.push(last); saveAll(); buildTable(); updateUndoRedoButtons(); }
function redoLast(){ const act=redoStack.pop(); if(!act) return; applyAction(act); history.push(act); saveAll(); buildTable(); updateUndoRedoButtons(); }

/* ===== Drag & Drop f√ºr Spalten ===== */
let draggedDrink=null;
function dragStart(ev, drink){
  draggedDrink=drink;
  ev.dataTransfer.setData('text/plain', drink);
  ev.dataTransfer.effectAllowed='move';
}
function allowDrop(ev){
  ev.preventDefault();
  const th = ev.currentTarget;
  th.classList.add('drag-over');
}
function leaveDrop(ev){
  ev.currentTarget.classList.remove('drag-over');
}
function dropCol(ev, targetDrink){
  ev.preventDefault();
  ev.currentTarget.classList.remove('drag-over');
  const src = draggedDrink || ev.dataTransfer.getData('text/plain');
  if(!src || src===targetDrink) return;
  const from=columnOrder.indexOf(src);
  const to=columnOrder.indexOf(targetDrink);
  columnOrder.splice(from,1);
  columnOrder.splice(to,0,src);
  saveAll(); buildTable();
}

/* ===== Z√§hl-Logik ===== */
function inc(person, drink){
  const id = `${person}_${drink}`;
  const prev = data[id]||0;
  data[id] = prev + 1;
  history.push({type:'inc', id, prev, person, xpDelta:(prices[drink]||0)});
  redoStack = [];
  // Buchung f√ºr Verlauf
  bookings.unshift({user:person, drink, createdAt:Date.now()});
  if(bookings.length>200) bookings.pop();
  xp[person]=(xp[person]||0)+(prices[drink]||0);
  sClick.play();
  saveAll(); buildTable(); updateUndoRedoButtons();
}
function dec(person, drink){
  const id=`${person}_${drink}`;
  const prev=data[id]||0;
  if(prev<=0) return;
  data[id]=prev-1;
  history.push({type:'inc', id, prev:prev, person, xpDelta:-(prices[drink]||0)}); // inverse speichern
  redoStack=[];
  xp[person]=Math.max(0,(xp[person]||0)-(prices[drink]||0));
  saveAll(); buildTable(); updateUndoRedoButtons();
}
function toggleDeleteMode(){ deleteMode=!deleteMode; document.getElementById('deleteBtn').classList.toggle('secondary', deleteMode); }

/* ===== Tabelle + Level-Ring ===== */
function buildTable(){
  const core=CORE.filter(n=>people.includes(n));
  const guests=people.filter(n=>!CORE.includes(n)).sort((a,b)=>a.localeCompare(b));

  let html = `<table><thead><tr><th style="min-width:240px;text-align:left">Person</th>`;
  columnOrder.forEach(drink=>{
    if(prices[drink]!==undefined){
      html += `<th draggable="true"
                 ondragstart="dragStart(event,'${drink}')"
                 ondragover="allowDrop(event)"
                 ondragleave="leaveDrop(event)"
                 ondrop="dropCol(event,'${drink}')"
                 title="Spalte ziehen, um umzusortieren">
        <span class="drink-chip"><span class="drink-name">${drink.replace('_',' ')}</span>
        <span class="drink-price">${prices[drink]} ‚Ç¨</span></span>
      </th>`;
    }
  });
  html += `<th>Summe</th></tr></thead><tbody>`;

  function rowFor(name){
    const value = valueOfCurrentStriche(name);
    const lvl   = levelOf(getXpForDisplay(name));
    const cells = columnOrder.map(d=>{
      const v=data[`${name}_${d}`]||0;
      return `<td>
        <div class="cell">
          <div class="count" id="c_${name}_${d}">${v}</div>
          <div style="display:flex; gap:6px">
            <button class="btn small plus-btn" onmousedown="startHold(()=>inc('${name}','${d}'))" onclick="inc('${name}','${d}')">Ôºã</button>
            <button class="btn small dark plus-btn" onclick="${deleteMode?'dec':'dec'}('${name}','${d}')">Ôºç</button>
          </div>
        </div>
      </td>`;
    }).join('');
    return `<tr>
      <td class="person-cell">
        <div class="lvl-ring">
          <svg viewBox="0 0 36 36" width="52" height="52" aria-hidden="true">
            <defs><linearGradient id="grad" x1="0" x2="1"><stop offset="0" stop-color="#00e0b8"/><stop offset="1" stop-color="#7c3aed"/></linearGradient></defs>
            <circle class="ring-bg" cx="18" cy="18" r="16"></circle>
            <circle class="ring-fg" cx="18" cy="18" r="16" stroke-dasharray="${2*Math.PI*16}" stroke-dashoffset="${2*Math.PI*16 - Math.min(1,value/50)*2*Math.PI*16}"></circle>
          </svg>
          <div class="val">Lv ${lvl}</div>
        </div>
        <div class="p-info">
          <div class="p-name">${name}</div>
          <div class="lvl-wrap">
            <div class="lvl-line"><span>${euro(value)} ‚Ç¨</span></div>
          </div>
        </div>
      </td>
      ${cells}
      <td>${euro(value)} ‚Ç¨</td>
    </tr>`;
  }

  if(core.length){
    html += `<tr class="section-row"><td colspan="${columnOrder.length+2}">Kernteam</td></tr>`;
    core.forEach(n=> html += rowFor(n));
  }
  if(guests.length){
    html += `<tr class="section-row"><td colspan="${columnOrder.length+2}">G√§ste</td></tr>`;
    guests.forEach(n=> html += rowFor(n));
  }

  /* Letzte Zeile: Person hinzuf√ºgen */
  html += `<tr>
    <td colspan="${columnOrder.length+2}" style="text-align:center">
      <div style="display:inline-flex; gap:8px; align-items:center; flex-wrap:wrap">
        <input id="newPersonInline" placeholder="Neue Person‚Ä¶" style="min-width:200px">
        <button class="btn small" onclick="addPersonInline()">‚ûï Hinzuf√ºgen</button>
        <span class="sub">oder</span>
        <button class="btn small dark" onclick="openModal('personModal')">Modal √∂ffnen</button>
      </div>
    </td>
  </tr>`;

  html += `</tbody></table>`;
  document.getElementById("tableContainer").innerHTML = html;
}

/* ===== Personen hinzuf√ºgen (inline & modal) ===== */
function addPersonInline(){
  const name=(document.getElementById('newPersonInline').value||'').trim();
  if(!name) return;
  if(!people.includes(name)) people.push(name);
  document.getElementById('newPersonInline').value='';
  saveAll(); buildTable();
}
function openModal(id){ document.getElementById(id).style.display="flex"; }
function closeModal(id){ document.getElementById(id).style.display="none"; }
function confirmAddPerson(){
  const name=document.getElementById("personName").value.trim();
  if(name && !people.includes(name)){ people.push(name); }
  document.getElementById("personName").value='';
  closeModal("personModal"); saveAll(); buildTable();
}

/* ===== Getr√§nke hinzuf√ºgen ===== */
function openDrinkModal(){ openModal("drinkModal"); }
function confirmAddDrink(){
  const name=document.getElementById("drinkName").value.trim();
  const price=parseFloat(document.getElementById("drinkPrice").value);
  if(name && !isNaN(price)){
    prices[name]=price;
    if(!columnOrder.includes(name)) columnOrder.push(name);
  }
  document.getElementById("drinkName").value='';
  document.getElementById("drinkPrice").value='';
  closeModal("drinkModal"); saveAll(); buildTable();
}

/* ===== PayPal QR ===== */
function togglePayPal(){ document.getElementById("paypalModal").classList.toggle("show"); }

/* ===== Abrechnen & Zur√ºcksetzen (nur ausgew√§hlte) ===== */
const RESET_PASSWORD = "changeme"; // <‚Äî HIER dein Passwort eintragen!
function openResetModal(){
  const wrap=document.getElementById('resetPeople');
  wrap.innerHTML = people.map(p=>
    `<label class="pill"><input type="checkbox" value="${p}"> ${p}</label>`
  ).join('');
  document.getElementById('resetPassword').value='';
  openModal('resetModal');
}
function performReset(){
  const checked=[...document.querySelectorAll('#resetPeople input:checked')].map(i=>i.value);
  if(!checked.length){ alert('Bitte mindestens eine Person ausw√§hlen.'); return; }
  const pw=document.getElementById('resetPassword').value;
  if(pw!==RESET_PASSWORD){ alert('Falsches Passwort.'); return; }

  checked.forEach(p=>{
    columnOrder.forEach(d=>{ data[`${p}_${d}`]=0; });
  });

  // Buchung protokollieren
  bookings.unshift({user:'SYSTEM', action:'reset', people:checked, createdAt:Date.now()});
  if(bookings.length>200) bookings.pop();

  saveAll(); buildTable(); closeModal('resetModal');
  alert('Abgerechnet: '+checked.join(', '));
}

/* ===== Start ===== */
loadState();
</script>

<!-- Service Worker -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=21', { scope: './' }).catch(()=>{});
  }
</script>
</body>
</html>
