<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Ranglisten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title"><div class="brand-dot"></div><h1>Ranglisten</h1></div>
  </header>

  <main class="content">
    <div class="card table-wrap" id="live"></div>
    <div class="card table-wrap" id="money" style="margin-top:12px"></div>
    <div class="card table-wrap" id="hausdienst" style="margin-top:12px"></div>
  </main>

  <nav class="bottomnav">
    <a class="tab" href="index.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab" href="hausdienst.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab active" href="rangliste.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="buchungen.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
  const CORE=["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
  const firebaseConfig={apiKey:"AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",authDomain:"sickandsound-e9704.firebaseapp.com",projectId:"sickandsound-e9704",storageBucket:"sickandsound-e9704.firebasestorage.app",messagingSenderId:"248197359659",appId:"1:248197359659:web:a8777cbed3f83d6b1ca26e",measurementId:"G-62LH8V7S2E"};
  let db=null;
  try{ if(window.firebase){ firebase.initializeApp(firebaseConfig); try{firebase.analytics();}catch(_){ } db=firebase.firestore(); } }catch(_){ db=null; }

  const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";
  const K = { people:"sick_sound_people", bookings:"sick_sound_bookings", prices:"sick_sound_prices", data:"sick_sound_data" };

  function buildTable(title,heads,rows,emptyText){
    const h=heads.map(h=>`<th>${h}</th>`).join("");
    const r=rows.length ? rows.map(row=>`<tr>${row.map(c=>`<td>${c}</td>`).join("")}</tr>`).join("") : `<tr><td colspan="${heads.length}">${emptyText||"Keine Daten"}</td></tr>`;
    return `<h2 class="section-title">${title}</h2><table><thead><tr>${h}</tr></thead><tbody>${r}</tbody></table>`;
  }

  function valueOfCurrentStriche(person, prices, data){
    return Object.keys(prices||{}).reduce((sum,d)=>sum+((data[`${person}_${d}`]||0)*(prices[d]||0)),0);
  }

  async function load(){
    // --- State laden
    let state = {};
    if(db){
      try{ const s=await db.collection(STATE_COLLECTION).doc("global").get(); state = s.exists ? s.data() : {}; }catch(_){}
    }
    state.people   = state.people   || JSON.parse(localStorage.getItem(K.people))   || [];
    state.bookings = state.bookings || JSON.parse(localStorage.getItem(K.bookings)) || [];
    state.prices   = state.prices   || JSON.parse(localStorage.getItem(K.prices))   || {};
    state.data     = state.data     || JSON.parse(localStorage.getItem(K.data))     || {};

    // --- LIVE Rangliste (gebucht + offen)
    const sumsGebucht={}; (state.people||[]).forEach(p=>sumsGebucht[p]=0);
    (state.bookings||[]).forEach(b=>{ sumsGebucht[b.person]=(sumsGebucht[b.person]||0)+Number(b.sum||0); });

    const rowsLive = (state.people||[]).map(p=>{
      const offen = valueOfCurrentStriche(p, state.prices, state.data);
      const gebucht = sumsGebucht[p]||0;
      const live = gebucht + offen;
      return {p, live, offen, gebucht};
    }).sort((a,b)=>b.live-a.live);

    document.getElementById("live").innerHTML = buildTable(
      "ğŸ† Live Rangliste (Einzahlungen + offene Striche)",
      ["Platz","Person","Live â‚¬","davon offen â‚¬","gebucht â‚¬"],
      rowsLive.map((r,i)=>[i+1, r.p, r.live.toFixed(2), r.offen.toFixed(2), r.gebucht.toFixed(2)]),
      "Noch keine Daten."
    );

    // --- Einzahlungen (nur gebucht)
    const arrMoney=Object.entries(sumsGebucht).sort((a,b)=>b[1]-a[1]);
    document.getElementById("money").innerHTML = buildTable(
      "ğŸ’° Einzahlungen (gebucht)",
      ["Platz","Person","Summe â‚¬"],
      arrMoney.map(([p,v],i)=>[i+1,p,(+v).toFixed(2)]),
      "Noch keine Buchungen vorhanden."
    );

    // --- Hausdienst (nur Kernteam, bis heute)
    const today=new Date().toISOString().slice(0,10);
    if(db){
      const cnt={}; CORE.forEach(p=>cnt[p]=0);
      try{
        const docs=await db.collection("hausdienst").get();
        docs.forEach(d=>{ if(d.id<=today){ const person=d.data().person; if(CORE.includes(person)) cnt[person]++; } });
        const arrHd=Object.entries(cnt).sort((a,b)=>b[1]-a[1]);
        document.getElementById("hausdienst").innerHTML = buildTable(
          "ğŸ§¹ Hausdienst",
          ["Platz","Person","Tage"],
          arrHd.map(([p,v],i)=>[i+1,p,v]),
          "Keine EintrÃ¤ge vorhanden."
        );
      }catch(_){
        document.getElementById("hausdienst").innerHTML = `<h2 class="section-title">ğŸ§¹ Hausdienst</h2><div class="sub">Fehler beim Laden.</div>`;
      }
    }else{
      document.getElementById("hausdienst").innerHTML = `<h2 class="section-title">ğŸ§¹ Hausdienst</h2><div class="sub">Offline: Daten nicht verfÃ¼gbar.</div>`;
    }
  }

  if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }
  window.onload=load;
</script>
</body>
</html>
