<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Hausdienst</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0e14" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    .tabs { display:flex; gap:8px; margin-top:8px; flex-wrap:wrap; }
    .tabs .tabbtn { padding:8px 12px; border-radius:999px; background:#1c2130; color:#e6e8ef; border:1px solid #2a3042; }
    .tabs .tabbtn.active { background:linear-gradient(135deg,#6ee7ff,#a78bfa); color:#0b0e14; border-color:transparent; font-weight:800; }
    .panel { display:none; }
    .panel.active { display:block; }

    .people-row { display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; scrollbar-width:thin; }
    .people-row .pill { flex:0 0 auto; padding:8px 12px; border-radius:999px; background:#1c2130; border:1px solid #2a3042; color:#e6e8ef; }
    .people-row .pill.active { background:linear-gradient(135deg,#6ee7ff,#a78bfa); color:#0b0e14; border-color:transparent; font-weight:800; }

    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .badge.big { font-size:14px; padding:6px 10px; }
    .muted { opacity:.7 }

    .segmented { display:flex; gap:8px; flex-wrap:wrap; }
    .segmented .tabbtn { padding:8px 12px; border-radius:999px; background:#1c2130; color:#e6e8ef; border:1px solid #2a3042; }
    .segmented .tabbtn.active { background:linear-gradient(135deg,#6ee7ff,#a78bfa); color:#0b0e14; border-color:transparent; font-weight:800; }

    .toolbar { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .toolbar input, .toolbar select { flex:1 1 auto; min-width:160px; }
    .groupTitle { font-weight:800; letter-spacing:.2px; margin:6px 0 6px; }

    .statusdot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;background:#ffadad}
    .statusok{background:#7CFC9A}

    /* Drag & Drop */
    .task-row { cursor: grab; transition: background 0.2s, transform 0.2s; user-select: none; -webkit-user-select: none; }
    .task-row:active { cursor: grabbing; }
    .task-row.dragging { opacity: 0.5; background: #2a3042; transform: scale(1.02); }
    .task-row.drag-over { border-top: 3px solid #6ee7ff; }
    .drag-handle { cursor: grab; padding: 0 8px; opacity: 0.5; touch-action: none; }
    .drag-handle:hover { opacity: 1; }
    .task-row.touch-dragging { position: relative; z-index: 100; background: #2a3042; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }

    /* Bewertungssystem */
    .rating-section { margin-top: 15px; padding: 15px; background: #1c2130; border-radius: 12px; border: 1px solid #2a3042; }
    .star-rating { display: flex; gap: 8px; margin: 10px 0; }
    .star-rating .star { font-size: 28px; cursor: pointer; color: #2a3042; transition: color 0.2s, transform 0.2s; }
    .star-rating .star:hover, .star-rating .star.active { color: #ffd700; transform: scale(1.1); }
    .star-rating .star.hovered { color: #ffd700; }
    .rating-comment { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #2a3042; background: #0e1422; color: #e6e8ef; resize: vertical; min-height: 60px; }
    .rating-info { font-size: 12px; opacity: 0.7; margin-bottom: 8px; }
    .rating-preview { display: flex; align-items: center; gap: 4px; }
    .rating-preview .star { color: #ffd700; }
    .rating-preview .star.empty { color: #2a3042; }

    /* Hausdienst Status */
    .hd-status { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 8px; font-size: 12px; }
    .hd-status.pending { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
    .hd-status.complete { background: rgba(124, 252, 154, 0.2); color: #7CFC9A; }
    .progress-bar { height: 4px; background: #2a3042; border-radius: 2px; overflow: hidden; margin-top: 6px; }
    .progress-bar .fill { height: 100%; background: linear-gradient(90deg, #6ee7ff, #7CFC9A); transition: width 0.3s; }

    /* Admin-Modus */
    .admin-indicator { background-color: #ff6b6b; padding: 4px 8px; border-radius: 4px; margin-left: 8px; font-size: 12px; }
    .admin-card { background: rgba(255, 107, 107, 0.1); border: 1px solid rgba(255, 107, 107, 0.3); }
    .admin-form { display: flex; flex-direction: column; gap: 10px; margin-top: 10px; }
    .admin-form .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
    .admin-form input[type="date"] { padding: 8px 12px; border-radius: 8px; border: 1px solid #2a3042; background: #0e1422; color: #e6e8ef; }
    .admin-form select { padding: 8px 12px; border-radius: 8px; border: 1px solid #2a3042; background: #0e1422; color: #e6e8ef; flex: 1; min-width: 120px; }

    /* Bewertungs-Modal */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; place-items: center; z-index: 100; padding: 20px; }
    .modal.show { display: grid; }
    .modal-box { background: #151a23; border-radius: 16px; padding: 24px; max-width: 400px; width: 100%; border: 1px solid #2a3042; }
    .modal-title { font-size: 18px; font-weight: 800; margin-bottom: 8px; }
    .modal-stars { display: flex; gap: 8px; justify-content: center; margin: 20px 0; }
    .modal-stars .star { font-size: 36px; cursor: pointer; color: #2a3042; transition: all 0.2s; }
    .modal-stars .star:hover, .modal-stars .star.active { color: #ffd700; transform: scale(1.15); }
    .modal-stars .star.hovered { color: #ffd700; }
    .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
    .modal-actions .btn { flex: 1; }
  </style>
</head>
<body>
<div class="app">
  <header class="appbar">
    <div class="app-title">
      <div class="brand-dot"></div>
      <h1>Hausdienst</h1>
      <span id="adminIndicator" class="admin-indicator" style="display:none;">Admin</span>
    </div>
    <div class="appbar-actions">
      <button class="btn small warning" id="adminBtn" onclick="toggleAdminMode()" title="Admin-Modus">ðŸ”§</button>
      <a class="btn small dark" href="index.html" title="Zur Liste">ðŸ§¾</a>
    </div>
  </header>

  <main class="content">
    <div class="card">
      <div class="section-title">Heute</div>
      <div id="todayInfo" class="sub">Ladeâ€¦</div>
      <div class="tabs" style="margin-top:10px">
        <button id="tabCheck" class="tabbtn active" onclick="showTab('check')">Checkliste</button>
        <button id="tabPlan" class="tabbtn" onclick="showTab('plan')">Planen</button>
        <button id="tabHist" class="tabbtn" onclick="showTab('history')">Historie</button>
      </div>
      <div class="sub" id="connInfo" style="margin-top:6px"><span class="statusdot" id="dot"></span><span id="connTxt">Verbindeâ€¦</span></div>
    </div>

    <!-- Panel: Planen -->
    <div id="panelPlan" class="panel">
      <!-- Admin: RÃ¼ckwirkend eintragen -->
      <div class="card admin-card" id="adminPanel" style="display:none">
        <div class="section-title">Admin: RÃ¼ckwirkend eintragen</div>
        <div class="sub">Hausdienst fÃ¼r beliebiges Datum eintragen oder Ã¤ndern</div>
        <div class="admin-form">
          <div class="row">
            <input type="date" id="adminDate" />
            <select id="adminPerson">
              <option value="">Person auswÃ¤hlen...</option>
            </select>
          </div>
          <div class="row">
            <button class="btn small" onclick="adminSetHausdienst()">Eintragen</button>
            <button class="btn small warning" onclick="adminClearHausdienst()">LÃ¶schen</button>
            <label style="display:flex;align-items:center;gap:6px;font-size:12px">
              <input type="checkbox" id="adminMarkComplete" /> Als abgeschlossen markieren
            </label>
          </div>
        </div>
        <div id="adminStatus" class="sub" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <div class="section-title">Hausdienst planen</div>
        <div class="row" style="margin-top:6px">
          <button id="btnToday" class="btn small" onclick="setFor('today')" disabled>Heute belegen</button>
          <button id="btnTomorrow" class="btn small" onclick="setFor('tomorrow')" disabled>Morgen belegen</button>
          <span id="selBadge" class="badge big">Auswahl: â€“</span>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Person auswÃ¤hlen</div>
        <div id="peopleRow" class="people-row" style="margin-top:8px"></div>
        <div class="sub muted" style="margin-top:6px">
          Tipp: Person wÃ¤hlen, dann â€žHeute/Morgenâ€œ oder unten in der Liste â€žBelegenâ€œ tippen.
        </div>
      </div>

      <div class="card table-wrap">
        <div class="section-title">Geplante Hausdienste (nÃ¤chste 14 Tage)</div>
        <div id="nextList" class="sub">Ladeâ€¦</div>
      </div>
    </div>

    <!-- Panel: Checkliste -->
    <div id="panelCheck" class="panel active">
      <div class="card">
        <div class="section-title">Checkliste</div>
        <div class="sub">Aufgaben sind dauerhaft gespeichert Â· Haken gilt nur heute</div>

        <div id="catTabs" class="segmented" style="margin-top:10px"></div>

        <div class="toolbar">
          <input id="newTask" placeholder="Neue Aufgabe hinzufÃ¼genâ€¦">
          <select id="newTaskCat" title="Kategorie">
            <option value="morgens">Morgens</option>
            <option value="tag">Im Laufe des Tages</option>
            <option value="abend">Bevor man geht</option>
          </select>
          <button class="btn" onclick="addTask()">HinzufÃ¼gen</button>
        </div>

        <div id="filters" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button id="fOpen" class="btn small secondary" onclick="setMode('open')">Offen</button>
          <button id="fDone" class="btn small ghost" onclick="setMode('done')">Erledigt</button>
          <button id="fAll"  class="btn small ghost" onclick="setMode('all')">Alle</button>
        </div>
      </div>

      <div class="card table-wrap" id="list"><div class="sub">Lade Aufgabenâ€¦</div></div>

      <!-- Hausdienst-Status -->
      <div class="card" id="hdStatusCard">
        <div class="section-title">Hausdienst-Status</div>
        <div id="hdStatusInfo"><div class="sub">Lade Status...</div></div>
        <div class="progress-bar"><div class="fill" id="progressFill" style="width:0%"></div></div>
        <button class="btn small" style="margin-top:10px" onclick="openRatingModal()" id="openRatingBtn">Gestrigen Hausdienst bewerten</button>
      </div>
    </div>

    <!-- Panel: Historie -->
    <div id="panelHist" class="panel">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="section-title" style="margin:0">Hausdienst â€“ Historie</div>
          <a href="bewertungen.html" class="btn small">Alle Bewertungen</a>
        </div>
      </div>
      <div class="card table-wrap">
        <div class="section-title">Letzte 30 Tage</div>
        <div id="histList" class="sub">Ladeâ€¦</div>
      </div>
    </div>
  </main>

  <nav class="bottomnav">
    <a class="tab" href="index.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h10v2H4z"/></svg>
      <span>Liste</span>
    </a>
    <a class="tab active" href="hausdienst.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 7-1.2 1.6L18 10.1V20h-5v-6H11v6H6v-9.9L4.2 11.6 3 10z"/></svg>
      <span>Hausdienst</span>
    </a>
    <a class="tab" href="hausdienst.html#check" style="display:none"></a><!-- Reserve -->
    <a class="tab" href="rangliste.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 17H3V7h4v10zm7 0h-4V3h4v14zm7 0h-4v-8h4v8z"/></svg>
      <span>Rang</span>
    </a>
    <a class="tab" href="bewertungen.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 1l3.09 6.26L22 8.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 13.14 2 8.27l6.91-1.01L12 1z"/></svg>
      <span>Bewertungen</span>
    </a>
    <a class="tab" href="buchungen.html">
      <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 2h9l5 5v13a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 0 0 1 2-2zm8 1.5V8h4.5L14 3.5z"/></svg>
      <span>Buchungen</span>
    </a>
  </nav>
</div>

<!-- Bewertungs-Modal -->
<div class="modal" id="ratingModal">
  <div class="modal-box">
    <div class="modal-title">Hausdienst bewerten</div>
    <div id="modalRatingInfo" class="sub"></div>
    <div class="modal-stars" id="modalStars">
      <span class="star" data-value="1" onclick="setModalRating(1)" onmouseenter="hoverModalRating(1)" onmouseleave="hoverModalRating(0)">â˜…</span>
      <span class="star" data-value="2" onclick="setModalRating(2)" onmouseenter="hoverModalRating(2)" onmouseleave="hoverModalRating(0)">â˜…</span>
      <span class="star" data-value="3" onclick="setModalRating(3)" onmouseenter="hoverModalRating(3)" onmouseleave="hoverModalRating(0)">â˜…</span>
      <span class="star" data-value="4" onclick="setModalRating(4)" onmouseenter="hoverModalRating(4)" onmouseleave="hoverModalRating(0)">â˜…</span>
      <span class="star" data-value="5" onclick="setModalRating(5)" onmouseenter="hoverModalRating(5)" onmouseleave="hoverModalRating(0)">â˜…</span>
    </div>
    <textarea id="modalComment" class="rating-comment" placeholder="Optionaler Kommentar..."></textarea>
    <div class="modal-actions">
      <button class="btn" id="modalSubmitBtn" onclick="submitModalRating()" disabled>Bewerten</button>
      <button class="btn ghost" onclick="closeRatingModal()">SpÃ¤ter</button>
    </div>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>
<script>
  const DEFAULT_CORE=["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
  let CORE=[...DEFAULT_CORE]; // Wird dynamisch aus Firebase geladen
  const ADMIN_PASSWORD = "1379";
  let adminMode = false;
  const STATE_COLLECTION = location.search.includes("beta") ? "state_beta" : "state";

  /* âœ… Richtiges Firebase-Config fÃ¼r sickandsound-8a15f */
  const firebaseConfig = {
    apiKey: "AIzaSyBtZsr4QPHQbvO2qae6MoBoxJF5dNP2vh0",
    authDomain: "sickandsound-8a15f.firebaseapp.com",
    projectId: "sickandsound-8a15f",
    storageBucket: "sickandsound-8a15f.appspot.com",
    messagingSenderId: "32138160959",
    appId: "1:32138160959:web:a65c7f4ad7d44e757fc18a"
  };

  let db=null;
  try{
    if(window.firebase){
      firebase.initializeApp(firebaseConfig);
      try{firebase.analytics();}catch(_){}
      db=firebase.firestore();

      /* ðŸ›œ Long-Polling fÃ¼r mobile Netze */
      try { db.settings({ experimentalAutoDetectLongPolling:true, merge:true }); } catch(_) {}

      document.getElementById('dot').classList.add('statusok');
      document.getElementById('connTxt').textContent='Online (Firestore verbunden)';
    }
  }catch(e){
    db=null;
    document.getElementById('connTxt').textContent='Offline â€“ Firebase konnte nicht initialisiert werden.';
  }

  /* ðŸ”Ž Diagnose â€“ zeigt sofort Projekt & Zugriff */
  async function diagFirestore(){
    const el = document.getElementById('todayInfo');
    el.textContent = 'Teste Firestoreâ€¦ (Project: ' + (firebase.app()?.options?.projectId||'?') + ')';
    try {
      const test = await db.collection('hausdienst').limit(1).get();
      el.textContent = 'Firestore OK (' + test.size + ' Docs gefunden) â€“ Project: ' + firebase.app().options.projectId;
    } catch(e) {
      el.textContent = 'Firestore-Fehler: ' + (e.code || e.message) + ' â€“ Project: ' + (firebase.app()?.options?.projectId||'?');
      console.error('Diag:', e);
    }
  }
  diagFirestore();

  /* Tabs */
  function showTab(key){
    const map={plan:'panelPlan', check:'panelCheck', history:'panelHist'};
    ['plan','check','history'].forEach(k=>{
      document.getElementById(map[k]).classList.toggle('active', k===key);
      document.getElementById('tab'+(k==='history'?'Hist':k.charAt(0).toUpperCase()+k.slice(1))).classList.toggle('active', k===key);
    });
    // Hash synchronisieren (check = leerer Hash, da Checkliste der Standard ist)
    if(history.pushState){
      const h = key==='check' ? '' : '#'+key;
      history.replaceState(null,'', location.pathname + (h? h : ''));
    }

    // Bei Wechsel zur Checkliste: Bewertungs-Modal prÃ¼fen
    if (key === 'check') {
      checkAndShowRatingModal();
    }
  }

  // Nur Query/Hash â€“ KEIN localStorage
  function pickTabFromQuery(){
    let t = new URLSearchParams(location.search).get('tab');
    if(!t){
      const hash=(location.hash||'').replace('#','');
      if(['check','history','plan'].includes(hash)) t = hash;
    }
    showTab(t || 'check');
  }
  window.addEventListener('hashchange', pickTabFromQuery);

  /* Datum & Refresh */
  const todayStr=()=>new Date().toISOString().slice(0,10);
  function scheduleMidnightRefresh(cb){
    const now=new Date();
    const mid=new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,2);
    setTimeout(()=>{ cb(); scheduleMidnightRefresh(cb); }, mid-now);
  }

  /* Admin-Modus */
  function toggleAdminMode() {
    if (adminMode) {
      adminMode = false;
      document.getElementById('adminIndicator').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'none';
      document.getElementById('adminBtn').textContent = 'ðŸ”§';
      return;
    }

    const password = prompt("Admin-Passwort eingeben:");
    if (password === ADMIN_PASSWORD) {
      adminMode = true;
      document.getElementById('adminIndicator').style.display = 'inline-block';
      document.getElementById('adminPanel').style.display = 'block';
      document.getElementById('adminBtn').textContent = 'ðŸ”§âœ“';
      initAdminPanel();
    } else {
      alert("Falsches Passwort");
    }
  }

  function initAdminPanel() {
    // Datum auf heute setzen
    document.getElementById('adminDate').value = todayStr();

    // Personen-Dropdown fÃ¼llen
    const select = document.getElementById('adminPerson');
    select.innerHTML = '<option value="">Person auswÃ¤hlen...</option>';
    CORE.forEach(p => {
      const opt = document.createElement('option');
      opt.value = p;
      opt.textContent = p;
      select.appendChild(opt);
    });
  }

  async function adminSetHausdienst() {
    if (!adminMode || !db) return;

    const date = document.getElementById('adminDate').value;
    const person = document.getElementById('adminPerson').value;
    const markComplete = document.getElementById('adminMarkComplete').checked;
    const statusEl = document.getElementById('adminStatus');

    if (!date || !person) {
      statusEl.innerHTML = '<span class="badge" style="background:#ff6b6b;color:#fff">Bitte Datum und Person auswÃ¤hlen</span>';
      return;
    }

    try {
      const data = {
        person: person,
        updatedAt: Date.now(),
        setByAdmin: true
      };

      if (markComplete) {
        data.completed = true;
        data.completedAt = Date.now();
      }

      await db.collection("hausdienst").doc(date).set(data, { merge: true });
      statusEl.innerHTML = `<span class="badge ok">âœ“ ${person} fÃ¼r ${date} eingetragen${markComplete ? ' (abgeschlossen)' : ''}</span>`;

      // Listen aktualisieren
      if (date === todayStr()) await updateTodayInfo();
      await renderNextDays();
      await renderHistory();
    } catch (e) {
      statusEl.innerHTML = `<span class="badge" style="background:#ff6b6b;color:#fff">Fehler: ${e.message}</span>`;
    }
  }

  async function adminClearHausdienst() {
    if (!adminMode || !db) return;

    const date = document.getElementById('adminDate').value;
    const statusEl = document.getElementById('adminStatus');

    if (!date) {
      statusEl.innerHTML = '<span class="badge" style="background:#ff6b6b;color:#fff">Bitte Datum auswÃ¤hlen</span>';
      return;
    }

    if (!confirm(`Hausdienst fÃ¼r ${date} wirklich lÃ¶schen?`)) return;

    try {
      await db.collection("hausdienst").doc(date).delete();
      statusEl.innerHTML = `<span class="badge ok">âœ“ Hausdienst fÃ¼r ${date} gelÃ¶scht</span>`;

      // Listen aktualisieren
      if (date === todayStr()) await updateTodayInfo();
      await renderNextDays();
      await renderHistory();
    } catch (e) {
      statusEl.innerHTML = `<span class="badge" style="background:#ff6b6b;color:#fff">Fehler: ${e.message}</span>`;
    }
  }

  /* Auswahl */
  let selectedPerson=null;

  function renderPeopleRow(){
    const wrap=document.getElementById('peopleRow');
    wrap.innerHTML = CORE.map(p=>`<button class="pill ${selectedPerson===p?'active':''}" onclick="selectPerson('${p}')">${p}</button>`).join("");
  }
  function updateSelectionUI(){
    const badge=document.getElementById('selBadge');
    const has=!!selectedPerson;
    badge.innerHTML = has ? `Auswahl: <b>${selectedPerson}</b>` : "Auswahl: â€“";
    document.getElementById('btnToday').disabled = !has;
    document.getElementById('btnTomorrow').disabled = !has;
  }
  function selectPerson(name){
    if(!CORE.includes(name)) return;
    selectedPerson = (selectedPerson===name ? null : name);
    renderPeopleRow(); updateSelectionUI(); renderNextDays();
  }

  /* Setzen/LÃ¶schen */
  async function setFor(day){
    if(!selectedPerson) return alert("Bitte zuerst eine Person auswÃ¤hlen.");
    if(!db) return alert("Offline â€“ kann nicht speichern.");
    const dt=new Date(); if(day==='tomorrow') dt.setDate(dt.getDate()+1);
    const id=dt.toISOString().slice(0,10);
    const ex=await db.collection("hausdienst").doc(id).get();
    if(ex.exists && ex.data().person){ alert(`Bereits belegt: ${ex.data().person}. Bitte in der Ãœbersicht austragen.`); return; }
    await db.collection("hausdienst").doc(id).set({person:selectedPerson, updatedAt:Date.now()});
    if(id===todayStr()) await updateTodayInfo();
    await renderNextDays(); await renderHistory();
  }
  async function setForDate(date, person){
    if(!db) return alert("Offline â€“ kann nicht speichern.");
    const ex=await db.collection("hausdienst").doc(date).get();
    if(exists(ex)){ alert(`Bereits belegt: ${ex.data().person}`); return; }
    await db.collection("hausdienst").doc(date).set({person, updatedAt:Date.now()});
    if(date===todayStr()) await updateTodayInfo();
    await renderNextDays(); await renderHistory();
  }
  function exists(d){ return d && d.exists; }
  async function clearSpecific(date){
    if(!db) return alert("Offline â€“ kann nicht lÃ¶schen.");
    await db.collection("hausdienst").doc(date).delete();
    if(date===todayStr()) await updateTodayInfo();
    await renderNextDays(); await renderHistory();
  }

  /* Heute + Liste */
  async function updateTodayInfo(){
    if(!db){ document.getElementById('todayInfo').textContent="Heute: (offline)"; return; }
    const d=await db.collection("hausdienst").doc(todayStr()).get();
    const person = exists(d) ? d.data().person : null;
    document.getElementById('todayInfo').innerHTML = person
      ? `Heute eingetragener Hausdienst: <span class="badge ok">${person}</span>`
      : `Heute: <span class="badge none">Noch niemand eingetragen</span>`;
  }

  async function renderNextDays(){
    if(!db){ document.getElementById('nextList').textContent="Offline â€“ keine Vorschau."; return; }
    const out=[];
    for(let i=0;i<14;i++){
      const dt=new Date(); dt.setDate(dt.getDate()+i);
      const id=dt.toISOString().slice(0,10);
      const doc=await db.collection("hausdienst").doc(id).get();
      out.push([id, exists(doc) ? (doc.data().person||null) : null, i===0]);
    }
    const rows = out.map(([d,p,isToday])=>{
      const action = p
        ? `<button class="btn small danger" onclick="clearSpecific('${d}')">Austragen</button>`
        : (selectedPerson ? `<button class="btn small" onclick="setForDate('${d}','${selectedPerson}')">Belegen mit Auswahl</button>` : `<span class="sub muted">frei</span>`);
      return `<tr><td>${isToday?d+" (heute)":d}</td><td>${p ? p : (selectedPerson ? `<span class="muted">â€“</span>` : "â€”")}</td><td style="text-align:right">${action}</td></tr>`;
    }).join("");
    document.getElementById('nextList').innerHTML = `<table><thead><tr><th>Datum</th><th>Person</th><th>Aktion</th></tr></thead><tbody>${rows}</tbody></table>`;
  }

  /* Checkliste */
  const CATS = [
    {key:"all",    label:"Ãœbersicht"},
    {key:"morgens",label:"Morgens"},
    {key:"tag",    label:"Im Laufe des Tages"},
    {key:"abend",  label:"Bevor man geht"},
  ];
  let showCat = localStorage.getItem("hausdienst_cat") || "all";
  let showMode= localStorage.getItem("hausdienst_filter_mode") || "open";

  const CHECKED_KEY="hausdienst_checked_"+todayStr();
  let checked = {};
  try { checked = JSON.parse(localStorage.getItem(CHECKED_KEY) || "{}"); } catch(_) { checked = {}; }

  function setMode(m){
    showMode = m;
    localStorage.setItem("hausdienst_filter_mode", m);
    renderTasks();
    document.getElementById('fOpen').className = 'btn small ' + (m==='open'?'secondary':'ghost');
    document.getElementById('fDone').className = 'btn small ' + (m==='done'?'secondary':'ghost');
    document.getElementById('fAll').className  = 'btn small ' + (m==='all' ?'secondary':'ghost');
  }

  function setCat(cat){
    showCat = cat;
    localStorage.setItem("hausdienst_cat", cat);
    renderTasks();
    renderCatTabs();
  }

  function renderCatTabs(){
    const wrap=document.getElementById('catTabs');
    wrap.innerHTML = CATS.map(c=>`<button class="tabbtn ${showCat===c.key?'active':''}" onclick="setCat('${c.key}')">${c.label}</button>`).join('');
  }

  function toggleCheck(id){
    checked[id] = !checked[id];
    localStorage.setItem(CHECKED_KEY, JSON.stringify(checked));
    renderTasks(); // re-render fÃ¼r Filter
  }

  async function addTask(){
    if(!db) return alert("Offline â€“ kann nicht speichern.");
    const inp=document.getElementById('newTask');
    const txt=inp.value.trim();
    const cat=(document.getElementById('newTaskCat').value||'tag');
    if(!txt) return;
    await db.collection('hausdienst_tasks').add({ text: txt, cat, createdAt: Date.now() });
    inp.value='';
    await renderTasks(true);
  }

  async function deleteTask(id){
    if(!db) return alert("Offline â€“ kann nicht lÃ¶schen.");
    if(!confirm("Willst du diese Aufgabe wirklich lÃ¶schen?")) return;
    await db.collection('hausdienst_tasks').doc(id).delete();
    await renderTasks(true);
  }

  let _tasks = [];
  let draggedTaskId = null;

  async function loadTasks(){
    if(!db){ _tasks=[]; renderTasks(); return; }

    // PrÃ¼fen, ob bereits Standardaufgaben vorhanden sind
    const snap = await db.collection('hausdienst_tasks').orderBy('sortOrder','asc').get();
    _tasks = snap.docs.map(d=>({id:d.id, ...d.data()}));

    // Fallback: sortieren nach createdAt wenn kein sortOrder vorhanden
    if (_tasks.length > 0 && _tasks[0].sortOrder === undefined) {
      const oldSnap = await db.collection('hausdienst_tasks').orderBy('createdAt','asc').get();
      _tasks = oldSnap.docs.map(d=>({id:d.id, ...d.data()}));
    }

    // Standardaufgaben nur hinzufÃ¼gen, wenn noch keine Aufgaben vorhanden sind
    if (_tasks.length === 0) {
      // Standardaufgaben hinzufÃ¼gen
      const defaultTasks = [
        { text: "Briefkasten leeren", cat: "morgens", createdAt: Date.now(), sortOrder: 0 },
        { text: "SpÃ¼lmaschine ausrÃ¤umen", cat: "morgens", createdAt: Date.now(), sortOrder: 1 },
        { text: "Toilettenpapier & Zewa auffÃ¼llen", cat: "morgens", createdAt: Date.now(), sortOrder: 2 },
        { text: "GetrÃ¤nke auffÃ¼llen & Pfandkiste wechseln wenn voll", cat: "morgens", createdAt: Date.now(), sortOrder: 3 },
        { text: "Staubsauger Wasser checken", cat: "morgens", createdAt: Date.now(), sortOrder: 4 },
        { text: "HandtÃ¼cher im Bad wechseln", cat: "morgens", createdAt: Date.now(), sortOrder: 5 },
        { text: "WÃ¤sche an machen & aufhÃ¤ngen", cat: "tag", createdAt: Date.now(), sortOrder: 6 },
        { text: "Pakete entgegennehmen", cat: "tag", createdAt: Date.now(), sortOrder: 7 },
        { text: "FÃ¼r Grundordnung in GemeinschaftsrÃ¤umen sorgen", cat: "tag", createdAt: Date.now(), sortOrder: 8 },
        { text: "OberflÃ¤chen in der KÃ¼che + GerÃ¤te wischen", cat: "abend", createdAt: Date.now(), sortOrder: 9 },
        { text: "Mikro & Backofen durchwischen", cat: "abend", createdAt: Date.now(), sortOrder: 10 },
        { text: "Haus- & Toiletten MÃ¼ll rausbringen & mitnehmen", cat: "abend", createdAt: Date.now(), sortOrder: 11 }
      ];

      // Standardaufgaben zur Datenbank hinzufÃ¼gen
      for (const task of defaultTasks) {
        await db.collection('hausdienst_tasks').add(task);
      }

      // Aufgaben neu laden
      const newSnap = await db.collection('hausdienst_tasks').orderBy('sortOrder','asc').get();
      _tasks = newSnap.docs.map(d=>({id:d.id, ...d.data()}));
    }
  }

  // Drag & Drop Funktionen (Desktop)
  function handleDragStart(e, taskId) {
    draggedTaskId = taskId;
    e.target.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  }

  function handleDragEnd(e) {
    e.target.classList.remove('dragging');
    document.querySelectorAll('.task-row').forEach(row => row.classList.remove('drag-over'));
    draggedTaskId = null;
  }

  function handleDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const row = e.target.closest('.task-row');
    if (row && !row.classList.contains('dragging')) {
      document.querySelectorAll('.task-row').forEach(r => r.classList.remove('drag-over'));
      row.classList.add('drag-over');
    }
  }

  function handleDragLeave(e) {
    const row = e.target.closest('.task-row');
    if (row) row.classList.remove('drag-over');
  }

  async function handleDrop(e, targetTaskId) {
    e.preventDefault();
    if (!draggedTaskId || draggedTaskId === targetTaskId) return;
    await reorderTasks(draggedTaskId, targetTaskId);
  }

  // Touch Drag & Drop (Mobile/Tablet)
  let touchDraggedRow = null;
  let touchDraggedTaskId = null;
  let touchStartY = 0;
  let touchCurrentY = 0;
  let longPressTimer = null;
  let isDragging = false;

  function handleTouchStart(e, taskId) {
    const touch = e.touches[0];
    touchStartY = touch.clientY;
    touchDraggedTaskId = taskId;
    touchDraggedRow = e.target.closest('.task-row');

    // Long-press zum Starten des Drag
    longPressTimer = setTimeout(() => {
      if (touchDraggedRow) {
        isDragging = true;
        touchDraggedRow.classList.add('touch-dragging');
        // Vibration fÃ¼r Feedback (falls unterstÃ¼tzt)
        if (navigator.vibrate) navigator.vibrate(50);
      }
    }, 300);
  }

  function handleTouchMove(e) {
    if (!isDragging || !touchDraggedRow) return;

    e.preventDefault();
    const touch = e.touches[0];
    touchCurrentY = touch.clientY;

    // Finde das Element unter dem Finger
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const rowBelow = elementBelow?.closest('.task-row');

    // Highlight des Ziel-Elements
    document.querySelectorAll('.task-row').forEach(r => r.classList.remove('drag-over'));
    if (rowBelow && rowBelow !== touchDraggedRow) {
      rowBelow.classList.add('drag-over');
    }
  }

  async function handleTouchEnd(e) {
    clearTimeout(longPressTimer);

    if (!isDragging) {
      touchDraggedRow = null;
      touchDraggedTaskId = null;
      return;
    }

    // Finde das Ziel-Element
    const touch = e.changedTouches[0];
    const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
    const rowBelow = elementBelow?.closest('.task-row');
    const targetTaskId = rowBelow?.dataset?.taskid;

    // AufrÃ¤umen
    if (touchDraggedRow) touchDraggedRow.classList.remove('touch-dragging');
    document.querySelectorAll('.task-row').forEach(r => r.classList.remove('drag-over'));

    // Neu ordnen wenn gÃ¼ltiges Ziel
    if (targetTaskId && targetTaskId !== touchDraggedTaskId) {
      await reorderTasks(touchDraggedTaskId, targetTaskId);
    }

    touchDraggedRow = null;
    touchDraggedTaskId = null;
    isDragging = false;
  }

  // Gemeinsame Funktion zum Neuordnen
  async function reorderTasks(fromTaskId, toTaskId) {
    const draggedIndex = _tasks.findIndex(t => t.id === fromTaskId);
    const targetIndex = _tasks.findIndex(t => t.id === toTaskId);
    if (draggedIndex === -1 || targetIndex === -1) return;

    // Array neu ordnen
    const [moved] = _tasks.splice(draggedIndex, 1);
    _tasks.splice(targetIndex, 0, moved);

    // sortOrder in Firebase aktualisieren
    const batch = db.batch();
    _tasks.forEach((task, index) => {
      const ref = db.collection('hausdienst_tasks').doc(task.id);
      batch.update(ref, { sortOrder: index });
      task.sortOrder = index;
    });
    await batch.commit();

    renderTasks();
  }

  function filteredTasks(){
    let arr = [..._tasks];
    if(showCat!=='all') arr = arr.filter(t=>t.cat===showCat);
    if(showMode==='open') arr = arr.filter(t=>!checked[t.id]);
    if(showMode==='done') arr = arr.filter(t=>!!checked[t.id]);
    return arr;
  }

  async function renderTasks(reload=false){
    if(reload) await loadTasks();
    const list=document.getElementById('list');
    const arr = filteredTasks();
    if(!arr.length){
      list.innerHTML = `<div class="sub">Keine Aufgaben in dieser Ansicht.</div>`;
      updateHdStatus();
      return;
    }
    const rows = arr.map(t=>{
      const isDone = !!checked[t.id];
      return `<tr class="task-row" draggable="true" data-taskid="${t.id}"
        ondragstart="handleDragStart(event, '${t.id}')"
        ondragend="handleDragEnd(event)"
        ondragover="handleDragOver(event)"
        ondragleave="handleDragLeave(event)"
        ondrop="handleDrop(event, '${t.id}')"
        ontouchstart="handleTouchStart(event, '${t.id}')"
        ontouchmove="handleTouchMove(event)"
        ontouchend="handleTouchEnd(event)">
        <td style="width:24px" class="drag-handle">â ¿</td>
        <td style="width:32px"><input type="checkbox" ${isDone?'checked':''} onclick="event.stopPropagation(); toggleCheck('${t.id}')"></td>
        <td>${t.text} ${t.cat!=='all'?`<span class="badge">${t.cat}</span>`:''}</td>
        <td style="text-align:right"><button class="btn small danger" onclick="event.stopPropagation(); deleteTask('${t.id}')">LÃ¶schen</button></td>
      </tr>`;
    }).join('');
    list.innerHTML = `<table><thead><tr><th></th><th></th><th>Aufgabe</th><th>Aktion</th></tr></thead><tbody>${rows}</tbody></table>`;
    updateHdStatus();
  }

  /* Bewertungssystem */
  let modalRating = 0;
  let yesterdayPerson = null;
  let todayPerson = null;
  let existingRatingId = null; // ID der bestehenden Bewertung
  let existingRatingData = null; // Daten der bestehenden Bewertung

  function getYesterdayStr() {
    const d = new Date();
    d.setDate(d.getDate() - 1);
    return d.toISOString().slice(0, 10);
  }

  // Modal Funktionen
  function hoverModalRating(val) {
    const stars = document.querySelectorAll('#modalStars .star');
    stars.forEach((star, i) => {
      star.classList.toggle('hovered', i < val);
    });
  }

  function setModalRating(val) {
    modalRating = val;
    const stars = document.querySelectorAll('#modalStars .star');
    stars.forEach((star, i) => {
      star.classList.toggle('active', i < val);
    });
    document.getElementById('modalSubmitBtn').disabled = modalRating === 0;
  }

  async function openRatingModal() {
    if (!yesterdayPerson || !todayPerson) return;

    // Bestehende Bewertung laden
    const existingRating = await db.collection('bewertungen')
      .where('date', '==', getYesterdayStr())
      .where('bewertetVon', '==', todayPerson)
      .get();

    if (!existingRating.empty) {
      existingRatingId = existingRating.docs[0].id;
      existingRatingData = existingRating.docs[0].data();
      setModalRating(existingRatingData.rating);
      document.getElementById('modalComment').value = existingRatingData.comment || '';
      document.getElementById('modalRatingInfo').innerHTML =
        `Bewertung fÃ¼r <b>${yesterdayPerson}</b> (${getYesterdayStr()}) bearbeiten:`;
      document.getElementById('modalSubmitBtn').textContent = 'Aktualisieren';
    } else {
      existingRatingId = null;
      existingRatingData = null;
      modalRating = 0;
      document.querySelectorAll('#modalStars .star').forEach(s => s.classList.remove('active', 'hovered'));
      document.getElementById('modalComment').value = '';
      document.getElementById('modalSubmitBtn').disabled = true;
      document.getElementById('modalRatingInfo').innerHTML =
        `Bewerte den Hausdienst von <b>${yesterdayPerson}</b> (${getYesterdayStr()}):`;
      document.getElementById('modalSubmitBtn').textContent = 'Bewerten';
    }

    document.getElementById('ratingModal').classList.add('show');
  }

  function closeRatingModal() {
    document.getElementById('ratingModal').classList.remove('show');
  }

  async function submitModalRating() {
    if (!db || modalRating === 0 || !yesterdayPerson || !todayPerson) return;

    const comment = document.getElementById('modalComment').value.trim();

    if (existingRatingId) {
      // Bestehende Bewertung aktualisieren
      await db.collection('bewertungen').doc(existingRatingId).update({
        rating: modalRating,
        comment: comment,
        updatedAt: Date.now()
      });
      alert('Bewertung aktualisiert!');
    } else {
      // Neue Bewertung erstellen
      await db.collection('bewertungen').add({
        date: getYesterdayStr(),
        bewerteterHausdienst: yesterdayPerson,
        bewertetVon: todayPerson,
        rating: modalRating,
        comment: comment,
        createdAt: Date.now()
      });
      alert('Bewertung gespeichert!');
    }

    existingRatingData = { rating: modalRating, comment: comment };
    closeRatingModal();
    updateHdStatus();
  }

  async function checkAndShowRatingModal() {
    if (!db) return;

    // Heute und Gestern laden
    const todayDoc = await db.collection('hausdienst').doc(todayStr()).get();
    const yesterdayDoc = await db.collection('hausdienst').doc(getYesterdayStr()).get();

    todayPerson = todayDoc.exists ? todayDoc.data().person : null;
    yesterdayPerson = yesterdayDoc.exists ? yesterdayDoc.data().person : null;

    if (!todayPerson || !yesterdayPerson) {
      updateHdStatus();
      return;
    }

    // PrÃ¼fen ob bereits bewertet
    const existingRating = await db.collection('bewertungen')
      .where('date', '==', getYesterdayStr())
      .where('bewertetVon', '==', todayPerson)
      .get();

    const hasRating = !existingRating.empty;
    if (hasRating) {
      existingRatingId = existingRating.docs[0].id;
      existingRatingData = existingRating.docs[0].data();
    } else {
      existingRatingId = null;
      existingRatingData = null;
    }

    updateHdStatus();

    // Modal automatisch Ã¶ffnen wenn noch nicht bewertet
    if (!hasRating) {
      openRatingModal();
    }
  }

  function updateHdStatus() {
    const statusInfo = document.getElementById('hdStatusInfo');
    const progressFill = document.getElementById('progressFill');
    const ratingBtn = document.getElementById('openRatingBtn');

    const totalTasks = _tasks.length;
    const doneTasks = _tasks.filter(t => checked[t.id]).length;
    const progress = totalTasks > 0 ? Math.round((doneTasks / totalTasks) * 100) : 0;
    progressFill.style.width = progress + '%';

    // Bewertungs-Button aktualisieren
    if (ratingBtn) {
      if (!todayPerson || !yesterdayPerson) {
        ratingBtn.style.display = 'none';
      } else if (existingRatingData) {
        // Bewertung existiert - kann bearbeitet werden
        const stars = 'â˜…'.repeat(existingRatingData.rating) + 'â˜†'.repeat(5 - existingRatingData.rating);
        ratingBtn.innerHTML = `âœŽ Bewertung bearbeiten <span style="color:#ffd700;margin-left:6px">${stars}</span>`;
        ratingBtn.disabled = false;
        ratingBtn.className = 'btn small secondary';
        ratingBtn.style.display = 'inline-block';
      } else {
        ratingBtn.textContent = `${yesterdayPerson}s Hausdienst bewerten`;
        ratingBtn.disabled = false;
        ratingBtn.className = 'btn small';
        ratingBtn.style.display = 'inline-block';
      }
    }

    if (!todayPerson) {
      statusInfo.innerHTML = `
        <div class="hd-status pending">â—‹ Kein Hausdienst eingetragen</div>
        <div class="sub" style="margin-top:6px">${doneTasks}/${totalTasks} Aufgaben erledigt (${progress}%)</div>
      `;
      return;
    }

    let statusHtml = `<div class="sub" style="margin-bottom:6px">Heute: <b>${todayPerson}</b></div>`;
    statusHtml += `<div class="sub" style="margin-top:6px">${doneTasks}/${totalTasks} Aufgaben erledigt (${progress}%)</div>`;

    statusInfo.innerHTML = statusHtml;
  }

  /* Historie (letzte 30 Tage) */
  async function renderHistory(){
    const el = document.getElementById('histList');
    if(!db){ el.textContent="Offline â€“ keine Historie."; return; }

    // Bewertungen laden
    const bewertungenSnap = await db.collection('bewertungen').get();
    const bewertungen = {};
    bewertungenSnap.forEach(doc => {
      const data = doc.data();
      bewertungen[data.date] = data;
    });

    const rows=[];
    for(let i=0;i<30;i++){
      const dt=new Date(); dt.setDate(dt.getDate()-i);
      const id=dt.toISOString().slice(0,10);
      const doc=await db.collection("hausdienst").doc(id).get();
      const data = exists(doc) ? doc.data() : null;
      const person = data ? (data.person||'â€”') : 'â€”';
      const completed = data?.completed || false;
      const bewertung = bewertungen[id];

      let statusBadge = '';
      if (person !== 'â€”') {
        statusBadge = completed
          ? '<span class="badge ok">âœ“</span>'
          : '<span class="badge" style="background:#ff6b6b;color:#fff">â—‹</span>';
      }

      let ratingHtml = 'â€”';
      if (bewertung) {
        const stars = 'â˜…'.repeat(bewertung.rating) + '<span style="opacity:0.3">' + 'â˜…'.repeat(5 - bewertung.rating) + '</span>';
        ratingHtml = `<span style="color:#ffd700">${stars}</span>`;
      }

      rows.push(`<tr><td>${id}</td><td>${person} ${statusBadge}</td><td>${ratingHtml}</td></tr>`);
    }
    el.innerHTML = `<table><thead><tr><th>Datum</th><th>Person</th><th>Bewertung</th></tr></thead><tbody>${rows.join('')}</tbody></table>`;
  }

  /* Initialisierung */
  async function init(){
    // Kernteam aus Firebase laden
    if(db) {
      try {
        const snap = await db.collection(STATE_COLLECTION).doc("global").get();
        if(snap.exists && snap.data().core && Array.isArray(snap.data().core)) {
          CORE = snap.data().core;
        }
      } catch(e) { console.error('Fehler beim Laden des Kernteams:', e); }
    }

    renderPeopleRow();
    updateSelectionUI();
    setMode(showMode);
    renderCatTabs();
    await loadTasks();
    await Promise.all([updateTodayInfo(), renderNextDays(), renderTasks(), renderHistory()]);

    // Bewertungsdaten laden
    if (db) {
      const todayDoc = await db.collection('hausdienst').doc(todayStr()).get();
      const yesterdayDoc = await db.collection('hausdienst').doc(getYesterdayStr()).get();
      todayPerson = todayDoc.exists ? todayDoc.data().person : null;
      yesterdayPerson = yesterdayDoc.exists ? yesterdayDoc.data().person : null;

      if (todayPerson && yesterdayPerson) {
        const existingRating = await db.collection('bewertungen')
          .where('date', '==', getYesterdayStr())
          .where('bewertetVon', '==', todayPerson)
          .get();
        if (!existingRating.empty) {
          existingRatingId = existingRating.docs[0].id;
          existingRatingData = existingRating.docs[0].data();
        }
      }
      updateHdStatus();
    }

    // Tab auswÃ¤hlen (nach dem Laden der Daten)
    pickTabFromQuery();

    scheduleMidnightRefresh(async ()=>{
      localStorage.removeItem(CHECKED_KEY);
      checked={};
      modalRating = 0;
      existingRatingId = null;
      existingRatingData = null;
      todayPerson = null;
      yesterdayPerson = null;
      await updateTodayInfo();
      await renderTasks(true);
      await renderNextDays();
      renderHistory();
    });
  }
  init();
</script>

<!-- âœ… Service Worker Registrierung -->
<script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('./sw.js?v=21', { scope: './' })
      .catch(() => {});
  }
</script>
</body>
</html>
