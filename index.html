<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Logo entfernt, damit die Tabelle mehr Platz hat -->
  <div id="tableContainer" style="flex-grow:1; overflow:auto;"></div>

  <!-- Buttons unten -->
  <div class="footer">
    <button class="btn add" onclick="openDrinkModal()">➕ Getränk</button>
    <button class="btn undo" onclick="undoLast()">↩ Rückgängig</button>
    <button class="btn paypal" onclick="togglePayPal()">💸 PayPal</button>
    <button id="deleteBtn" class="btn delete" onclick="toggleDeleteMode()">🗑 Löschen</button>
    <button class="btn" style="background:#444; color:#fff;" onclick="window.location='buchungen.html'">📖 Buchungen</button>
    <button class="btn" style="background:#444; color:#fff;" onclick="openHausdienstModal()">🏠 Hausdienst</button>
  </div>

  <!-- PayPal Modal -->
  <div id="paypalModal" class="modal" onclick="togglePayPal()">
    <img src="frame.png" alt="PayPal QR">
  </div>

  <!-- Hausdienst Modal -->
  <div id="hausdienstModal" class="modal">
    <div class="modal-content">
      <h2>🏠 Hausdienst</h2>
      <div class="modal-buttons">
        <button class="btn" style="background:#00c9a7; color:#000;" onclick="window.location='hausdienst.html'">🏆 Rangliste</button>
        <button class="btn" style="background:#444; color:#fff;" onclick="window.location='hausdienst_checklist.html'">📋 Checkliste</button>
      </div>
      <br>
      <button class="btn reset" onclick="closeModal('hausdienstModal')">Abbrechen</button>
    </div>
  </div>

  <!-- Person hinzufügen Modal -->
  <div id="personModal" class="modal">
    <div class="modal-content">
      <h2>➕ Neue Person</h2>
      <input id="personName" type="text" placeholder="Name eingeben">
      <div class="modal-buttons">
        <button class="btn add" onclick="confirmAddPerson()">Speichern</button>
        <button class="btn reset" onclick="closeModal('personModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Getränk hinzufügen Modal -->
  <div id="drinkModal" class="modal">
    <div class="modal-content">
      <h2>🥤 Neues Getränk</h2>
      <input id="drinkName" type="text" placeholder="Name des Getränks">
      <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (€)">
      <div class="modal-buttons">
        <button class="btn add" onclick="confirmAddDrink()">Speichern</button>
        <button class="btn reset" onclick="closeModal('drinkModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs klassisch laden -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js"></script>

  <!-- Deine App-Logik -->
  <script>
    // 1. Firebase initialisieren
    const firebaseConfig = {
      apiKey: "AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",
      authDomain: "sickandsound-e9704.firebaseapp.com",
      projectId: "sickandsound-e9704",
      storageBucket: "sickandsound-e9704.firebasestorage.app",
      messagingSenderId: "248197359659",
      appId: "1:248197359659:web:a8777cbed3f83d6b1ca26e",
      measurementId: "G-62LH8V7S2E"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();

    // 2. Keys & Default-State
    const pricesKey     = "sick_sound_prices";
    const peopleKey     = "sick_sound_people";
    const dataKey       = "sick_sound_data";
    const historyKey    = "sick_sound_history";
    const bookingsKey   = "sick_sound_bookings";
    const hausdienstKey = "sick_sound_hausdienst";
    const orderKey      = "sick_sound_order";

    let prices      = { "Cola_Zero":1.0, "Monster":1.5, "Wasser":0.5, "Kaffee":1.0, "Mittagessen":6.0 };
    let people      = [];
    let data        = {};
    let history     = [];
    let bookings    = [];
    let hausdienst  = { current:null, stats:{} };
    let columnOrder = [];

    // 3. State laden (Firestore → Fallback lokalen Speicher)
    async function loadState() {
      try {
        const snap = await db.collection("state").doc("global").get();
        if (snap.exists) {
          const s = snap.data();
          prices      = s.prices      || prices;
          people      = s.people      || ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
          data        = s.data        || data;
          history     = s.history     || history;
          bookings    = s.bookings    || bookings;
          hausdienst  = s.hausdienst  || hausdienst;
          columnOrder = s.columnOrder || Object.keys(prices);
        } else {
          people      = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
          columnOrder = Object.keys(prices);
          await saveAll();
        }
      } catch (e) {
        console.warn("Firestore-Laden fehlgeschlagen, nutze localStorage:", e);
        prices      = JSON.parse(localStorage.getItem(pricesKey))     || prices;
        people      = JSON.parse(localStorage.getItem(peopleKey))     || ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
        data        = JSON.parse(localStorage.getItem(dataKey))       || data;
        history     = JSON.parse(localStorage.getItem(historyKey))    || history;
        bookings    = JSON.parse(localStorage.getItem(bookingsKey))   || bookings;
        hausdienst  = JSON.parse(localStorage.getItem(hausdienstKey)) || hausdienst;
        columnOrder = JSON.parse(localStorage.getItem(orderKey))      || Object.keys(prices);
      }
      buildTable();
    }

    // 4. State speichern (localStorage + Firestore)
    async function saveAll() {
      // a) lokal
      localStorage.setItem(pricesKey,     JSON.stringify(prices));
      localStorage.setItem(peopleKey,     JSON.stringify(people));
      localStorage.setItem(dataKey,       JSON.stringify(data));
      localStorage.setItem(historyKey,    JSON.stringify(history));
      localStorage.setItem(bookingsKey,   JSON.stringify(bookings));
      localStorage.setItem(hausdienstKey, JSON.stringify(hausdienst));
      localStorage.setItem(orderKey,      JSON.stringify(columnOrder));

      // b) Firestore
      try {
        await db.collection("state").doc("global").set({
          prices, people, data, history, bookings, hausdienst, columnOrder
        }, { merge: true });
      } catch (e) {
        console.error("Firestore-Speichern fehlgeschlagen:", e);
      }
    }

    // 5. Realtime-Updates
    db.collection("state").doc("global")
      .onSnapshot(snap => {
        if (!snap.exists) return;
        const s = snap.data();
        prices      = s.prices      || prices;
        people      = s.people      || people;
        data        = s.data        || data;
        history     = s.history     || history;
        bookings    = s.bookings    || bookings;
        hausdienst  = s.hausdienst  || hausdienst;
        columnOrder = s.columnOrder || columnOrder;
        buildTable();
      });

    // 6. UI-Funktionen (wie zuvor)
    function buildTable() {
      people.sort();
      let html = `<table id="mainTable"><thead><tr><th>Person</th>`;
      columnOrder.forEach(drink => {
        if (prices[drink] !== undefined) {
          html += `<th draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" data-drink="${drink}" onclick="deleteColumn('${drink}')">${drink.replace('_',' ')}<br>(${prices[drink]}€)</th>`;
        }
      });
      html += `<th>Gesamt (€)</th><th>Reset</th></tr></thead><tbody>`;
      people.forEach(person => {
        const hausdienstMark = hausdienst.current===person ? "hausdienst" : "";
        html += `<tr><th class="${hausdienstMark}" onclick="deletePerson('${person}')">${person}</th>`;
        columnOrder.forEach(drink => {
          if (prices[drink] !== undefined) {
            const id = `${person}_${drink}`;
            const val = data[id]||0;
            html += `<td><div id="${id}" class="counter">${val}</div><button class="btn plus" onclick="changeValue('${id}',1)">+1</button></td>`;
          }
        });
        html += `<td id="${person}_Total">0.00</td>`;
        html += `<td><button class="btn reset" onclick="resetPerson('${person}')">Reset</button></td>`;
        html += `</tr>`;
      });
      html += `<tr class="add-person-row"><td colspan="${columnOrder.length+3}" onclick="openPersonModal()">➕ Person hinzufügen</td></tr>`;
      html += `</tbody></table>`;
      document.getElementById("tableContainer").innerHTML = html;
      updateAllTotals();
    }
    function drag(ev){ ev.dataTransfer.setData("drink", ev.target.dataset.drink); }
    function allowDrop(ev){ ev.preventDefault(); }
    function drop(ev){
      ev.preventDefault();
      const from = ev.dataTransfer.getData("drink");
      const to   = ev.target.dataset.drink;
      if (from && to && from !== to) {
        columnOrder.splice(columnOrder.indexOf(from),1);
        columnOrder.splice(columnOrder.indexOf(to),0,from);
        saveAll();
        buildTable();
      }
    }
    function changeValue(id, delta){
      const el  = document.getElementById(id);
      const cur = parseInt(el.textContent || '0');
      const nxt = Math.max(0, cur + delta);
      history.push({ id, prev: cur, action: "change" });
      data[id] = nxt;
      el.textContent = nxt;
      updateTotal(id.split('_')[0]);
      saveAll();
    }
    function updateTotal(person){
      let tot = 0;
      columnOrder.forEach(d => tot += (data[`${person}_${d}`]||0)*prices[d]);
      document.getElementById(`${person}_Total`).textContent = tot.toFixed(2);
    }
    function updateAllTotals(){ people.forEach(p => updateTotal(p)); }
    function resetPerson(person){
      if (!confirm(`Alle Striche von ${person} zurücksetzen?`)) return;
      const sum = parseFloat(document.getElementById(`${person}_Total`).textContent);
      history.push({ person, sum, action: "reset" });
      bookings.push({ date:new Date().toLocaleDateString("de-DE"), person, sum });
      Object.keys(prices).forEach(d => data[`${person}_${d}`] = 0);
      document.getElementById(`${person}_Total`).textContent = "0.00";
      saveAll();
      buildTable();
    }
    function undoLast(){
      const last = history.pop();
      if (!last) return;
      if (last.action==="change") data[last.id] = last.prev;
      else if (last.action==="reset") bookings = bookings.filter(b => !(b.person===last.person && b.sum===last.sum));
      saveAll();
      buildTable();
    }
    function openPersonModal(){ toggleModal("personModal","flex"); }
    function openDrinkModal(){ toggleModal("drinkModal","flex"); }
    function openHausdienstModal(){ toggleModal("hausdienstModal","flex"); }
    function togglePayPal(){ toggleModal("paypalModal"); }
    function toggleDeleteMode(){
      deleteMode = !deleteMode;
      const btn = document.getElementById("deleteBtn");
      if (deleteMode){ btn.classList.add("delete-active"); alert("🗑 Löschmodus aktiviert."); }
      else btn.classList.remove("delete-active");
    }
    function deletePerson(person){
      if (!deleteMode) return;
      if (confirm(`${person} wirklich löschen?`)){
        people = people.filter(p=>p!==person);
        saveAll();
      }
      deleteMode = false;
      document.getElementById("deleteBtn").classList.remove("delete-active");
      buildTable();
    }
    function deleteColumn(drink){
      if (!deleteMode) return;
      if (confirm(`Getränk "${drink}" wirklich löschen?`)){
        delete prices[drink];
        columnOrder = columnOrder.filter(d=>d!==drink);
        saveAll();
      }
      deleteMode = false;
      document.getElementById("deleteBtn").classList.remove("delete-active");
      buildTable();
    }
    function confirmAddPerson(){
      const name = document.getElementById("personName").value.trim();
      if (!name) return alert("Bitte Name eingeben!");
      if (people.includes(name)) return alert("Person existiert bereits!");
      people.push(name);
      saveAll(); buildTable(); closeModal("personModal");
      document.getElementById("personName").value = "";
    }
    function confirmAddDrink(){
      const name  = document.getElementById("drinkName").value.trim();
      const price = parseFloat(document.getElementById("drinkPrice").value);
      if (!name || isNaN(price) || price<=0) return alert("Bitte gültige Eingaben machen!");
      const key = name.replace(/\s+/g,"_");
      prices[key] = price;
      if (!columnOrder.includes(key)) columnOrder.push(key);
      saveAll(); buildTable(); closeModal("drinkModal");
      document.getElementById("drinkName").value = "";
      document.getElementById("drinkPrice").value = "";
    }
    function closeModal(id){ document.getElementById(id).style.display = "none"; }
    function toggleModal(id, display="flex"){
      const m = document.getElementById(id);
      m.style.display = (m.style.display===display) ? "none" : display;
    }

    // 7. App starten
    window.onload = loadState;
  </script>
</body>
</html>
