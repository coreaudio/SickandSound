<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <style>
    html, body {
      height: 100%;
      overflow: hidden;
      background-color: #0f1117;
      font-family: 'Orbitron', sans-serif;
      color: #f1f1f1;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }
    .btn {
      padding: 10px 16px;
      font-size: 1em;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 10px rgba(0,0,0,0.4);
    }
    .plus { background-color: #00c9a7; color: #000; }
    .reset { background-color: #555; color: #fff; }
    .undo { background-color: #ffa500; color: #000; }
    .paypal { background-color: #0070ba; color: #fff; }
    .delete { background-color: #ff4444; color: #fff; }
    .counter { font-size: 1.2em; margin-bottom: 5px; font-weight: bold; }
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #1a1d24;
      table-layout: fixed;
      font-size: 0.9em;
      flex-grow: 1;
      overflow-y: auto;
    }
    th, td {
      padding: 6px;
      text-align: center;
      border-bottom: 1px solid #2a2d34;
    }
    th {
      font-size: 1em;
      font-weight: 600;
      color: #ffffff;
      cursor: pointer;
    }
    td:last-child {
      font-weight: bold;
      color: #ffd700;
    }
    .footer {
      margin-top: auto;
      padding: 10px 0;
      display: flex;
      justify-content: center;
      gap: 20px;
    }
    .gold { color: gold; }
    .silver { color: silver; }
    .bronze { color: #cd7f32; }
    #paypalModal {
      display:none; position:fixed; top:0; left:0; width:100%; height:100%;
      background-color:rgba(0,0,0,0.85); justify-content:center; align-items:center; z-index:9999;
    }
    #paypalModal img {
      max-width:90%; max-height:90%; border:8px solid #fff; border-radius:12px;
    }
  </style>
</head>
<body>
  <div style="text-align:center; margin-bottom: 10px;">
    <img src="02_SICK _ SOUND_WHITE_TYPE.png" alt="Sick & Sound Logo" style="max-width: 300px; height: auto;">
  </div>

  <div id="tableContainer" style="flex-grow:1; overflow:auto;"></div>

  <!-- Buttons unten -->
  <div class="footer">
    <button class="btn undo" onclick="undoLast()">‚Ü© R√ºckg√§ngig</button>
    <button class="btn paypal" onclick="togglePayPal()">üí∏ PayPal</button>
    <button class="btn delete" onclick="toggleDeleteMode()">üóë L√∂schen</button>
    <button class="btn" style="background:#444; color:#fff;" onclick="window.location='buchungen.html'">üìñ Buchungen</button>
    <button class="btn" style="background:#444; color:#fff;" onclick="window.location='hausdienst.html'">üèÜ Hausdienst Rangliste</button>
  </div>

  <!-- PayPal Modal -->
  <div id="paypalModal" onclick="togglePayPal()">
    <img src="frame.png" alt="PayPal QR">
  </div>

  <script>
    const pricesKey = "sick_sound_prices";
    const peopleKey = "sick_sound_people";
    const dataKey = "sick_sound_data";
    const historyKey = "sick_sound_history";
    const bookingsKey = "sick_sound_bookings";
    const hausdienstKey = "sick_sound_hausdienst";

    let prices = JSON.parse(localStorage.getItem(pricesKey)) || {
      "Cola_Zero": 1.0,
      "Monster": 1.5,
      "Wasser": 0.5,
      "Kaffee": 1.0,
      "Mittagessen": 6.0
    };
    let people = JSON.parse(localStorage.getItem(peopleKey)) || ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
    let data = JSON.parse(localStorage.getItem(dataKey)) || {};
    let history = JSON.parse(localStorage.getItem(historyKey)) || [];
    let bookings = JSON.parse(localStorage.getItem(bookingsKey)) || [];
    let hausdienst = JSON.parse(localStorage.getItem(hausdienstKey)) || { current: null, stats: {} };
    let deleteMode = false;

    function saveAll(){
      localStorage.setItem(pricesKey, JSON.stringify(prices));
      localStorage.setItem(peopleKey, JSON.stringify(people));
      localStorage.setItem(dataKey, JSON.stringify(data));
      localStorage.setItem(historyKey, JSON.stringify(history));
      localStorage.setItem(bookingsKey, JSON.stringify(bookings));
      localStorage.setItem(hausdienstKey, JSON.stringify(hausdienst));
    }

    function buildTable(){
      people.sort();
      let html = `<table><thead><tr><th>Person</th>`;
      for (const drink in prices){
        html += `<th data-col="${drink}" onclick="handleColumnClick('${drink}')">${drink.replace('_',' ')}<br>(${prices[drink]}‚Ç¨)</th>`;
      }
      html += `<th>Gesamt (‚Ç¨)</th><th>Reset</th></tr></thead><tbody>`;

      people.forEach(person=>{
        let rankClass = "";
        let stats = Object.entries(hausdienst.stats||{}).sort((a,b)=>b[1]-a[1]);
        if (stats[0] && stats[0][0]===person) rankClass="gold";
        else if (stats[1] && stats[1][0]===person) rankClass="silver";
        else if (stats[2] && stats[2][0]===person) rankClass="bronze";

        html += `<tr><th class="${rankClass}" onclick="handlePersonClick('${person}')">${person}</th>`;
        for (const drink in prices){
          const id = `${person}_${drink}`;
          const val = data[id]||0;
          html += `<td><div id="${id}" class="counter">${val}</div><button class="btn plus" onclick="changeValue('${id}',1)">+1</button></td>`;
        }
        html += `<td id="${person}_Total">0.00</td>
                 <td><button class="btn reset" onclick="resetPerson('${person}')">Reset</button></td></tr>`;
      });

      html += `</tbody></table>`;
      document.getElementById("tableContainer").innerHTML = html;
      updateAllTotals();
    }

    function changeValue(id,delta){
      const el=document.getElementById(id);
      const current=parseInt(el.textContent||'0');
      const next=Math.max(0,current+delta);
      history.push({id,prev:current,action:"change"});
      data[id]=next;
      el.textContent=next;
      updateTotal(id.split('_')[0]);
      saveAll();
    }

    function updateTotal(person){
      let total=0;
      for (const drink in prices){
        const id=`${person}_${drink}`;
        total += (data[id]||0)*prices[drink];
      }
      document.getElementById(person+"_Total").textContent=total.toFixed(2);
    }

    function updateAllTotals(){
      people.forEach(p=>updateTotal(p));
    }

    function resetPerson(person){
      if (!confirm(`Alle Striche von ${person} zur√ºcksetzen?`)) return;
      let sum=parseFloat(document.getElementById(person+"_Total").textContent);
      history.push({person,sum,action:"reset"});
      bookings.push({date:new Date().toLocaleDateString("de-DE"),person,sum});
      for (const drink in prices){
        const id=`${person}_${drink}`;
        data[id]=0;
      }
      document.getElementById(person+"_Total").textContent="0.00";
      saveAll();
      buildTable();
    }

    function undoLast(){
      const last=history.pop();
      if (!last) return;
      if (last.action==="change"){
        data[last.id]=last.prev;
        document.getElementById(last.id).textContent=last.prev;
        updateTotal(last.id.split('_')[0]);
      } else if (last.action==="reset"){
        bookings=bookings.filter(b=>!(b.person===last.person && b.sum===last.sum));
      }
      saveAll();
      buildTable();
    }

    function togglePayPal(){
      const modal=document.getElementById('paypalModal');
      modal.style.display=(modal.style.display==="flex")?"none":"flex";
    }

    function toggleDeleteMode(){
      deleteMode=!deleteMode;
      alert(deleteMode?"L√∂schmodus aktiv: Klicke auf Spalte oder Person":"L√∂schmodus deaktiviert");
    }

    function handleColumnClick(drink){
      if (!deleteMode) return;
      if (!confirm(`${drink} wirklich l√∂schen?`)) return;
      delete prices[drink];
      for (let key in data){
        if (key.endsWith("_"+drink)) delete data[key];
      }
      saveAll();
      buildTable();
    }

    function handlePersonClick(person){
      if (!deleteMode) return;
      if (!confirm(`${person} wirklich l√∂schen?`)) return;
      people = people.filter(p=>p!==person);
      for (let key in data){
        if (key.startsWith(person+"_")) delete data[key];
      }
      saveAll();
      buildTable();
    }

    window.onload=()=>buildTable();
  </script>
</body>
</html>
