<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick &amp; Sound Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div id="tableContainer" style="flex-grow:1; overflow:hidden;"></div>

  <div class="footer">
    <button id="addDrinkBtn" class="btn add">â• GetrÃ¤nk hinzufÃ¼gen</button>
    <button id="undoBtn" class="btn undo">â†© RÃ¼ckgÃ¤ngig</button>
    <button id="paypalBtn" class="btn paypal">ğŸ’¸ PayPal</button>
    <button id="deleteBtn" class="btn delete">ğŸ—‘ LÃ¶schen</button>
    <button id="buchungenBtn" class="btn" style="background:#444; color:#fff;">ğŸ“– Buchungen</button>
    <button id="hausdienstBtn" class="btn" style="background:#444; color:#fff;">ğŸ  Hausdienst</button>
  </div>

  <!-- PayPal Modal -->
  <div id="paypalModal" class="modal" onclick="toggleModal('paypalModal')">
    <img src="frame.png" alt="PayPal QR">
  </div>

  <!-- Hausdienst Auswahl Modal -->
  <div id="hausdienstModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ  Hausdienst</h2>
      <div class="modal-buttons">
        <button class="btn" style="background:#00c9a7; color:#000;" onclick="navigateHausdienst('hausdienst.html')">ğŸ† Rangliste</button>
        <button class="btn" style="background:#444; color:#fff;" onclick="navigateHausdienst('hausdienst_checklist.html')">ğŸ“‹ Checkliste</button>
      </div>
      <br>
      <button class="btn reset" onclick="toggleModal('hausdienstModal')">Abbrechen</button>
    </div>
  </div>

  <!-- Person hinzufÃ¼gen Modal -->
  <div id="personModal" class="modal">
    <div class="modal-content">
      <h2>â• Neue Person</h2>
      <input id="personName" type="text" placeholder="Name eingeben">
      <div class="modal-buttons">
        <button id="confirmAddPersonBtn" class="btn add">Speichern</button>
        <button class="btn reset" onclick="toggleModal('personModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- GetrÃ¤nk hinzufÃ¼gen Modal -->
  <div id="drinkModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ¥¤ Neues GetrÃ¤nk</h2>
      <input id="drinkName" type="text" placeholder="Name des GetrÃ¤nks">
      <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (â‚¬)">
      <div class="modal-buttons">
        <button id="confirmAddDrinkBtn" class="btn add">Speichern</button>
        <button class="btn reset" onclick="toggleModal('drinkModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp }     from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getDatabase, ref, onValue, set, push, remove } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";
    import Sortable              from "https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/modular/sortable.esm.js";

    // 1) Standard-Daten
    const DEFAULT_PRICES  = { Cola_Zero:1.0, Monster:1.5, Wasser:0.5, Kaffee:1.0, Mittagessen:6.0 };
    const DEFAULT_PEOPLE  = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
    const DEFAULT_ORDER   = Object.keys(DEFAULT_PRICES);

    // 2) Firebase initialisieren
    const firebaseConfig = {
      apiKey: "AIzaSyCSQuBqp-wVTXLNp3OtIQjKyOFyMulMvbQ",
      authDomain:"sickandsound-be902.firebaseapp.com",
      databaseURL:"https://sickandsound-be902-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"sickandsound-be902",
      storageBucket:"sickandsound-be902.appspot.com",
      messagingSenderId:"797518207823",
      appId:"1:797518207823:web:35a1dfdd95ab2a49a8c33a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // 3) Referenzen
    const pricesRef     = ref(db,'strichliste/prices');
    const peopleRef     = ref(db,'strichliste/people');
    const dataRef       = ref(db,'strichliste/data');
    const bookingsRef   = ref(db,'strichliste/bookings');
    const hausdienstRef = ref(db,'strichliste/hausdienst');
    const orderRef      = ref(db,'strichliste/order');

    // 4) Lokale Variablen
    let prices      = {};
    let people      = [];
    let data        = {};
    let history     = [];
    let bookings    = [];
    let hausdienst  = { current:null, stats:{} };
    let columnOrder = [];

    // 5) Liveâ€Sync & Fallback initialisieren
    onValue(pricesRef, snap => {
      if (snap.exists()) {
        prices = snap.val();
      } else {
        prices = DEFAULT_PRICES;
        set(pricesRef, prices);
      }
      buildTable();
    });
    onValue(peopleRef, snap => {
      if (snap.exists()) {
        people = snap.val();
      } else {
        people = DEFAULT_PEOPLE;
        set(peopleRef, people);
      }
      buildTable();
    });
    onValue(dataRef, snap => {
      data = snap.exists() ? snap.val() : {};
      updateAllTotals();
    });
    onValue(bookingsRef, snap => {
      bookings = snap.exists() ? snap.val() : [];
    });
    onValue(hausdienstRef, snap => {
      hausdienst = snap.exists() ? snap.val() : { current:null, stats:{} };
      set(hausdienstRef, hausdienst);
      buildTable();
    });
    onValue(orderRef, snap => {
      if (snap.exists()) {
        columnOrder = snap.val();
      } else {
        columnOrder = DEFAULT_ORDER;
        set(orderRef, columnOrder);
      }
      buildTable();
    });

    // 6) Speichern
    function savePrices()     { set(pricesRef, prices); }
    function savePeople()     { set(peopleRef, people); }
    function saveData()       { set(dataRef, data); }
    function saveBookings()   { set(bookingsRef, bookings); }
    function saveHausdienst(){ set(hausdienstRef, hausdienst); }
    function saveOrder()      { set(orderRef, columnOrder); }

    // 7) Aufbau & Funktionen
    function buildTable(){
      people.sort();
      let html = `<table><thead><tr><th>Person</th>`;
      columnOrder.forEach(drink => {
        if (prices[drink] !== undefined) {
          html += `<th data-drink="${drink}">${drink.replace('_',' ')}<br>(${prices[drink]}â‚¬)</th>`;
        }
      });
      html += `<th>Gesamt (â‚¬)</th><th>Reset</th></tr></thead><tbody>`;
      people.forEach(person => {
        const mark = hausdienst.current===person ? "hausdienst" : "";
        html += `<tr><th class="${mark}" onclick="deletePerson('${person}')">${person}</th>`;
        columnOrder.forEach(drink => {
          if (prices[drink] !== undefined) {
            const id = `${person}_${drink}`, val = data[id]||0;
            html += `<td><div id="${id}" class="counter">${val}</div>
                      <button class="btn plus" onclick="changeValue('${id}',1)">+1</button></td>`;
          }
        });
        html += `<td id="${person}_Total">0.00</td>
                 <td><button class="btn reset" onclick="resetPerson('${person}')">Reset</button></td></tr>`;
      });
      // â• Person hinzufÃ¼gen
      html += `<tr class="add-person-row">
                 <td colspan="${columnOrder.length+3}" onclick="toggleModal('personModal')">â• Person hinzufÃ¼gen</td>
               </tr>`;
      html += `</tbody></table>`;
      document.getElementById("tableContainer").innerHTML = html;
      updateAllTotals();

      // SortableJS initialisieren (Maus + Touch)
      new Sortable(document.querySelector("thead tr"), {
        animation:150,
        filter: "th:first-child, th:last-child",
        onEnd: () => {
          const cols = Array.from(document.querySelectorAll("thead th"))
                            .map(th=>th.dataset.drink)
                            .filter(Boolean);
          columnOrder = cols;
          saveOrder();
          buildTable();
        }
      });
    }

    function changeValue(id, delta){
      const el = document.getElementById(id),
            cur = parseInt(el.textContent||'0'),
            nxt = Math.max(0, cur+delta);
      history.push({id,prev:cur,action:"change"});
      data[id] = nxt;
      el.textContent = nxt;
      updateTotal(id.split('_')[0]);
      saveData();
    }

    function updateTotal(person){
      let total=0;
      columnOrder.forEach(drink=>{
        total += (data[`${person}_${drink}`]||0)*prices[drink];
      });
      document.getElementById(person+"_Total").textContent=total.toFixed(2);
    }

    function updateAllTotals(){ people.forEach(p=>updateTotal(p)); }

    function resetPerson(person){
      if (!confirm(`Alle Striche von ${person} zurÃ¼cksetzen?`)) return;
      const sum = parseFloat(document.getElementById(person+"_Total").textContent);
      history.push({person,sum,action:"reset"});
      bookings.push({date:new Date().toLocaleDateString("de-DE"),person,sum});
      columnOrder.forEach(drink=> data[`${person}_${drink}`]=0);
      saveBookings(); saveData(); buildTable();
    }

    function undoLast(){
      const last = history.pop(); if(!last) return;
      if (last.action==="change") data[last.id] = last.prev;
      else if (last.action==="reset")
        bookings = bookings.filter(b=>!(b.person===last.person && b.sum===last.sum));
      saveData(); saveBookings(); buildTable();
    }

    function deletePerson(person){
      if (!deleteMode) return;
      if (confirm(`${person} wirklich lÃ¶schen?`)) {
        people = people.filter(p=>p!==person);
        savePeople();
      }
      toggleDeleteMode();
    }

    function confirmAddPerson(){
      const name = document.getElementById("personName").value.trim();
      if (!name) return alert("Bitte Name eingeben!");
      if (people.includes(name)) return alert("Person existiert bereits!");
      people.push(name); savePeople(); buildTable(); toggleModal('personModal');
    }

    function confirmAddDrink(){
      const name = document.getElementById("drinkName").value.trim(),
            price= parseFloat(document.getElementById("drinkPrice").value);
      if (!name||isNaN(price)||price<=0) return alert("Bitte gÃ¼ltige Eingaben!");
      const key = name.replace(/ /g,"_");
      prices[key] = price;
      if (!columnOrder.includes(key)) columnOrder.push(key);
      savePrices(); saveOrder(); buildTable(); toggleModal('drinkModal');
    }

    let deleteMode = false;
    function toggleDeleteMode(){
      deleteMode = !deleteMode;
      document.getElementById("deleteBtn").classList.toggle("delete-active", deleteMode);
      if (deleteMode) alert("ğŸ—‘ LÃ¶schmodus aktiviert");
    }

    function navigateHausdienst(url){
      toggleModal('hausdienstModal');
      window.location = url;
    }

    function toggleModal(id){
      const m = document.getElementById(id);
      m.style.display = (m.style.display==="flex"?"none":"flex");
    }

    window.onload = ()=>{
      buildTable();
      document.getElementById("undoBtn").addEventListener("click", undoLast);
      document.getElementById("paypalBtn").addEventListener("click", ()=>toggleModal('paypalModal'));
      document.getElementById("addDrinkBtn").addEventListener("click", ()=>toggleModal('drinkModal'));
      document.getElementById("confirmAddDrinkBtn").addEventListener("click", confirmAddDrink);
      document.getElementById("confirmAddPersonBtn").addEventListener("click", confirmAddPerson);
      document.getElementById("buchungenBtn").addEventListener("click", ()=>location.href='buchungen.html');
      document.getElementById("hausdienstBtn").addEventListener("click", ()=>toggleModal('hausdienstModal'));
      document.getElementById("deleteBtn").addEventListener("click", toggleDeleteMode);
    };
  </script>
</body>
</html>
