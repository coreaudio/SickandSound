<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick &amp; Sound Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
  <div id="tableContainer" style="flex-grow:1; overflow:hidden;"></div>

  <div class="footer">
    <button id="addDrinkBtn" class="btn add">â• GetrÃ¤nk hinzufÃ¼gen</button>
    <button id="undoBtn" class="btn undo">â†© RÃ¼ckgÃ¤ngig</button>
    <button id="paypalBtn" class="btn paypal">ğŸ’¸ PayPal</button>
    <button id="deleteBtn" class="btn delete">ğŸ—‘ LÃ¶schen</button>
    <button id="buchungenBtn" class="btn" style="background:#444;color:#fff;">ğŸ“– Buchungen</button>
    <button id="hausdienstBtn" class="btn" style="background:#444;color:#fff;">ğŸ  Hausdienst</button>
  </div>

  <!-- PayPal Modal -->
  <div id="paypalModal" class="modal" onclick="toggleModal('paypalModal')">
    <img src="frame.png" alt="PayPal QR">
  </div>

  <!-- Hausdienst-Auswahl Modal -->
  <div id="hausdienstModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ  Hausdienst</h2>
      <div class="modal-buttons">
        <button class="btn" style="background:#00c9a7;color:#000;"
                onclick="navigateHausdienst('hausdienst.html')">ğŸ† Rangliste</button>
        <button class="btn" style="background:#444;color:#fff;"
                onclick="navigateHausdienst('hausdienst_checklist.html')">ğŸ“‹ Checkliste</button>
      </div>
      <br>
      <button class="btn reset" onclick="toggleModal('hausdienstModal')">Abbrechen</button>
    </div>
  </div>

  <!-- Person hinzufÃ¼gen Modal -->
  <div id="personModal" class="modal">
    <div class="modal-content">
      <h2>â• Neue Person</h2>
      <input id="personName" type="text" placeholder="Name eingeben">
      <div class="modal-buttons">
        <button id="confirmAddPersonBtn" class="btn add">Speichern</button>
        <button class="btn reset" onclick="toggleModal('personModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- GetrÃ¤nk hinzufÃ¼gen Modal -->
  <div id="drinkModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ¥¤ Neues GetrÃ¤nk</h2>
      <input id="drinkName" type="text" placeholder="Name des GetrÃ¤nks">
      <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (â‚¬)">
      <div class="modal-buttons">
        <button id="confirmAddDrinkBtn" class="btn add">Speichern</button>
        <button class="btn reset" onclick="toggleModal('drinkModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import {
      getDatabase,
      ref,
      onValue,
      set
    } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    // Default-Werte
    const DEFAULT_PRICES = { Cola_Zero:1.0, Monster:1.5, Wasser:0.5, Kaffee:1.0, Mittagessen:6.0 };
    const DEFAULT_PEOPLE = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
    const DEFAULT_ORDER  = Object.keys(DEFAULT_PRICES);

    // Firebase konfigurieren
    const firebaseConfig = {
      apiKey: "AIzaSyCSQuBqp-wVTXLNp3OtIQjKyOFyMulMvbQ",
      authDomain:"sickandsound-be902.firebaseapp.com",
      databaseURL:"https://sickandsound-be902-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"sickandsound-be902",
      storageBucket:"sickandsound-be902.appspot.com",
      messagingSenderId:"797518207823",
      appId:"1:797518207823:web:35a1dfdd95ab2a49a8c33a"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // DB-Referenzen
    const pricesRef     = ref(db,'strichliste/prices');
    const peopleRef     = ref(db,'strichliste/people');
    const dataRef       = ref(db,'strichliste/data');
    const bookingsRef   = ref(db,'strichliste/bookings');
    const hausdienstRef = ref(db,'strichliste/hausdienst');
    const orderRef      = ref(db,'strichliste/order');

    let prices      = {};
    let people      = [];
    let data        = {};
    let history     = [];
    let bookings    = [];
    let hausdienst  = { current:null, stats:{} };
    let columnOrder = [];
    let deleteMode  = false;

    function saveAll(){
      set(pricesRef,     prices);
      set(peopleRef,     people);
      set(dataRef,       data);
      set(bookingsRef,   bookings);
      set(hausdienstRef, hausdienst);
      set(orderRef,      columnOrder);
    }

    onValue(pricesRef, snap => {
      prices = snap.exists() ? snap.val() : DEFAULT_PRICES;
      if(!snap.exists()) set(pricesRef, prices);
      buildTable();
    });
    onValue(peopleRef, snap => {
      people = snap.exists() ? snap.val() : DEFAULT_PEOPLE;
      if(!snap.exists()) set(peopleRef, people);
      buildTable();
    });
    onValue(dataRef, snap => { data = snap.exists() ? snap.val() : {}; updateAllTotals(); });
    onValue(bookingsRef, snap => { bookings = snap.exists() ? snap.val() : []; });
    onValue(hausdienstRef, snap => {
      hausdienst = snap.exists() ? snap.val() : { current:null, stats:{} };
      if(!snap.exists()) set(hausdienstRef, hausdienst);
      buildTable();
    });
    onValue(orderRef, snap => {
      columnOrder = snap.exists() ? snap.val() : DEFAULT_ORDER;
      if(!Array.isArray(columnOrder) || columnOrder.length===0){
        columnOrder = Object.keys(prices);
        set(orderRef, columnOrder);
      }
      buildTable();
    });

    function buildTable(){
      people.sort();
      let html = `<table><thead><tr><th>Person</th>`;
      columnOrder.forEach(drink=>{
        if(prices[drink]!=null){
          html += `<th data-drink="${drink}">${drink.replace('_',' ')}<br>(${prices[drink]}â‚¬)</th>`;
        }
      });
      html += `<th>Gesamt (â‚¬)</th><th>Reset</th></tr></thead><tbody>`;

      people.forEach(person=>{
        const mark = hausdienst.current===person ? "hausdienst" : "";
        html += `<tr><th class="${mark}" onclick="deletePerson('${person}')">${person}</th>`;
        columnOrder.forEach(drink=>{
          if(prices[drink]!=null){
            const id=`${person}_${drink}`, val=data[id]||0;
            html += `<td>
                       <div id="${id}" class="counter">${val}</div>
                       <button class="btn plus" onclick="changeValue('${id}',1)">+1</button>
                     </td>`;
          }
        });
        html += `<td id="${person}_Total">0.00</td>
                 <td><button class="btn reset" onclick="resetPerson('${person}')">Reset</button></td></tr>`;
      });

      html += `<tr class="add-person-row">
                 <td colspan="${columnOrder.length+3}" onclick="toggleModal('personModal')">
                   â• Person hinzufÃ¼gen
                 </td>
               </tr>`;
      html += `</tbody></table>`;
      document.getElementById("tableContainer").innerHTML = html;
      updateAllTotals();

      new Sortable(document.querySelector("thead tr"), {
        animation:150,
        filter:"th:first-child, th:last-child",
        onEnd:()=>{
          columnOrder = Array.from(document.querySelectorAll("thead th"))
                              .map(th=>th.dataset.drink)
                              .filter(Boolean);
          set(orderRef, columnOrder);
          buildTable();
        }
      });
    }

    function changeValue(id,delta){
      const el=document.getElementById(id),
            cur=parseInt(el.textContent||'0'),
            nxt=Math.max(0,cur+delta);
      history.push({id,prev:cur,action:"change"});
      data[id]=nxt; el.textContent=nxt;
      updateTotal(id.split('_')[0]);
      set(dataRef,data);
    }

    function updateTotal(person){
      let total=0;
      columnOrder.forEach(drink=>{
        total += (data[`${person}_${drink}`]||0)*prices[drink];
      });
      document.getElementById(person+"_Total").textContent=total.toFixed(2);
    }
    function updateAllTotals(){ people.forEach(p=>updateTotal(p)); }

    function resetPerson(person){
      if(!confirm(`Alle Striche von ${person} zurÃ¼cksetzen?`)) return;
      const sum=parseFloat(document.getElementById(person+"_Total").textContent);
      history.push({person,sum,action:"reset"});
      bookings.push({date:new Date().toLocaleDateString("de-DE"),person,sum});
      columnOrder.forEach(drink=>data[`${person}_${drink}`]=0);
      set(bookingsRef,bookings);
      set(dataRef,data);
      buildTable();
    }

    function undoLast(){
      const last=history.pop(); if(!last) return;
      if(last.action==="change") data[last.id]=last.prev;
      else if(last.action==="reset")
        bookings=bookings.filter(b=>!(b.person===last.person&&b.sum===last.sum));
      set(dataRef,data);
      set(bookingsRef,bookings);
      buildTable();
    }

    function deletePerson(person){
      if(!deleteMode) return;
      if(confirm(`${person} wirklich lÃ¶schen?`)){
        people=people.filter(p=>p!==person);
        set(peopleRef,people);
      }
      toggleDeleteMode();
    }

    function confirmAddPerson(){
      const name=document.getElementById("personName").value.trim();
      if(!name) return alert("Bitte Name eingeben!");
      if(people.includes(name)) return alert("Person existiert bereits!");
      people.push(name);
      set(peopleRef,people);
      toggleModal('personModal');
    }

    function confirmAddDrink(){
      const name=document.getElementById("drinkName").value.trim(),
            price=parseFloat(document.getElementById("drinkPrice").value);
      if(!name||isNaN(price)||price<=0) return alert("Bitte gÃ¼ltige Eingaben!");
      const key=name.replace(/ /g,"_");
      prices[key]=price;
      if(!columnOrder.includes(key)) columnOrder.push(key);
      set(pricesRef,prices);
      set(orderRef,columnOrder);
      toggleModal('drinkModal');
    }

    function toggleDeleteMode(){
      deleteMode=!deleteMode;
      document.getElementById("deleteBtn")
              .classList.toggle("delete-active",deleteMode);
      if(deleteMode) alert("ğŸ—‘ LÃ¶schmodus aktiviert");
    }

    function navigateHausdienst(url){
      toggleModal('hausdienstModal');
      window.location=url;
    }

    function toggleModal(id){
      const m=document.getElementById(id);
      m.style.display=(m.style.display==="flex"?"none":"flex");
    }

    window.onload = ()=>{
      document.getElementById("undoBtn").onclick = undoLast;
      document.getElementById("paypalBtn").onclick = ()=>toggleModal('paypalModal');
      document.getElementById("addDrinkBtn").onclick = ()=>toggleModal('drinkModal');
      document.getElementById("confirmAddDrinkBtn").onclick = confirmAddDrink;
      document.getElementById("confirmAddPersonBtn").onclick = confirmAddPerson;
      document.getElementById("buchungenBtn").onclick = ()=>location.href='buchungen.html';
      document.getElementById("hausdienstBtn").onclick = ()=>toggleModal('hausdienstModal');
      document.getElementById("deleteBtn").onclick = toggleDeleteMode;
      buildTable();
    };
  </script>
</body>
</html>
