<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <!-- Dein externes CSS -->
  <link rel="stylesheet" href="style.css" />

  <!-- Inline-CSS für flexibles Layout und Touch-Scrolling auf Tablets -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
    }
    #tableContainer {
      flex: 1;
      overflow: auto;
      -webkit-overflow-scrolling: touch; /* Momentum-Scroll iOS */
    }
    .footer {
      flex-shrink: 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
      background: #222;
      padding: 0.5rem 0;
    }
    .btn {
      touch-action: manipulation;
      /* ... eventuell weitere Button-Stile ... */
    }
  </style>
</head>
<body>
  <!-- Tabelle -->
  <div id="tableContainer"></div>

  <!-- Footer-Buttons (ohne inline onclick!) -->
  <div class="footer">
    <button id="openDrinkBtn"     class="btn add">➕ Getränk</button>
    <button id="undoBtn"          class="btn undo">↩ Rückgängig</button>
    <button id="paypalBtn"        class="btn paypal">💸 PayPal</button>
    <button id="deleteBtn"        class="btn delete">🗑 Löschen</button>
    <button id="bookingsBtn"      class="btn" style="background:#444; color:#fff;">📖 Buchungen</button>
    <button id="openHausdienstBtn" class="btn" style="background:#444; color:#fff;">🏠 Hausdienst</button>
  </div>

  <!-- PayPal Modal -->
  <div id="paypalModal" class="modal">
    <img src="frame.png" alt="PayPal QR">
  </div>

  <!-- Hausdienst Modal -->
  <div id="hausdienstModal" class="modal">
    <div class="modal-content">
      <h2>🏠 Hausdienst</h2>
      <div class="modal-buttons">
        <button id="hausdienstRankBtn"      class="btn">🏆 Rangliste</button>
        <button id="hausdienstChecklistBtn" class="btn">📋 Checkliste</button>
      </div>
      <br>
      <button id="hausdienstCloseBtn" class="btn reset">Abbrechen</button>
    </div>
  </div>

  <!-- Person hinzufügen Modal -->
  <div id="personModal" class="modal">
    <div class="modal-content">
      <h2>➕ Neue Person</h2>
      <input id="personName" type="text" placeholder="Name eingeben">
      <div class="modal-buttons">
        <button id="confirmAddPersonBtn" class="btn add">Speichern</button>
        <button id="closePersonBtn"      class="btn reset">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- Getränk hinzufügen Modal -->
  <div id="drinkModal" class="modal">
    <div class="modal-content">
      <h2>🥤 Neues Getränk</h2>
      <input id="drinkName"  type="text"   placeholder="Name des Getränks">
      <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (€)">
      <div class="modal-buttons">
        <button id="confirmAddDrinkBtn" class="btn add">Speichern</button>
        <button id="closeDrinkBtn"      class="btn reset">Abbrechen</button>
      </div>
    </div>
  </div>

  <script type="module">
    // 1. Firebase Core + Analytics
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAnalytics }   from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
    // 2. Firestore
    import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    // 3. Firebase-Konfiguration
    const firebaseConfig = {
      apiKey: "AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",
      authDomain: "sickandsound-e9704.firebaseapp.com",
      projectId: "sickandsound-e9704",
      storageBucket: "sickandsound-e9704.firebasestorage.app",
      messagingSenderId: "248197359659",
      appId: "1:248197359659:web:a8777cbed3f83d6b1ca26e",
      measurementId: "G-62LH8V7S2E"
    };

    // 4. Init Firebase & Firestore
    const app       = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db        = getFirestore(app);

    // 5. Keys & Default-State
    const pricesKey     = "sick_sound_prices";
    const peopleKey     = "sick_sound_people";
    const dataKey       = "sick_sound_data";
    const historyKey    = "sick_sound_history";
    const bookingsKey   = "sick_sound_bookings";
    const hausdienstKey = "sick_sound_hausdienst";
    const orderKey      = "sick_sound_order";

    let prices      = { "Cola_Zero":1.0, "Monster":1.5, "Wasser":0.5, "Kaffee":1.0, "Mittagessen":6.0 };
    let people      = [];
    let data        = {};
    let history     = [];
    let bookings    = [];
    let hausdienst  = { current:null, stats:{} };
    let columnOrder = [];

    // 6. State laden (Firestore → Fallback localStorage)
    async function loadState() {
      try {
        const ref  = doc(db, "state", "global");
        const snap = await getDoc(ref);
        if (snap.exists()) {
          const s = snap.data();
          prices      = s.prices      || prices;
          people      = s.people      || ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
          data        = s.data        || data;
          history     = s.history     || history;
          bookings    = s.bookings    || bookings;
          hausdienst  = s.hausdienst  || hausdienst;
          columnOrder = s.columnOrder || Object.keys(prices);
        } else {
          people      = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
          columnOrder = Object.keys(prices);
          await saveAll();
        }
      } catch (e) {
        console.warn("Firestore-Laden fehlgeschlagen, nutze localStorage:", e);
        prices      = JSON.parse(localStorage.getItem(pricesKey))     || prices;
        people      = JSON.parse(localStorage.getItem(peopleKey))     || ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
        data        = JSON.parse(localStorage.getItem(dataKey))       || data;
        history     = JSON.parse(localStorage.getItem(historyKey))    || history;
        bookings    = JSON.parse(localStorage.getItem(bookingsKey))   || bookings;
        hausdienst  = JSON.parse(localStorage.getItem(hausdienstKey)) || hausdienst;
        columnOrder = JSON.parse(localStorage.getItem(orderKey))      || Object.keys(prices);
      }
      buildTable();
    }

    // 7. State speichern (localStorage + Firestore)
    async function saveAll() {
      // localStorage
      localStorage.setItem(pricesKey,     JSON.stringify(prices));
      localStorage.setItem(peopleKey,     JSON.stringify(people));
      localStorage.setItem(dataKey,       JSON.stringify(data));
      localStorage.setItem(historyKey,    JSON.stringify(history));
      localStorage.setItem(bookingsKey,   JSON.stringify(bookings));
      localStorage.setItem(hausdienstKey, JSON.stringify(hausdienst));
      localStorage.setItem(orderKey,      JSON.stringify(columnOrder));
      // Firestore
      try {
        const ref = doc(db, "state", "global");
        await setDoc(ref, { prices, people, data, history, bookings, hausdienst, columnOrder }, { merge: true });
      } catch (e) {
        console.error("Firestore-Speichern fehlgeschlagen:", e);
      }
    }

    // 8. Realtime-Updates
    onSnapshot(doc(db, "state", "global"), snap => {
      if (!snap.exists()) return;
      const s = snap.data();
      prices      = s.prices      || prices;
      people      = s.people      || people;
      data        = s.data        || data;
      history     = s.history     || history;
      bookings    = s.bookings    || bookings;
      hausdienst  = s.hausdienst  || hausdienst;
      columnOrder = s.columnOrder || columnOrder;
      buildTable();
    });

    // 9. Table-Builder mit data-Attributen
    function buildTable() {
      people.sort();
      let html = `<table id="mainTable"><thead><tr><th>Person</th>`;
      columnOrder.forEach(drink => {
        if (prices[drink] !== undefined) {
          html += `<th draggable="true"
                        data-drink="${drink}"
                        class="drink-header">
                     ${drink.replace('_', ' ')}<br>(${prices[drink]}€)
                   </th>`;
        }
      });
      html += `<th>Gesamt (€)</th><th>Reset</th></tr></thead><tbody>`;
      people.forEach(person => {
        const hdClass = hausdienst.current === person ? "hausdienst" : "";
        html += `<tr><th data-person="${person}" class="${hdClass}">${person}</th>`;
        columnOrder.forEach(drink => {
          if (prices[drink] !== undefined) {
            const id = `${person}_${drink}`;
            const val = data[id] || 0;
            html += `<td>
                       <div id="${id}" class="counter">${val}</div>
                       <button class="btn plus">+1</button>
                     </td>`;
          }
        });
        html += `<td id="${person}_Total">0.00</td>
                 <td><button class="btn reset" data-reset-person="${person}">Reset</button></td>
               </tr>`;
      });
      html += `<tr id="addPersonRow" class="add-person-row">
                 <td colspan="${columnOrder.length + 3}">➕ Person hinzufügen</td>
               </tr>`;
      html += `</tbody></table>`;
      document.getElementById("tableContainer").innerHTML = html;
      updateAllTotals();
    }

    // 10. Logik-Funktionen (vereinfacht dargestellt)
    function changeValue(id, delta)   { /* ... wie gehabt ... */ saveAll(); }
    function updateTotal(person)      { /* ... */ }
    function updateAllTotals()        { people.forEach(p => updateTotal(p)); }
    function resetPerson(person)      { /* ... */ saveAll(); buildTable(); }
    function undoLast()               { /* ... */ saveAll(); buildTable(); }
    function openDrinkModal()         { toggleModal("drinkModal", "flex"); }
    function openHausdienstModal()    { toggleModal("hausdienstModal", "flex"); }
    function togglePayPal()           { toggleModal("paypalModal"); }
    function toggleDeleteMode()       { /* ... */ }
    function deletePerson(person)     { /* ... */ saveAll(); buildTable(); }
    function deleteColumn(drink)      { /* ... */ saveAll(); buildTable(); }
    function confirmAddPerson()       { /* ... */ saveAll(); buildTable(); }
    function confirmAddDrink()        { /* ... */ saveAll(); buildTable(); }
    function closeModal(id)           { document.getElementById(id).style.display = "none"; }
    function toggleModal(id, disp)    {
      const m = document.getElementById(id);
      m.style.display = (m.style.display === disp) ? "none" : disp;
    }
    function drag(ev)    { ev.dataTransfer.setData("drink", ev.target.dataset.drink); }
    function allowDrop(ev){ ev.preventDefault(); }
    function drop(ev)    { /* ... reorder ... */ saveAll(); buildTable(); }

    // 11. UI-Events programmatisch binden (Click/Touch)
    function bindUI() {
      // statische Buttons
      document.getElementById("openDrinkBtn").addEventListener("click", openDrinkModal);
      document.getElementById("undoBtn").addEventListener("click", undoLast);
      document.getElementById("paypalBtn").addEventListener("click", togglePayPal);
      document.getElementById("deleteBtn").addEventListener("click", toggleDeleteMode);
      document.getElementById("bookingsBtn").addEventListener("click", () => window.location = 'buchungen.html');
      document.getElementById("openHausdienstBtn").addEventListener("click", openHausdienstModal);

      // Modals
      document.getElementById("paypalModal").addEventListener("click", togglePayPal);
      document.getElementById("hausdienstCloseBtn").addEventListener("click", () => closeModal("hausdienstModal"));
      document.getElementById("hausdienstRankBtn").addEventListener("click", () => window.location = 'hausdienst.html');
      document.getElementById("hausdienstChecklistBtn").addEventListener("click", () => window.location = 'hausdienst_checklist.html');
      document.getElementById("closePersonBtn").addEventListener("click", () => closeModal("personModal"));
      document.getElementById("confirmAddPersonBtn").addEventListener("click", confirmAddPerson);
      document.getElementById("closeDrinkBtn").addEventListener("click", () => closeModal("drinkModal"));
      document.getElementById("confirmAddDrinkBtn").addEventListener("click", confirmAddDrink);

      // dynamische Table-Interaktionen per Delegation
      const tc = document.getElementById("tableContainer");
      tc.addEventListener("click", e => {
        if (e.target.matches(".btn.plus")) {
          const id = e.target.previousElementSibling.id;
          changeValue(id, 1);
        }
        if (e.target.matches("[data-reset-person]")) {
          resetPerson(e.target.dataset.resetPerson);
        }
        if (e.target.matches("th[data-person]")) {
          deletePerson(e.target.dataset.person);
        }
        if (e.target.matches("th[data-drink]")) {
          deleteColumn(e.target.dataset.drink);
