<style>
  /* ✨ Extra Styles für Drag & Drop */
  th.draggable {
    cursor: grab;
    user-select: none;
    background: linear-gradient(to bottom, #1f2230, #1a1d24);
    transition: background 0.2s ease;
  }
  th.draggable:active {
    cursor: grabbing;
    background: #2a2d34;
  }
  .drag-over {
    box-shadow: inset 0 0 10px 2px #00c9a7;
    background-color: rgba(0,201,167,0.2) !important;
  }
</style>

<script>
  let dragSrcIndex = null;

  function makeColumnsDraggable() {
    const headerCells = document.querySelectorAll("thead th");
    headerCells.forEach((th, index) => {
      // Nur Getränkespalten draggable (nicht Person / Gesamt / Reset)
      if (index === 0 || index === headerCells.length - 1 || index === headerCells.length - 2) return;
      th.classList.add("draggable");
      th.setAttribute("draggable", true);

      th.addEventListener("dragstart", (e) => {
        dragSrcIndex = index;
        e.dataTransfer.effectAllowed = "move";
        e.target.style.opacity = "0.4";
      });

      th.addEventListener("dragend", (e) => {
        e.target.style.opacity = "1";
        document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over"));
      });

      th.addEventListener("dragover", (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = "move";
      });

      th.addEventListener("dragenter", (e) => {
        if (index !== dragSrcIndex) th.classList.add("drag-over");
      });

      th.addEventListener("dragleave", () => {
        th.classList.remove("drag-over");
      });

      th.addEventListener("drop", (e) => {
        e.stopPropagation();
        if (dragSrcIndex === null || dragSrcIndex === index) return;
        moveColumn(dragSrcIndex, index);
        dragSrcIndex = null;
        document.querySelectorAll(".drag-over").forEach(el => el.classList.remove("drag-over"));
      });
    });
  }

  function moveColumn(fromIndex, toIndex) {
    const table = document.querySelector("table");
    for (let row of table.rows) {
      const cells = row.cells;
      if (toIndex < fromIndex) {
        row.insertBefore(cells[fromIndex], cells[toIndex]);
      } else {
        row.insertBefore(cells[fromIndex], cells[toIndex].nextSibling);
      }
    }
    saveColumnOrder();
  }

  function saveColumnOrder() {
    const headerCells = document.querySelectorAll("thead th");
    let newOrder = [];
    headerCells.forEach((th, index) => {
      if (index === 0 || th.textContent.includes("Gesamt") || th.textContent.includes("Reset")) return;
      let drinkName = th.textContent.split("(")[0].trim().replace(" ","_");
      newOrder.push(drinkName);
    });
    localStorage.setItem("sick_sound_col_order", JSON.stringify(newOrder));
  }

  function applySavedOrder() {
    const savedOrder = JSON.parse(localStorage.getItem("sick_sound_col_order"));
    if (!savedOrder) return;

    // Preise in neuer Reihenfolge sortieren
    let sorted = {};
    savedOrder.forEach(drink => { if (prices[drink] !== undefined) sorted[drink] = prices[drink]; });
    for (const d in prices) { if (!(d in sorted)) sorted[d] = prices[d]; }
    prices = sorted;
  }

  // baue Tabelle neu
  const oldBuild = buildTable;
  buildTable = function() {
    applySavedOrder();
    oldBuild();
    makeColumnsDraggable();
  };
</script>
