<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Sick & Sound Strichliste</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <!-- Tabelle -->
  <div id="tableContainer" style="flex-grow:1; overflow:auto;"></div>

  <!-- Buttons unten -->
  <div class="footer">
    <button class="btn add" onclick="openDrinkModal()">â• GetrÃ¤nk</button>
    <button class="btn undo" onclick="undoLast()">â†© RÃ¼ckgÃ¤ngig</button>
    <button class="btn paypal" onclick="togglePayPal()">ğŸ’¸ PayPal</button>
    <button id="deleteBtn" class="btn delete" onclick="toggleDeleteMode()">ğŸ—‘ LÃ¶schen</button>
    <button class="btn" style="background:#444; color:#fff;" onclick="window.location='buchungen.html'">ğŸ“– Buchungen</button>
    <button class="btn" style="background:#444; color:#fff;" onclick="openHausdienstModal()">ğŸ  Hausdienst</button>
  </div>

  <!-- Modals -->
  <div id="paypalModal" class="modal" onclick="togglePayPal()">
    <img src="frame.png" alt="PayPal QR">
  </div>
  <div id="hausdienstModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ  Hausdienst</h2>
      <div class="modal-buttons">
        <button class="btn" style="background:#00c9a7; color:#000;" onclick="window.location='hausdienst.html'">ğŸ† Rangliste</button>
        <button class="btn" style="background:#444; color:#fff;" onclick="window.location='hausdienst_checklist.html'">ğŸ“‹ Checkliste</button>
      </div>
      <br>
      <button class="btn reset" onclick="closeModal('hausdienstModal')">Abbrechen</button>
    </div>
  </div>
  <div id="personModal" class="modal">
    <div class="modal-content">
      <h2>â• Neue Person</h2>
      <input id="personName" type="text" placeholder="Name eingeben">
      <div class="modal-buttons">
        <button class="btn add" onclick="confirmAddPerson()">Speichern</button>
        <button class="btn reset" onclick="closeModal('personModal')">Abbrechen</button>
      </div>
    </div>
  </div>
  <div id="drinkModal" class="modal">
    <div class="modal-content">
      <h2>ğŸ¥¤ Neues GetrÃ¤nk</h2>
      <input id="drinkName" type="text" placeholder="Name des GetrÃ¤nks">
      <input id="drinkPrice" type="number" step="0.1" placeholder="Preis (â‚¬)">
      <div class="modal-buttons">
        <button class="btn add" onclick="confirmAddDrink()">Speichern</button>
        <button class="btn reset" onclick="closeModal('drinkModal')">Abbrechen</button>
      </div>
    </div>
  </div>

  <!-- 1) Firebase-Compat-SDKs laden -->
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore-compat.js"></script>

  <!-- 2) Deine App-Logik -->
  <script>
    // **NEU**: Delete-Mode-Flag initialisieren
    let deleteMode = false;

    // Firebase initialisieren
    const firebaseConfig = {
      apiKey: "AIzaSyBFHjGXI5yHyK0DyupS0bnTVAqlu6lvpNw",
      authDomain: "sickandsound-e9704.firebaseapp.com",
      projectId: "sickandsound-e9704",
      storageBucket: "sickandsound-e9704.firebasestorage.app",
      messagingSenderId: "248197359659",
      appId: "1:248197359659:web:a8777cbed3f83d6b1ca26e",
      measurementId: "G-62LH8V7S2E"
    };
    firebase.initializeApp(firebaseConfig);
    firebase.analytics();
    const db = firebase.firestore();

    // Keys & Default-State
    const pricesKey     = "sick_sound_prices",
          peopleKey     = "sick_sound_people",
          dataKey       = "sick_sound_data",
          historyKey    = "sick_sound_history",
          bookingsKey   = "sick_sound_bookings",
          hausdienstKey = "sick_sound_hausdienst",
          orderKey      = "sick_sound_order";

    let prices      = {"Cola_Zero":1.0,"Monster":1.5,"Wasser":0.5,"Kaffee":1.0,"Mittagessen":6.0},
        people      = [],
        data        = {},
        history     = [],
        bookings    = [],
        hausdienst  = {current:null,stats:{}},
        columnOrder = [];

    // State laden (Cloud â†’ Fallback lokal)
    async function loadState() {
      try {
        const snap = await db.collection("state").doc("global").get();
        if (snap.exists) {
          const s = snap.data();
          prices      = s.prices      || prices;
          people      = s.people      || ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
          data        = s.data        || data;
          history     = s.history     || history;
          bookings    = s.bookings    || bookings;
          hausdienst  = s.hausdienst  || hausdienst;
          columnOrder = s.columnOrder || Object.keys(prices);
        } else {
          people      = ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
          columnOrder = Object.keys(prices);
          await saveAll();
        }
      } catch (e) {
        console.warn("Firestore-Laden fehlgeschlagen, nutze localStorage:", e);
        prices      = JSON.parse(localStorage.getItem(pricesKey))     || prices;
        people      = JSON.parse(localStorage.getItem(peopleKey))     || ["Chris","Daniel","Elmi","Florian","Joel","Kevin","Kiste","Marco","Meli","Simon"];
        data        = JSON.parse(localStorage.getItem(dataKey))       || data;
        history     = JSON.parse(localStorage.getItem(historyKey))    || history;
        bookings    = JSON.parse(localStorage.getItem(bookingsKey))   || bookings;
        hausdienst  = JSON.parse(localStorage.getItem(hausdienstKey)) || hausdienst;
        columnOrder = JSON.parse(localStorage.getItem(orderKey))      || Object.keys(prices);
      }
      buildTable();
    }

    // State speichern (lokal + Cloud)
    async function saveAll() {
      // lokal
      localStorage.setItem(pricesKey,     JSON.stringify(prices));
      localStorage.setItem(peopleKey,     JSON.stringify(people));
      localStorage.setItem(dataKey,       JSON.stringify(data));
      localStorage.setItem(historyKey,    JSON.stringify(history));
      localStorage.setItem(bookingsKey,   JSON.stringify(bookings));
      localStorage.setItem(hausdienstKey, JSON.stringify(hausdienst));
      localStorage.setItem(orderKey,      JSON.stringify(columnOrder));
      // Cloud
      try {
        await db.collection("state").doc("global").set({
          prices, people, data, history, bookings, hausdienst, columnOrder
        }, { merge: true });
      } catch (e) {
        console.error("Firestore-Speichern fehlgeschlagen:", e);
      }
    }

    // Echtzeit-Updates abonnieren
    db.collection("state").doc("global")
      .onSnapshot(snap => {
        if (!snap.exists) return;
        const s = snap.data();
        prices      = s.prices      || prices;
        people      = s.people      || people;
        data        = s.data        || data;
        history     = s.history     || history;
        bookings    = s.bookings    || bookings;
        hausdienst  = s.hausdienst  || hausdienst;
        columnOrder = s.columnOrder || columnOrder;
        buildTable();
      });

    // UI-Funktionen
    function buildTable() {
      people.sort();
      let html = `<table id="mainTable"><thead><tr><th>Person</th>`;
      columnOrder.forEach(drink => {
        if (prices[drink] !== undefined) {
          html += `<th draggable="true" ondragstart="drag(event)" ondragover="allowDrop(event)" ondrop="drop(event)" data-drink="${drink}" onclick="deleteColumn('${drink}')">${drink.replace('_',' ')}<br>(${prices[drink]}â‚¬)</th>`;
        }
      });
      html += `<th>Gesamt (â‚¬)</th><th>Reset</th></tr></thead><tbody>`;
      people.forEach(person => {
        const mark = hausdienst.current===person ? "hausdienst" : "";
        html += `<tr><th class="${mark}" onclick="deletePerson('${person}')">${person}</th>`;
        columnOrder.forEach(drink => {
          if (prices[drink] !== undefined) {
            const id = `${person}_${drink}`, val = data[id]||0;
            html += `<td><div id="${id}" class="counter">${val}</div><button class="btn plus" onclick="changeValue('${id}',1)">+1</button></td>`;
          }
        });
        html += `<td id="${person}_Total">0.00</td>`;
        html += `<td><button class="btn reset" onclick="resetPerson('${person}')">Reset</button></td></tr>`;
      });
      html += `<tr class="add-person-row"><td colspan="${columnOrder.length+3}" onclick="openPersonModal()">â• Person hinzufÃ¼gen</td></tr>`;
      html += `</tbody></table>`;
      document.getElementById("tableContainer").innerHTML = html;
      updateAllTotals();
    }

    function drag(ev){ ev.dataTransfer.setData("drink", ev.target.dataset.drink); }
    function allowDrop(ev){ ev.preventDefault(); }
    function drop(ev){
      ev.preventDefault();
      const from = ev.dataTransfer.getData("drink"),
            to   = ev.target.dataset.drink;
      if (from && to && from !== to) {
        columnOrder.splice(columnOrder.indexOf(from),1);
        columnOrder.splice(columnOrder.indexOf(to),0,from);
        saveAll(); buildTable();
      }
    }
    function changeValue(id,delta){ const el=document.getElementById(id), cur=parseInt(el.textContent||'0'), nxt=Math.max(0,cur+delta);
      history.push({id,prev:cur,action:"change"}); data[id]=nxt; el.textContent=nxt; updateTotal(id.split('_')[0]); saveAll();
    }
    function updateTotal(person){ let tot=0; columnOrder.forEach(d=>tot+=(data[`${person}_${d}`]||0)*prices[d]); document.getElementById(`${person}_Total`).textContent=tot.toFixed(2); }
    function updateAllTotals(){ people.forEach(p=>updateTotal(p)); }

    function resetPerson(person){
      if(!confirm(`Alle Striche von ${person} zurÃ¼cksetzen?`))return;
      const sum=parseFloat(document.getElementById(`${person}_Total`).textContent);
      history.push({person,sum,action:"reset"}); bookings.push({date:new Date().toLocaleDateString("de-DE"),person,sum});
      Object.keys(prices).forEach(d=>data[`${person}_${d}`]=0);
      document.getElementById(`${person}_Total`).textContent="0.00"; saveAll(); buildTable();
    }
    function undoLast(){ const last=history.pop(); if(!last)return;
      if(last.action==="change") data[last.id]=last.prev;
      else if(last.action==="reset") bookings=bookings.filter(b=>!(b.person===last.person&&b.sum===last.sum));
      saveAll(); buildTable();
    }

    function openPersonModal(){ toggleModal("personModal","flex"); }
    function openDrinkModal() { toggleModal("drinkModal","flex"); }
    function openHausdienstModal() { toggleModal("hausdienstModal","flex"); }
    function togglePayPal() { toggleModal("paypalModal"); }

    function toggleDeleteMode(){
      deleteMode = !deleteMode;
      const btn = document.getElementById("deleteBtn");
      if (deleteMode) {
        btn.classList.add("delete-active");
        alert("ğŸ—‘ LÃ¶schmodus aktiviert.");
      } else {
        btn.classList.remove("delete-active");
      }
    }

    function deletePerson(person){
      if (!deleteMode) return;
      if (confirm(`${person} wirklich lÃ¶schen?`)) {
        people = people.filter(p=>p!==person);
        saveAll();
      }
      deleteMode = false;
      document.getElementById("deleteBtn").classList.remove("delete-active");
      buildTable();
    }

    function deleteColumn(drink){
      if (!deleteMode) return;
      if (confirm(`GetrÃ¤nk "${drink}" wirklich lÃ¶schen?`)) {
        delete prices[drink];
        columnOrder = columnOrder.filter(d=>d!==drink);
        saveAll();
      }
      deleteMode = false;
      document.getElementById("deleteBtn").classList.remove("delete-active");
      buildTable();
    }

    function confirmAddPerson(){
      const name = document.getElementById("personName").value.trim();
      if (!name) return alert("Bitte Name eingeben!");
      if (people.includes(name)) return alert("Person existiert bereits!");
      people.push(name); saveAll(); buildTable(); closeModal("personModal");
      document.getElementById("personName").value = "";
    }

    function confirmAddDrink(){
      const name  = document.getElementById("drinkName").value.trim();
      const price = parseFloat(document.getElementById("drinkPrice").value);
      if (!name || isNaN(price) || price <= 0) return alert("Bitte gÃ¼ltige Eingaben machen!");
      const key = name.replace(/\s+/g, "_");
      prices[key] = price;
      if (!columnOrder.includes(key)) columnOrder.push(key);
      saveAll(); buildTable(); closeModal("drinkModal");
      document.getElementById("drinkName").value = "";
      document.getElementById("drinkPrice").value = "";
    }

    function closeModal(id){ document.getElementById(id).style.display = "none"; }
    function toggleModal(id, display="flex"){
      const m = document.getElementById(id);
      m.style.display = (m.style.display === display) ? "none" : display;
    }

    // App starten
    window.onload = loadState;
  </script>
</body>
</html>
